import{S as Zn,C as Be,A as Zt,D as at,a as Qn,V as v,M as lt,T as rt,Q as Tt,b as yi,c as q,R as cs,P as me,d as wn,O as Ee,e as ai,W as xi,f as bi,G as De,E as Jn,B as At,L as ns,g as _t,h as er,i as tr,j as sr,k as Le,l as Qt,m as H,n as k,o as D,p as We,q as ir,r as nr,s as Vs,t as Pn,u as rr,v as St,F as Tn,w as xe,x as Ae,y as Mt,z as or,H as ar,I as ee,J as lr,K as cr,N as An,U as ur,X as hr,Y as Ye,Z as fr,_ as _n,$ as dr,a0 as mr,a1 as pr,a2 as Ys,a3 as Mn,a4 as Ks,a5 as gr,a6 as yr,a7 as xr,a8 as ys,a9 as br,aa as O,ab as Sr,ac as wr,ad as Pr,ae as Tr,af as Ar,ag as _r,ah as Mr,ai as Cr,aj as vr,ak as Cn,al as Er,am as Si,an as wi,ao as Pi,ap as Ti,aq as Ai,ar as Xs,as as zr,at as he,au as Rr,av as ce,aw as ie,ax as Lr,ay as vn,az as Xe,aA as Ir,aB as ne,aC as vt,aD as _i}from"./three-Dv_FNodR.js";(function(){const e=document.createElement("link").relList;if(e&&e.supports&&e.supports("modulepreload"))return;for(const i of document.querySelectorAll('link[rel="modulepreload"]'))s(i);new MutationObserver(i=>{for(const n of i)if(n.type==="childList")for(const r of n.addedNodes)r.tagName==="LINK"&&r.rel==="modulepreload"&&s(r)}).observe(document,{childList:!0,subtree:!0});function t(i){const n={};return i.integrity&&(n.integrity=i.integrity),i.referrerPolicy&&(n.referrerPolicy=i.referrerPolicy),i.crossOrigin==="use-credentials"?n.credentials="include":i.crossOrigin==="anonymous"?n.credentials="omit":n.credentials="same-origin",n}function s(i){if(i.ep)return;i.ep=!0;const n=t(i);fetch(i.href,n)}})();class ut{constructor(){this.scene=new Zn,this.scene.background=new Be(1710618),this.setupLighting()}setupLighting(){const e=new Zt(16777215,.6);this.scene.add(e);const t=new at(16777215,.8);t.position.set(5,10,7),this.scene.add(t);const s=new at(16777215,.3);s.position.set(-5,5,-7),this.scene.add(s)}add(e){this.scene.add(e)}remove(e){this.scene.remove(e)}getScene(){return this.scene}}const Mi={type:"change"},li={type:"start"},En={type:"end"},Et=new cs,Ci=new me,Or=Math.cos(70*wn.DEG2RAD),V=new v,se=2*Math.PI,N={NONE:-1,ROTATE:0,DOLLY:1,PAN:2,TOUCH_ROTATE:3,TOUCH_PAN:4,TOUCH_DOLLY_PAN:5,TOUCH_DOLLY_ROTATE:6},xs=1e-6;class Dr extends Qn{constructor(e,t=null){super(e,t),this.state=N.NONE,this.target=new v,this.cursor=new v,this.minDistance=0,this.maxDistance=1/0,this.minZoom=0,this.maxZoom=1/0,this.minTargetRadius=0,this.maxTargetRadius=1/0,this.minPolarAngle=0,this.maxPolarAngle=Math.PI,this.minAzimuthAngle=-1/0,this.maxAzimuthAngle=1/0,this.enableDamping=!1,this.dampingFactor=.05,this.enableZoom=!0,this.zoomSpeed=1,this.enableRotate=!0,this.rotateSpeed=1,this.keyRotateSpeed=1,this.enablePan=!0,this.panSpeed=1,this.screenSpacePanning=!0,this.keyPanSpeed=7,this.zoomToCursor=!1,this.autoRotate=!1,this.autoRotateSpeed=2,this.keys={LEFT:"ArrowLeft",UP:"ArrowUp",RIGHT:"ArrowRight",BOTTOM:"ArrowDown"},this.mouseButtons={LEFT:lt.ROTATE,MIDDLE:lt.DOLLY,RIGHT:lt.PAN},this.touches={ONE:rt.ROTATE,TWO:rt.DOLLY_PAN},this.target0=this.target.clone(),this.position0=this.object.position.clone(),this.zoom0=this.object.zoom,this._domElementKeyEvents=null,this._lastPosition=new v,this._lastQuaternion=new Tt,this._lastTargetPosition=new v,this._quat=new Tt().setFromUnitVectors(e.up,new v(0,1,0)),this._quatInverse=this._quat.clone().invert(),this._spherical=new yi,this._sphericalDelta=new yi,this._scale=1,this._panOffset=new v,this._rotateStart=new q,this._rotateEnd=new q,this._rotateDelta=new q,this._panStart=new q,this._panEnd=new q,this._panDelta=new q,this._dollyStart=new q,this._dollyEnd=new q,this._dollyDelta=new q,this._dollyDirection=new v,this._mouse=new q,this._performCursorZoom=!1,this._pointers=[],this._pointerPositions={},this._controlActive=!1,this._onPointerMove=Nr.bind(this),this._onPointerDown=Br.bind(this),this._onPointerUp=Hr.bind(this),this._onContextMenu=Vr.bind(this),this._onMouseWheel=qr.bind(this),this._onKeyDown=Ur.bind(this),this._onTouchStart=Gr.bind(this),this._onTouchMove=jr.bind(this),this._onMouseDown=Fr.bind(this),this._onMouseMove=kr.bind(this),this._interceptControlDown=Yr.bind(this),this._interceptControlUp=Kr.bind(this),this.domElement!==null&&this.connect(this.domElement),this.update()}connect(e){super.connect(e),this.domElement.addEventListener("pointerdown",this._onPointerDown),this.domElement.addEventListener("pointercancel",this._onPointerUp),this.domElement.addEventListener("contextmenu",this._onContextMenu),this.domElement.addEventListener("wheel",this._onMouseWheel,{passive:!1}),this.domElement.getRootNode().addEventListener("keydown",this._interceptControlDown,{passive:!0,capture:!0}),this.domElement.style.touchAction="none"}disconnect(){this.domElement.removeEventListener("pointerdown",this._onPointerDown),this.domElement.ownerDocument.removeEventListener("pointermove",this._onPointerMove),this.domElement.ownerDocument.removeEventListener("pointerup",this._onPointerUp),this.domElement.removeEventListener("pointercancel",this._onPointerUp),this.domElement.removeEventListener("wheel",this._onMouseWheel),this.domElement.removeEventListener("contextmenu",this._onContextMenu),this.stopListenToKeyEvents(),this.domElement.getRootNode().removeEventListener("keydown",this._interceptControlDown,{capture:!0}),this.domElement.style.touchAction="auto"}dispose(){this.disconnect()}getPolarAngle(){return this._spherical.phi}getAzimuthalAngle(){return this._spherical.theta}getDistance(){return this.object.position.distanceTo(this.target)}listenToKeyEvents(e){e.addEventListener("keydown",this._onKeyDown),this._domElementKeyEvents=e}stopListenToKeyEvents(){this._domElementKeyEvents!==null&&(this._domElementKeyEvents.removeEventListener("keydown",this._onKeyDown),this._domElementKeyEvents=null)}saveState(){this.target0.copy(this.target),this.position0.copy(this.object.position),this.zoom0=this.object.zoom}reset(){this.target.copy(this.target0),this.object.position.copy(this.position0),this.object.zoom=this.zoom0,this.object.updateProjectionMatrix(),this.dispatchEvent(Mi),this.update(),this.state=N.NONE}update(e=null){const t=this.object.position;V.copy(t).sub(this.target),V.applyQuaternion(this._quat),this._spherical.setFromVector3(V),this.autoRotate&&this.state===N.NONE&&this._rotateLeft(this._getAutoRotationAngle(e)),this.enableDamping?(this._spherical.theta+=this._sphericalDelta.theta*this.dampingFactor,this._spherical.phi+=this._sphericalDelta.phi*this.dampingFactor):(this._spherical.theta+=this._sphericalDelta.theta,this._spherical.phi+=this._sphericalDelta.phi);let s=this.minAzimuthAngle,i=this.maxAzimuthAngle;isFinite(s)&&isFinite(i)&&(s<-Math.PI?s+=se:s>Math.PI&&(s-=se),i<-Math.PI?i+=se:i>Math.PI&&(i-=se),s<=i?this._spherical.theta=Math.max(s,Math.min(i,this._spherical.theta)):this._spherical.theta=this._spherical.theta>(s+i)/2?Math.max(s,this._spherical.theta):Math.min(i,this._spherical.theta)),this._spherical.phi=Math.max(this.minPolarAngle,Math.min(this.maxPolarAngle,this._spherical.phi)),this._spherical.makeSafe(),this.enableDamping===!0?this.target.addScaledVector(this._panOffset,this.dampingFactor):this.target.add(this._panOffset),this.target.sub(this.cursor),this.target.clampLength(this.minTargetRadius,this.maxTargetRadius),this.target.add(this.cursor);let n=!1;if(this.zoomToCursor&&this._performCursorZoom||this.object.isOrthographicCamera)this._spherical.radius=this._clampDistance(this._spherical.radius);else{const r=this._spherical.radius;this._spherical.radius=this._clampDistance(this._spherical.radius*this._scale),n=r!=this._spherical.radius}if(V.setFromSpherical(this._spherical),V.applyQuaternion(this._quatInverse),t.copy(this.target).add(V),this.object.lookAt(this.target),this.enableDamping===!0?(this._sphericalDelta.theta*=1-this.dampingFactor,this._sphericalDelta.phi*=1-this.dampingFactor,this._panOffset.multiplyScalar(1-this.dampingFactor)):(this._sphericalDelta.set(0,0,0),this._panOffset.set(0,0,0)),this.zoomToCursor&&this._performCursorZoom){let r=null;if(this.object.isPerspectiveCamera){const l=V.length();r=this._clampDistance(l*this._scale);const o=l-r;this.object.position.addScaledVector(this._dollyDirection,o),this.object.updateMatrixWorld(),n=!!o}else if(this.object.isOrthographicCamera){const l=new v(this._mouse.x,this._mouse.y,0);l.unproject(this.object);const o=this.object.zoom;this.object.zoom=Math.max(this.minZoom,Math.min(this.maxZoom,this.object.zoom/this._scale)),this.object.updateProjectionMatrix(),n=o!==this.object.zoom;const c=new v(this._mouse.x,this._mouse.y,0);c.unproject(this.object),this.object.position.sub(c).add(l),this.object.updateMatrixWorld(),r=V.length()}else console.warn("WARNING: OrbitControls.js encountered an unknown camera type - zoom to cursor disabled."),this.zoomToCursor=!1;r!==null&&(this.screenSpacePanning?this.target.set(0,0,-1).transformDirection(this.object.matrix).multiplyScalar(r).add(this.object.position):(Et.origin.copy(this.object.position),Et.direction.set(0,0,-1).transformDirection(this.object.matrix),Math.abs(this.object.up.dot(Et.direction))<Or?this.object.lookAt(this.target):(Ci.setFromNormalAndCoplanarPoint(this.object.up,this.target),Et.intersectPlane(Ci,this.target))))}else if(this.object.isOrthographicCamera){const r=this.object.zoom;this.object.zoom=Math.max(this.minZoom,Math.min(this.maxZoom,this.object.zoom/this._scale)),r!==this.object.zoom&&(this.object.updateProjectionMatrix(),n=!0)}return this._scale=1,this._performCursorZoom=!1,n||this._lastPosition.distanceToSquared(this.object.position)>xs||8*(1-this._lastQuaternion.dot(this.object.quaternion))>xs||this._lastTargetPosition.distanceToSquared(this.target)>xs?(this.dispatchEvent(Mi),this._lastPosition.copy(this.object.position),this._lastQuaternion.copy(this.object.quaternion),this._lastTargetPosition.copy(this.target),!0):!1}_getAutoRotationAngle(e){return e!==null?se/60*this.autoRotateSpeed*e:se/60/60*this.autoRotateSpeed}_getZoomScale(e){const t=Math.abs(e*.01);return Math.pow(.95,this.zoomSpeed*t)}_rotateLeft(e){this._sphericalDelta.theta-=e}_rotateUp(e){this._sphericalDelta.phi-=e}_panLeft(e,t){V.setFromMatrixColumn(t,0),V.multiplyScalar(-e),this._panOffset.add(V)}_panUp(e,t){this.screenSpacePanning===!0?V.setFromMatrixColumn(t,1):(V.setFromMatrixColumn(t,0),V.crossVectors(this.object.up,V)),V.multiplyScalar(e),this._panOffset.add(V)}_pan(e,t){const s=this.domElement;if(this.object.isPerspectiveCamera){const i=this.object.position;V.copy(i).sub(this.target);let n=V.length();n*=Math.tan(this.object.fov/2*Math.PI/180),this._panLeft(2*e*n/s.clientHeight,this.object.matrix),this._panUp(2*t*n/s.clientHeight,this.object.matrix)}else this.object.isOrthographicCamera?(this._panLeft(e*(this.object.right-this.object.left)/this.object.zoom/s.clientWidth,this.object.matrix),this._panUp(t*(this.object.top-this.object.bottom)/this.object.zoom/s.clientHeight,this.object.matrix)):(console.warn("WARNING: OrbitControls.js encountered an unknown camera type - pan disabled."),this.enablePan=!1)}_dollyOut(e){this.object.isPerspectiveCamera||this.object.isOrthographicCamera?this._scale/=e:(console.warn("WARNING: OrbitControls.js encountered an unknown camera type - dolly/zoom disabled."),this.enableZoom=!1)}_dollyIn(e){this.object.isPerspectiveCamera||this.object.isOrthographicCamera?this._scale*=e:(console.warn("WARNING: OrbitControls.js encountered an unknown camera type - dolly/zoom disabled."),this.enableZoom=!1)}_updateZoomParameters(e,t){if(!this.zoomToCursor)return;this._performCursorZoom=!0;const s=this.domElement.getBoundingClientRect(),i=e-s.left,n=t-s.top,r=s.width,l=s.height;this._mouse.x=i/r*2-1,this._mouse.y=-(n/l)*2+1,this._dollyDirection.set(this._mouse.x,this._mouse.y,1).unproject(this.object).sub(this.object.position).normalize()}_clampDistance(e){return Math.max(this.minDistance,Math.min(this.maxDistance,e))}_handleMouseDownRotate(e){this._rotateStart.set(e.clientX,e.clientY)}_handleMouseDownDolly(e){this._updateZoomParameters(e.clientX,e.clientX),this._dollyStart.set(e.clientX,e.clientY)}_handleMouseDownPan(e){this._panStart.set(e.clientX,e.clientY)}_handleMouseMoveRotate(e){this._rotateEnd.set(e.clientX,e.clientY),this._rotateDelta.subVectors(this._rotateEnd,this._rotateStart).multiplyScalar(this.rotateSpeed);const t=this.domElement;this._rotateLeft(se*this._rotateDelta.x/t.clientHeight),this._rotateUp(se*this._rotateDelta.y/t.clientHeight),this._rotateStart.copy(this._rotateEnd),this.update()}_handleMouseMoveDolly(e){this._dollyEnd.set(e.clientX,e.clientY),this._dollyDelta.subVectors(this._dollyEnd,this._dollyStart),this._dollyDelta.y>0?this._dollyOut(this._getZoomScale(this._dollyDelta.y)):this._dollyDelta.y<0&&this._dollyIn(this._getZoomScale(this._dollyDelta.y)),this._dollyStart.copy(this._dollyEnd),this.update()}_handleMouseMovePan(e){this._panEnd.set(e.clientX,e.clientY),this._panDelta.subVectors(this._panEnd,this._panStart).multiplyScalar(this.panSpeed),this._pan(this._panDelta.x,this._panDelta.y),this._panStart.copy(this._panEnd),this.update()}_handleMouseWheel(e){this._updateZoomParameters(e.clientX,e.clientY),e.deltaY<0?this._dollyIn(this._getZoomScale(e.deltaY)):e.deltaY>0&&this._dollyOut(this._getZoomScale(e.deltaY)),this.update()}_handleKeyDown(e){let t=!1;switch(e.code){case this.keys.UP:e.ctrlKey||e.metaKey||e.shiftKey?this.enableRotate&&this._rotateUp(se*this.keyRotateSpeed/this.domElement.clientHeight):this.enablePan&&this._pan(0,this.keyPanSpeed),t=!0;break;case this.keys.BOTTOM:e.ctrlKey||e.metaKey||e.shiftKey?this.enableRotate&&this._rotateUp(-se*this.keyRotateSpeed/this.domElement.clientHeight):this.enablePan&&this._pan(0,-this.keyPanSpeed),t=!0;break;case this.keys.LEFT:e.ctrlKey||e.metaKey||e.shiftKey?this.enableRotate&&this._rotateLeft(se*this.keyRotateSpeed/this.domElement.clientHeight):this.enablePan&&this._pan(this.keyPanSpeed,0),t=!0;break;case this.keys.RIGHT:e.ctrlKey||e.metaKey||e.shiftKey?this.enableRotate&&this._rotateLeft(-se*this.keyRotateSpeed/this.domElement.clientHeight):this.enablePan&&this._pan(-this.keyPanSpeed,0),t=!0;break}t&&(e.preventDefault(),this.update())}_handleTouchStartRotate(e){if(this._pointers.length===1)this._rotateStart.set(e.pageX,e.pageY);else{const t=this._getSecondPointerPosition(e),s=.5*(e.pageX+t.x),i=.5*(e.pageY+t.y);this._rotateStart.set(s,i)}}_handleTouchStartPan(e){if(this._pointers.length===1)this._panStart.set(e.pageX,e.pageY);else{const t=this._getSecondPointerPosition(e),s=.5*(e.pageX+t.x),i=.5*(e.pageY+t.y);this._panStart.set(s,i)}}_handleTouchStartDolly(e){const t=this._getSecondPointerPosition(e),s=e.pageX-t.x,i=e.pageY-t.y,n=Math.sqrt(s*s+i*i);this._dollyStart.set(0,n)}_handleTouchStartDollyPan(e){this.enableZoom&&this._handleTouchStartDolly(e),this.enablePan&&this._handleTouchStartPan(e)}_handleTouchStartDollyRotate(e){this.enableZoom&&this._handleTouchStartDolly(e),this.enableRotate&&this._handleTouchStartRotate(e)}_handleTouchMoveRotate(e){if(this._pointers.length==1)this._rotateEnd.set(e.pageX,e.pageY);else{const s=this._getSecondPointerPosition(e),i=.5*(e.pageX+s.x),n=.5*(e.pageY+s.y);this._rotateEnd.set(i,n)}this._rotateDelta.subVectors(this._rotateEnd,this._rotateStart).multiplyScalar(this.rotateSpeed);const t=this.domElement;this._rotateLeft(se*this._rotateDelta.x/t.clientHeight),this._rotateUp(se*this._rotateDelta.y/t.clientHeight),this._rotateStart.copy(this._rotateEnd)}_handleTouchMovePan(e){if(this._pointers.length===1)this._panEnd.set(e.pageX,e.pageY);else{const t=this._getSecondPointerPosition(e),s=.5*(e.pageX+t.x),i=.5*(e.pageY+t.y);this._panEnd.set(s,i)}this._panDelta.subVectors(this._panEnd,this._panStart).multiplyScalar(this.panSpeed),this._pan(this._panDelta.x,this._panDelta.y),this._panStart.copy(this._panEnd)}_handleTouchMoveDolly(e){const t=this._getSecondPointerPosition(e),s=e.pageX-t.x,i=e.pageY-t.y,n=Math.sqrt(s*s+i*i);this._dollyEnd.set(0,n),this._dollyDelta.set(0,Math.pow(this._dollyEnd.y/this._dollyStart.y,this.zoomSpeed)),this._dollyOut(this._dollyDelta.y),this._dollyStart.copy(this._dollyEnd);const r=(e.pageX+t.x)*.5,l=(e.pageY+t.y)*.5;this._updateZoomParameters(r,l)}_handleTouchMoveDollyPan(e){this.enableZoom&&this._handleTouchMoveDolly(e),this.enablePan&&this._handleTouchMovePan(e)}_handleTouchMoveDollyRotate(e){this.enableZoom&&this._handleTouchMoveDolly(e),this.enableRotate&&this._handleTouchMoveRotate(e)}_addPointer(e){this._pointers.push(e.pointerId)}_removePointer(e){delete this._pointerPositions[e.pointerId];for(let t=0;t<this._pointers.length;t++)if(this._pointers[t]==e.pointerId){this._pointers.splice(t,1);return}}_isTrackingPointer(e){for(let t=0;t<this._pointers.length;t++)if(this._pointers[t]==e.pointerId)return!0;return!1}_trackPointer(e){let t=this._pointerPositions[e.pointerId];t===void 0&&(t=new q,this._pointerPositions[e.pointerId]=t),t.set(e.pageX,e.pageY)}_getSecondPointerPosition(e){const t=e.pointerId===this._pointers[0]?this._pointers[1]:this._pointers[0];return this._pointerPositions[t]}_customWheelEvent(e){const t=e.deltaMode,s={clientX:e.clientX,clientY:e.clientY,deltaY:e.deltaY};switch(t){case 1:s.deltaY*=16;break;case 2:s.deltaY*=100;break}return e.ctrlKey&&!this._controlActive&&(s.deltaY*=10),s}}function Br(a){this.enabled!==!1&&(this._pointers.length===0&&(this.domElement.setPointerCapture(a.pointerId),this.domElement.ownerDocument.addEventListener("pointermove",this._onPointerMove),this.domElement.ownerDocument.addEventListener("pointerup",this._onPointerUp)),!this._isTrackingPointer(a)&&(this._addPointer(a),a.pointerType==="touch"?this._onTouchStart(a):this._onMouseDown(a)))}function Nr(a){this.enabled!==!1&&(a.pointerType==="touch"?this._onTouchMove(a):this._onMouseMove(a))}function Hr(a){switch(this._removePointer(a),this._pointers.length){case 0:this.domElement.releasePointerCapture(a.pointerId),this.domElement.ownerDocument.removeEventListener("pointermove",this._onPointerMove),this.domElement.ownerDocument.removeEventListener("pointerup",this._onPointerUp),this.dispatchEvent(En),this.state=N.NONE;break;case 1:const e=this._pointers[0],t=this._pointerPositions[e];this._onTouchStart({pointerId:e,pageX:t.x,pageY:t.y});break}}function Fr(a){let e;switch(a.button){case 0:e=this.mouseButtons.LEFT;break;case 1:e=this.mouseButtons.MIDDLE;break;case 2:e=this.mouseButtons.RIGHT;break;default:e=-1}switch(e){case lt.DOLLY:if(this.enableZoom===!1)return;this._handleMouseDownDolly(a),this.state=N.DOLLY;break;case lt.ROTATE:if(a.ctrlKey||a.metaKey||a.shiftKey){if(this.enablePan===!1)return;this._handleMouseDownPan(a),this.state=N.PAN}else{if(this.enableRotate===!1)return;this._handleMouseDownRotate(a),this.state=N.ROTATE}break;case lt.PAN:if(a.ctrlKey||a.metaKey||a.shiftKey){if(this.enableRotate===!1)return;this._handleMouseDownRotate(a),this.state=N.ROTATE}else{if(this.enablePan===!1)return;this._handleMouseDownPan(a),this.state=N.PAN}break;default:this.state=N.NONE}this.state!==N.NONE&&this.dispatchEvent(li)}function kr(a){switch(this.state){case N.ROTATE:if(this.enableRotate===!1)return;this._handleMouseMoveRotate(a);break;case N.DOLLY:if(this.enableZoom===!1)return;this._handleMouseMoveDolly(a);break;case N.PAN:if(this.enablePan===!1)return;this._handleMouseMovePan(a);break}}function qr(a){this.enabled===!1||this.enableZoom===!1||this.state!==N.NONE||(a.preventDefault(),this.dispatchEvent(li),this._handleMouseWheel(this._customWheelEvent(a)),this.dispatchEvent(En))}function Ur(a){this.enabled!==!1&&this._handleKeyDown(a)}function Gr(a){switch(this._trackPointer(a),this._pointers.length){case 1:switch(this.touches.ONE){case rt.ROTATE:if(this.enableRotate===!1)return;this._handleTouchStartRotate(a),this.state=N.TOUCH_ROTATE;break;case rt.PAN:if(this.enablePan===!1)return;this._handleTouchStartPan(a),this.state=N.TOUCH_PAN;break;default:this.state=N.NONE}break;case 2:switch(this.touches.TWO){case rt.DOLLY_PAN:if(this.enableZoom===!1&&this.enablePan===!1)return;this._handleTouchStartDollyPan(a),this.state=N.TOUCH_DOLLY_PAN;break;case rt.DOLLY_ROTATE:if(this.enableZoom===!1&&this.enableRotate===!1)return;this._handleTouchStartDollyRotate(a),this.state=N.TOUCH_DOLLY_ROTATE;break;default:this.state=N.NONE}break;default:this.state=N.NONE}this.state!==N.NONE&&this.dispatchEvent(li)}function jr(a){switch(this._trackPointer(a),this.state){case N.TOUCH_ROTATE:if(this.enableRotate===!1)return;this._handleTouchMoveRotate(a),this.update();break;case N.TOUCH_PAN:if(this.enablePan===!1)return;this._handleTouchMovePan(a),this.update();break;case N.TOUCH_DOLLY_PAN:if(this.enableZoom===!1&&this.enablePan===!1)return;this._handleTouchMoveDollyPan(a),this.update();break;case N.TOUCH_DOLLY_ROTATE:if(this.enableZoom===!1&&this.enableRotate===!1)return;this._handleTouchMoveDollyRotate(a),this.update();break;default:this.state=N.NONE}}function Vr(a){this.enabled!==!1&&a.preventDefault()}function Yr(a){a.key==="Control"&&(this._controlActive=!0,this.domElement.getRootNode().addEventListener("keyup",this._interceptControlUp,{passive:!0,capture:!0}))}function Kr(a){a.key==="Control"&&(this._controlActive=!1,this.domElement.getRootNode().removeEventListener("keyup",this._interceptControlUp,{passive:!0,capture:!0}))}class Xr{constructor(e,t={}){const s=t.type||"perspective";if(this.aspect=t.aspect||1.6,s==="orthographic"){const i=t.frustumSize||10;this.camera=new Ee(i*this.aspect/-2,i*this.aspect/2,i/2,i/-2,.1,1e3),this.isOrthographic=!0,this.frustumSize=i}else this.camera=new ai(75,aspect,.1,1e3),this.isOrthographic=!1;this.camera.position.set(5,5,5),this.camera.lookAt(0,.8,0),this.controls=new Dr(this.camera,e.domElement),this.controls.enableDamping=!0,this.controls.dampingFactor=.05,this.controls.minDistance=2,this.controls.maxDistance=50,this.controls.minPolarAngle=0,this.controls.maxPolarAngle=Math.PI,this.controls.minAzimuthAngle=-1/0,this.controls.maxAzimuthAngle=1/0,this.controls.enablePan=!1}update(){this.controls.update()}handleResize(){this.isOrthographic?(this.camera.left=this.frustumSize*this.aspect/-2,this.camera.right=this.frustumSize*this.aspect/2,this.camera.top=this.frustumSize/2,this.camera.bottom=this.frustumSize/-2):this.camera.aspect=this.aspect,this.camera.updateProjectionMatrix()}getCamera(){return this.camera}getControls(){return this.controls}}class $r{constructor(){this.previewRenderer=new xi({antialias:!0,alpha:!0}),this.previewRenderer.setPixelRatio(window.devicePixelRatio),this.previewRenderer.shadowMap.enabled=!0,this.previewRenderer.shadowMap.type=bi,this.previewRenderer.localClippingEnabled=!1,this.previewRenderer.clippingPlanes=[],this.workRenderer=new xi({antialias:!0,alpha:!0}),this.workRenderer.setPixelRatio(window.devicePixelRatio),this.workRenderer.shadowMap.enabled=!0,this.workRenderer.shadowMap.type=bi;const e=document.getElementById("preview-viewport"),t=document.getElementById("work-viewport");e&&t&&(e.appendChild(this.previewRenderer.domElement),t.appendChild(this.workRenderer.domElement)),this.handleResize(),window.addEventListener("resize",()=>this.handleResize())}handleResize(){const e=window.innerHeight*.7,t=window.innerHeight*.3,s=e*1.6,i=t*1.6;this.previewRenderer.setSize(s,e),this.workRenderer.setSize(i,t)}render(e,t,s,i,n,r,l,o,c,u,h,f,d,x,w,S){const y=window.innerHeight*.7,p=y*1.6,m=Math.floor(p/2),g=Math.floor(y/3);if(this.previewRenderer.setScissorTest(!0),this.previewRenderer.clippingPlanes=[],this.previewRenderer.setViewport(0,0,m,y),this.previewRenderer.setScissor(0,0,m,y),this.previewRenderer.render(e,t),this.previewRenderer.clippingPlanes=r||[],this.previewRenderer.setViewport(m,g*2,m,g),this.previewRenderer.setScissor(m,g*2,m,g),this.previewRenderer.render(e,s),h&&f){const b=Math.min(g,m)*.55,T=m+15,P=g*2+g-b-15;this.previewRenderer.clippingPlanes=[],this.previewRenderer.setViewport(T,P,b,b),this.previewRenderer.setScissor(T,P,b,b),this.previewRenderer.render(h,f),this.updateSummaryBorder(T,P,b,"summary-gizmo-border")}if(this.previewRenderer.clippingPlanes=l||[],this.previewRenderer.setViewport(m,g,m,g),this.previewRenderer.setScissor(m,g,m,g),this.previewRenderer.render(e,i),d&&x){const b=Math.min(g,m)*.55,T=m+15,P=g+g-b-15;this.previewRenderer.clippingPlanes=[],this.previewRenderer.setViewport(T,P,b,b),this.previewRenderer.setScissor(T,P,b,b),this.previewRenderer.render(d,x),this.updateSummaryBorder(T,P,b,"coronal-summary-gizmo-border")}if(this.previewRenderer.clippingPlanes=o||[],this.previewRenderer.setViewport(m,0,m,g),this.previewRenderer.setScissor(m,0,m,g),this.previewRenderer.render(e,n),w&&S){const b=Math.min(g,m)*.55,T=m+15,P=g-b-15;this.previewRenderer.clippingPlanes=[],this.previewRenderer.setViewport(T,P,b,b),this.previewRenderer.setScissor(T,P,b,b),this.previewRenderer.render(w,S),this.updateSummaryBorder(T,P,b,"sagittal-summary-gizmo-border")}this.previewRenderer.clippingPlanes=[],this.previewRenderer.setScissorTest(!1),this.workRenderer.render(c,u)}get domElement(){return this.workRenderer.domElement}getRenderer(){return this.workRenderer}updateSummaryBorder(e,t,s,i){const n=document.getElementById(i);if(n){const r=window.innerHeight*.7,l=r*1.6,c=(window.innerWidth-l)/2,u=r-t-s,h=c+e;n.style.left=`${h}px`,n.style.top=`${u}px`,n.style.width=`${s}px`,n.style.height=`${s}px`}}getPreviewRenderer(){return this.previewRenderer}dispose(){this.previewRenderer.dispose(),this.workRenderer.dispose()}}class Wr{constructor(e,t={}){this.target=e,this.mesh=new De,this.config={radius:t.radius||2.5,tubeRadius:t.tubeRadius||.04,segments:t.segments||64,opacity:t.opacity||.6,hoverOpacity:t.hoverOpacity||1},this.rotationMode=t.rotationMode||"world",this.axisColors={x:16724787,y:4521796,z:4474111},this.defaultColor=8947848,this.axes={x:this.createAxisRing("x",this.defaultColor),y:this.createAxisRing("y",this.defaultColor),z:this.createAxisRing("z",this.defaultColor)},this.mesh.add(this.axes.x.mesh),this.mesh.add(this.axes.y.mesh),this.mesh.add(this.axes.z.mesh);const s=this.config.radius+.5;this.labels={x:this.createAxisLabel("X",16711680,new v(s,0,0)),y:this.createAxisLabel("Y",65280,new v(0,s,0)),z:this.createAxisLabel("Z",255,new v(0,0,s))},this.mesh.add(this.labels.x),this.mesh.add(this.labels.y),this.mesh.add(this.labels.z),this.highlightPlanes={x:this.createHighlightPlane("x",16711680,"circle"),y:this.createHighlightPlane("y",65280,"circle"),z:this.createHighlightPlane("z",255,"circle")},this.squareHighlightPlanes={x:this.createHighlightPlane("x",16711680,"square"),y:this.createHighlightPlane("y",65280,"square"),z:this.createHighlightPlane("z",255,"square")},this.mesh.add(this.highlightPlanes.x),this.mesh.add(this.highlightPlanes.y),this.mesh.add(this.highlightPlanes.z),this.mesh.add(this.squareHighlightPlanes.x),this.mesh.add(this.squareHighlightPlanes.y),this.mesh.add(this.squareHighlightPlanes.z),this.highlightPlanes.x.visible=!1,this.highlightPlanes.y.visible=!1,this.highlightPlanes.z.visible=!1,this.squareHighlightPlanes.x.visible=!1,this.squareHighlightPlanes.y.visible=!1,this.squareHighlightPlanes.z.visible=!1,this.activeAxis=null,this.hoveredAxis=null,this.isRotating=!1,this.currentStyle="cube",console.log("‚úì Rotation Gizmo created with 3 axis rings and labels")}createAxisRing(e,t){const i=new Jn(0,0,this.config.radius,this.config.radius,0,2*Math.PI,!1,0).getPoints(this.config.segments),n=new At().setFromPoints(i),r=new ns({color:t,transparent:!0,opacity:this.config.opacity,dashSize:.3,gapSize:.2,linewidth:3,depthTest:!0,depthWrite:!0}),l=new _t(n,r);l.computeLineDistances(),e==="x"?l.rotation.y=Math.PI/2:e==="y"&&(l.rotation.x=Math.PI/2);const o=new v;return e==="x"&&o.set(1,0,0),e==="y"&&o.set(0,1,0),e==="z"&&o.set(0,0,1),l.userData={type:"gizmo-axis",axis:e,axisVector:o},{name:e,mesh:l,material:r,color:t,axisVector:o}}createAxisLabel(e,t,s){const i=document.createElement("canvas"),n=320;i.width=n,i.height=n;const r=i.getContext("2d");r.clearRect(0,0,n,n);const l=n/2,o=n/2,c=130;let u;t===16711680?u="#CC0000":t===65280?u="#009900":t===255?u="#0000CC":u="#"+t.toString(16).padStart(6,"0"),r.beginPath(),r.arc(l,o,c,0,Math.PI*2),r.fillStyle=u,r.fill(),r.strokeStyle="rgba(255, 255, 255, 0.4)",r.lineWidth=3,r.stroke(),r.font="Bold 180px Arial",r.fillStyle="#FFFFFF",r.textAlign="center",r.textBaseline="middle",r.shadowColor="rgba(0, 0, 0, 0.6)",r.shadowBlur=5,r.shadowOffsetX=2,r.shadowOffsetY=2,r.fillText(e,l,o);const h=new er(i);h.needsUpdate=!0;const f=new tr({map:h,transparent:!0,depthTest:!1,depthWrite:!1}),d=new sr(f);return d.position.copy(s),d.scale.set(1.4,1.4,1.4),d.userData={type:"gizmo-label",axis:e.toLowerCase(),axisVector:this.axes[e.toLowerCase()].axisVector},d}createHighlightPlane(e,t,s="circle"){let i;if(s==="square"){const l=this.config.radius*1.2;i=new Le(l,l)}else i=new Qt(this.config.radius,64);const n=new H({color:t,transparent:!0,opacity:.2,side:k,depthWrite:!1}),r=new D(i,n);return e==="x"?r.rotation.y=Math.PI/2:e==="y"&&(r.rotation.x=Math.PI/2),r}update(){this.target&&(this.mesh.position.copy(this.target.position),this.rotationMode==="local"?this.mesh.quaternion.copy(this.target.quaternion):this.mesh.quaternion.identity())}setRotationMode(e){(e==="world"||e==="local")&&(this.rotationMode=e,console.log(`üåç Rotation mode: ${e.toUpperCase()}`))}getWorldAxisVector(e){const t=this.axes[e];if(!t)return null;if(this.rotationMode==="local"){const s=t.axisVector.clone();return s.applyQuaternion(this.target.quaternion),s.normalize()}else return t.axisVector.clone()}setHoverAxis(e){this.isRotating||(this.hoveredAxis=e,e?(Object.keys(this.axes).forEach(t=>{t===e?(this.axes[t].material.opacity=this.config.hoverOpacity,this.axes[t].material.color.setHex(this.axisColors[t]),this.squareFrames&&this.squareFrames[t]&&this.squareFrames[t].children.forEach(s=>{s.material.opacity=this.config.hoverOpacity,s.material.color.setHex(this.axisColors[t])}),this.currentStyle==="cube"?(this.squareHighlightPlanes[t].visible=!0,this.highlightPlanes[t].visible=!1):(this.highlightPlanes[t].visible=!0,this.squareHighlightPlanes[t].visible=!1),this.labels[t].material.opacity=1):(this.axes[t].material.opacity=this.config.opacity*.3,this.axes[t].material.color.setHex(this.defaultColor),this.squareFrames&&this.squareFrames[t]&&this.squareFrames[t].children.forEach(s=>{s.material.opacity=this.config.opacity*.3,s.material.color.setHex(this.defaultColor)}),this.highlightPlanes[t].visible=!1,this.squareHighlightPlanes[t].visible=!1,this.labels[t].material.opacity=.3)}),console.log(`üé® Highlighting ${e.toUpperCase()}-axis (hover)`)):Object.keys(this.axes).forEach(t=>{this.axes[t].material.opacity=this.config.opacity,this.axes[t].material.color.setHex(this.defaultColor),this.squareFrames&&this.squareFrames[t]&&this.squareFrames[t].children.forEach(s=>{s.material.opacity=this.config.opacity,s.material.color.setHex(this.defaultColor)}),this.highlightPlanes[t].visible=!1,this.squareHighlightPlanes[t].visible=!1,this.labels[t].material.opacity=1}))}setActiveAxis(e){this.isRotating=!0,this.activeAxis=e,Object.keys(this.axes).forEach(t=>{t===e?(this.axes[t].material.opacity=this.config.hoverOpacity,this.axes[t].material.color.setHex(this.axisColors[t]),this.squareFrames&&this.squareFrames[t]&&this.squareFrames[t].children.forEach(s=>{s.material.opacity=this.config.hoverOpacity,s.material.color.setHex(this.axisColors[t])}),this.currentStyle==="cube"?(this.squareHighlightPlanes[t].visible=!0,this.highlightPlanes[t].visible=!1):(this.highlightPlanes[t].visible=!0,this.squareHighlightPlanes[t].visible=!1),this.labels[t].material.opacity=1):(this.axes[t].material.opacity=this.config.opacity*.2,this.axes[t].material.color.setHex(this.defaultColor),this.squareFrames&&this.squareFrames[t]&&this.squareFrames[t].children.forEach(s=>{s.material.opacity=this.config.opacity*.2,s.material.color.setHex(this.defaultColor)}),this.highlightPlanes[t].visible=!1,this.squareHighlightPlanes[t].visible=!1,this.labels[t].material.opacity=.2)}),e&&console.log(`üîí Locked ${e.toUpperCase()}-axis (active)`)}clearActiveAxis(){Object.keys(this.axes).forEach(e=>{this.axes[e].material.opacity=this.config.opacity,this.axes[e].material.color.setHex(this.defaultColor),this.squareFrames&&this.squareFrames[e]&&this.squareFrames[e].children.forEach(t=>{t.material.opacity=this.config.opacity,t.material.color.setHex(this.defaultColor)}),this.highlightPlanes[e].visible=!1,this.squareHighlightPlanes[e].visible=!1,this.labels[e].material.opacity=1}),this.activeAxis=null,this.isRotating=!1}getPickingMeshes(){const e=[this.labels.x,this.labels.y,this.labels.z];return this.currentStyle==="cube"?(this.squareFrames&&e.push(this.squareFrames.x,this.squareFrames.y,this.squareFrames.z),this.cubePlanes&&e.push(this.cubePlanes.x,this.cubePlanes.y,this.cubePlanes.z)):this.currentStyle==="linear"?this.linearLines&&e.push(this.linearLines.x,this.linearLines.y,this.linearLines.z):e.push(this.axes.x.mesh,this.axes.y.mesh,this.axes.z.mesh),e}getMesh(){return this.mesh}applyStyle(e){console.log(`üé® Applying style: ${e}`),this.currentStyle=e,e==="circular"?this.applyCircularStyle():e==="linear"?this.applyLinearStyle():e==="cube"?this.applyCubeStyle():(console.warn(`Unknown style: ${e}, defaulting to circular`),this.applyCircularStyle())}applyCircularStyle(){this.axes.x.mesh.visible=!0,this.axes.y.mesh.visible=!0,this.axes.z.mesh.visible=!0,this.linearLines&&(this.linearLines.x.visible=!1,this.linearLines.y.visible=!1,this.linearLines.z.visible=!1),this.cubePlanes&&(this.cubePlanes.x.visible=!1,this.cubePlanes.y.visible=!1,this.cubePlanes.z.visible=!1),this.squareFrames&&(this.squareFrames.x.visible=!1,this.squareFrames.y.visible=!1,this.squareFrames.z.visible=!1),this.cubeAxisLines&&(this.cubeAxisLines.x.visible=!1,this.cubeAxisLines.y.visible=!1,this.cubeAxisLines.z.visible=!1),this.labels.x.visible=!0,this.labels.y.visible=!0,this.labels.z.visible=!0,console.log("‚úì Circular style applied")}applyLinearStyle(){this.axes.x.mesh.visible=!1,this.axes.y.mesh.visible=!1,this.axes.z.mesh.visible=!1,this.cubePlanes&&(this.cubePlanes.x.visible=!1,this.cubePlanes.y.visible=!1,this.cubePlanes.z.visible=!1),this.linearLines||this.createLinearLines(),this.linearLines.x.visible=!0,this.linearLines.y.visible=!0,this.linearLines.z.visible=!0,this.labels.x.visible=!0,this.labels.y.visible=!0,this.labels.z.visible=!0,console.log("‚úì Linear style applied")}createLinearLines(){this.linearLines={};const e=this.config.radius+.5,t=.04,s=new We(t,t,e,16),i=new H({color:16711680,transparent:!0,opacity:.8}),n=new D(s,i);n.rotation.z=-Math.PI/2,n.position.x=e/2,this.linearLines.x=n,this.mesh.add(n);const r=new We(t,t,e,16),l=new H({color:65280,transparent:!0,opacity:.8}),o=new D(r,l);o.position.y=e/2,this.linearLines.y=o,this.mesh.add(o);const c=new We(t,t,e,16),u=new H({color:255,transparent:!0,opacity:.8}),h=new D(c,u);h.rotation.x=Math.PI/2,h.position.z=e/2,this.linearLines.z=h,this.mesh.add(h),this.linearLines.x.visible=!1,this.linearLines.y.visible=!1,this.linearLines.z.visible=!1,console.log("‚úì Linear axis lines created")}applyCubeStyle(){this.axes.x.mesh.visible=!1,this.axes.y.mesh.visible=!1,this.axes.z.mesh.visible=!1,this.linearLines||this.createLinearLines(),this.linearLines.x.visible=!0,this.linearLines.y.visible=!0,this.linearLines.z.visible=!0,this.cubeAxisLines&&(this.cubeAxisLines.x.visible=!1,this.cubeAxisLines.y.visible=!1,this.cubeAxisLines.z.visible=!1),this.squareFrames||this.createSquareAxisFrames(),this.squareFrames.x.visible=!0,this.squareFrames.y.visible=!0,this.squareFrames.z.visible=!0,this.cubePlanes||this.createCubePlanes(),this.cubePlanes.x.visible=!0,this.cubePlanes.y.visible=!0,this.cubePlanes.z.visible=!0,this.cubePlanes.x.material.opacity=0,this.cubePlanes.y.material.opacity=0,this.cubePlanes.z.material.opacity=0,this.labels.x.visible=!0,this.labels.y.visible=!0,this.labels.z.visible=!0,console.log("‚úì Cube style applied")}createCubeAxisLines(){this.cubeAxisLines={};const e=1.95,t=.03,s=new We(t,t,e,16),i=new H({color:16711680,transparent:!0,opacity:.8}),n=new D(s,i);n.rotation.z=-Math.PI/2,n.position.x=e/2,this.cubeAxisLines.x=n,this.mesh.add(n);const r=new We(t,t,e,16),l=new H({color:65280,transparent:!0,opacity:.8}),o=new D(r,l);o.position.y=e/2,this.cubeAxisLines.y=o,this.mesh.add(o);const c=new We(t,t,e,16),u=new H({color:255,transparent:!0,opacity:.8}),h=new D(c,u);h.rotation.x=Math.PI/2,h.position.z=e/2,this.cubeAxisLines.z=h,this.mesh.add(h),this.cubeAxisLines.x.visible=!1,this.cubeAxisLines.y.visible=!1,this.cubeAxisLines.z.visible=!1,console.log("‚úì Cube axis lines created")}createSquareAxisFrames(){this.squareFrames={};const t=3.6/2,s=(i,n)=>{const r=new De,l=[{start:new v(-t,-t,0),end:new v(t,-t,0)},{start:new v(t,-t,0),end:new v(t,t,0)},{start:new v(t,t,0),end:new v(-t,t,0)},{start:new v(-t,t,0),end:new v(-t,-t,0)}],o=new ns({color:i,transparent:!0,opacity:this.config.opacity,dashSize:.3,gapSize:.2,linewidth:3,depthTest:!0,depthWrite:!0});return l.forEach(c=>{const u=[c.start,c.end],h=new At().setFromPoints(u),f=new _t(h,o.clone());f.computeLineDistances(),r.add(f)}),r.userData={type:"gizmo-axis",axis:n,axisVector:n==="x"?new v(1,0,0):n==="y"?new v(0,1,0):new v(0,0,1)},r};this.squareFrames.x=s(this.defaultColor,"x"),this.squareFrames.x.rotation.y=Math.PI/2,this.mesh.add(this.squareFrames.x),this.squareFrames.y=s(this.defaultColor,"y"),this.squareFrames.y.rotation.x=Math.PI/2,this.mesh.add(this.squareFrames.y),this.squareFrames.z=s(this.defaultColor,"z"),this.mesh.add(this.squareFrames.z),this.squareFrames.x.visible=!1,this.squareFrames.y.visible=!1,this.squareFrames.z.visible=!1,console.log("‚úì Square axis frames created")}createCubePlanes(){this.cubePlanes={};const e=this.config.radius*.7,t=this.config.radius,s=new Le(e,e),i=new H({color:16711680,transparent:!0,opacity:.3,side:k,depthTest:!0,depthWrite:!1}),n=new D(s,i);n.rotation.y=Math.PI/2,n.position.x=t,n.userData={type:"gizmo-axis",axis:"x",axisVector:new v(1,0,0)},this.cubePlanes.x=n,this.mesh.add(n);const r=new Le(e,e),l=new H({color:65280,transparent:!0,opacity:.3,side:k,depthTest:!0,depthWrite:!1}),o=new D(r,l);o.rotation.x=Math.PI/2,o.position.y=t,o.userData={type:"gizmo-axis",axis:"y",axisVector:new v(0,1,0)},this.cubePlanes.y=o,this.mesh.add(o);const c=new Le(e,e),u=new H({color:255,transparent:!0,opacity:.3,side:k,depthTest:!0,depthWrite:!1}),h=new D(c,u);h.position.z=t,h.userData={type:"gizmo-axis",axis:"z",axisVector:new v(0,0,1)},this.cubePlanes.z=h,this.mesh.add(h),this.cubePlanes.x.visible=!1,this.cubePlanes.y.visible=!1,this.cubePlanes.z.visible=!1,console.log("‚úì Cube style planes created")}dispose(){Object.keys(this.axes).forEach(e=>{const t=this.axes[e];t.mesh.geometry.dispose(),t.material.dispose()}),this.labels&&Object.keys(this.labels).forEach(e=>{const t=this.labels[e];t.material.map&&t.material.map.dispose(),t.material.dispose()})}}function vi(a,e){const t=new v,s=a.intersectPlane(e,t);return s||null}function Zr(a,e,t){const s=a.angleTo(e),i=new v().crossVectors(a,e),n=Math.sign(i.dot(t));return s*n}function Qr(a,e){const t=new Tt;return t.setFromAxisAngle(a,e),t}function Jr(a,e){const t=new me;return t.setFromNormalAndCoplanarPoint(a,e),t}class eo{constructor(e,t,s,i=null){this.camera=e,this.domElement=t,this.gizmo=s,this.app=i,this.raycaster=new ir,this.raycaster.params.Points.threshold=.5,this.raycaster.params.Line.threshold=.5,this.mouse=new q,this.debugMode=!0,this.config={minAngleThreshold:.001,maxCameraAlignmentDot:.99},this.isDragging=!1,this.hoveredAxis=null,this.selectedAxis=null,this.isCameraRotating=!1,this.mouseDownPosition=new q,this.mouseDownTime=0,this.hitType=null,this.rotationPlane=null,this.initialHitPoint=null,this.initialRotation=null,this.currentAxisVector=null,this.onGizmoInteractionStart=null,this.onGizmoInteractionEnd=null,this.onMouseMove=this.onMouseMove.bind(this),this.onMouseDown=this.onMouseDown.bind(this),this.onMouseUp=this.onMouseUp.bind(this),this.attachEventListeners(),console.log("‚úì Input Handler initialized")}attachEventListeners(){this.domElement.addEventListener("mousemove",this.onMouseMove,!0),this.domElement.addEventListener("mousedown",this.onMouseDown,!0),this.domElement.addEventListener("mouseup",this.onMouseUp,!0)}detachEventListeners(){this.domElement.removeEventListener("mousemove",this.onMouseMove,!0),this.domElement.removeEventListener("mousedown",this.onMouseDown,!0),this.domElement.removeEventListener("mouseup",this.onMouseUp,!0)}updateMousePosition(e){const t=this.domElement.getBoundingClientRect();this.mouse.x=(e.clientX-t.left)/t.width*2-1,this.mouse.y=-((e.clientY-t.top)/t.height)*2+1}raycastGizmo(){this.raycaster.setFromCamera(this.mouse,this.camera);const e=this.gizmo.getPickingMeshes(),t=this.raycaster.intersectObjects(e,!0);if(this.debugMode&&t.length>0&&console.log(`üîç Raycast hit ${t.length} object(s)`),t.length>0){const s=t[0];let i=s.object.userData,n=s.object;for(;(!i.type||!i.axis)&&n.parent&&(n=n.parent,i=n.userData,!i.axis););if(i.type==="gizmo-axis"||i.type==="gizmo-label"){const r=i.type==="gizmo-label";if(this.debugMode){const l=r?"label":"axis";console.log(`‚úÖ Hit ${i.axis.toUpperCase()}-axis ${l} at distance ${s.distance.toFixed(2)}`)}return{axis:i.axis,axisVector:i.axisVector,point:s.point,object:s.object,isLabel:r}}}return null}onMouseMove(e){if(this.updateMousePosition(e),this.yAxisDragMode!==void 0){if(this.yAxisDragMode===null){const t=Math.abs(e.clientX-this.sliceDragStartX),s=Math.abs(e.clientY-this.sliceDragStartY);(t>5||s>5)&&(s>t?(this.yAxisDragMode="slice",this.isControllingSlice=!0,this.isDragging=!1,this.domElement.style.cursor="url('/pointer.png') 3 3, ns-resize",console.log("üéØ Y-axis: Vertical drag detected - slice control")):(this.yAxisDragMode="rotate",this.isDragging=!0,this.isControllingSlice=!1,this.gizmo.isRotating=!0,this.domElement.style.cursor="url('/pointer.png') 3 3, ew-resize",this.setupRotation({axis:"y",axisVector:new v(0,1,0)}),console.log("üéØ Y-axis: Horizontal drag detected - rotation")))}this.yAxisDragMode==="slice"?this.updateSlicePosition(e):this.yAxisDragMode==="rotate"&&this.updateRotation(e)}else this.isControllingSlice?this.updateSlicePosition(e):this.isDragging?this.updateRotation():this.isCameraRotating||this.updateHover()}updateHover(){const e=this.raycastGizmo();e?this.hoveredAxis!==e.axis&&(this.hoveredAxis=e.axis,this.gizmo.setHoverAxis(e.axis),this.domElement.style.cursor="url('/pointer.png') 3 3, auto",console.log(`‚ú® Hovering over ${e.axis.toUpperCase()}-axis`)):this.hoveredAxis!==null&&(console.log("üëã Hover ended"),this.gizmo.setHoverAxis(null),this.hoveredAxis=null,this.domElement.style.cursor="url('/pointer.png') 3 3, auto")}onMouseDown(e){if(e.button!==0)return;this.updateMousePosition(e);const t=this.raycastGizmo();t?(this.mouseDownPosition.copy(this.mouse),this.mouseDownTime=Date.now(),this.hitType=t.isLabel?"label":"ring",this.selectedAxis=t.axis,t.isLabel?t.axis==="y"&&this.app?(e.stopPropagation(),e.preventDefault(),this.isControllingSlice=!0,this.isDragging=!1,this.isCameraRotating=!1,this.sliceDragStartY=e.clientY,this.sliceStartPosition=this.app.transverseYPosition||0,this.domElement.style.cursor="url('/pointer.png') 3 3, ns-resize",console.log("üè∑Ô∏è Y-axis label clicked - transverse slice control enabled")):(this.isCameraRotating=!0,this.isDragging=!1,console.log(`üè∑Ô∏è Label ${t.axis.toUpperCase()} clicked - camera rotation enabled`)):t.axis==="y"&&this.app?(e.stopPropagation(),e.preventDefault(),this.yAxisDragMode=null,this.sliceDragStartY=e.clientY,this.sliceDragStartX=e.clientX,this.sliceStartPosition=this.app.transverseYPosition||0,this.gizmo.setActiveAxis(t.axis),this.domElement.style.cursor="url('/pointer.png') 3 3, move",this.onGizmoInteractionStart&&this.onGizmoInteractionStart(),console.log("üéØ Y-axis grabbed - waiting for drag direction")):(e.stopPropagation(),e.preventDefault(),this.isDragging=!0,this.isCameraRotating=!1,this.gizmo.setActiveAxis(t.axis),this.gizmo.isRotating=!0,this.domElement.style.cursor="url('/pointer.png') 3 3, auto",this.onGizmoInteractionStart&&this.onGizmoInteractionStart(),console.log(`üéØ Ring ${t.axis.toUpperCase()} grabbed - axis rotation enabled`),this.setupRotation(t))):(this.isCameraRotating=!0,this.hitType=null,this.gizmo.setHoverAxis(null),this.hoveredAxis=null)}onMouseUp(e){const s=Date.now()-this.mouseDownTime,i=this.mouse.distanceTo(this.mouseDownPosition);this.yAxisDragMode!==void 0&&(this.yAxisDragMode=void 0,this.isControllingSlice=!1,this.isDragging=!1,this.domElement.style.cursor="url('/pointer.png') 3 3, auto",this.gizmo.clearActiveAxis(),this.gizmo.isRotating=!1,this.onGizmoInteractionEnd&&this.onGizmoInteractionEnd(),console.log("‚úÖ Y-axis interaction ended")),this.isControllingSlice&&(this.isControllingSlice=!1,this.domElement.style.cursor="url('/pointer.png') 3 3, auto",this.gizmo.clearActiveAxis(),this.onGizmoInteractionEnd&&this.onGizmoInteractionEnd(),console.log(`‚úÖ Transverse slice control ended at Y = ${this.app.transverseYPosition.toFixed(2)}`)),s<250&&i<.05&&this.selectedAxis&&this.hitType==="label"&&this.selectedAxis!=="y"&&(console.log(`üéØ Quick label click - snapping to ${this.selectedAxis.toUpperCase()}-axis view`),this.snapToAxisView(this.selectedAxis)),this.isDragging&&(e.stopPropagation(),e.preventDefault(),this.isDragging=!1,this.gizmo.clearActiveAxis(),this.domElement.style.cursor="url('/pointer.png') 8 8, auto",this.onGizmoInteractionEnd&&this.onGizmoInteractionEnd(),console.log("‚úÖ Ring rotation ended"),this.clearRotationState()),this.selectedAxis=null,this.hitType=null,this.isCameraRotating=!1}setupRotation(e){if(this.currentAxisVector=this.gizmo.getWorldAxisVector(e.axis),!this.currentAxisVector){console.error("‚ö†Ô∏è Failed to get axis vector");return}const t=new v;this.camera.getWorldDirection(t),Math.abs(t.dot(this.currentAxisVector))>this.config.maxCameraAlignmentDot&&(console.log("‚ö†Ô∏è Camera aligned with axis - using fallback plane"),this.currentAxisVector=this.getFallbackAxis(this.currentAxisVector,t));const i=this.gizmo.target.position;this.rotationPlane=Jr(this.currentAxisVector,i),this.raycaster.setFromCamera(this.mouse,this.camera);const n=this.raycaster.ray;this.initialHitPoint=vi(n,this.rotationPlane),this.initialRotation=this.gizmo.target.quaternion.clone(),this.initialHitPoint?console.log(`‚úÖ Rotation setup complete for ${e.axis.toUpperCase()}-axis`):console.warn("‚ö†Ô∏è Could not establish initial hit point")}getFallbackAxis(e,t){const s=this.camera.up.clone(),i=new v().crossVectors(t,s);return i.normalize(),console.log("üîÑ Using fallback rotation plane"),i}updateSlicePosition(e){if(!this.app)return;const t=e.clientY-this.sliceDragStartY,i=this.sliceStartPosition-t*.02,n=Math.max(-3,Math.min(3,i));this.app.updateTransverseClipping(n)}updateRotation(){if(!this.initialHitPoint||!this.rotationPlane||!this.currentAxisVector)return;this.raycaster.setFromCamera(this.mouse,this.camera);const e=this.raycaster.ray,t=vi(e,this.rotationPlane);if(!t)return;const s=this.gizmo.target.position,i=new v().subVectors(this.initialHitPoint,s),n=new v().subVectors(t,s),r=i.length(),l=n.length();if(r<.001||l<.001)return;i.normalize(),n.normalize();const o=Zr(i,n,this.currentAxisVector);if(Math.abs(o)<this.config.minAngleThreshold)return;const c=Qr(this.currentAxisVector,o);if(this.gizmo.target.quaternion.copy(this.initialRotation),this.gizmo.target.quaternion.premultiply(c),this.debugMode&&Math.abs(o)>.01){const u=(o*180/Math.PI).toFixed(1);console.log(`üîÑ Rotating ${u}¬∞ around ${this.selectedAxis.toUpperCase()}-axis`)}}clearRotationState(){this.rotationPlane=null,this.initialHitPoint=null,this.initialRotation=null,this.currentAxisVector=null}snapToAxisView(e){const t=this.camera.position.length(),s=new v;e==="x"?s.set(t,0,0):e==="y"?s.set(0,t,0):e==="z"&&s.set(0,0,t);const i=600,n=Date.now(),r=this.camera.position.clone();this.onGizmoInteractionStart&&this.onGizmoInteractionStart();const l=()=>{const o=Date.now()-n,c=Math.min(o/i,1),u=.5-Math.cos(c*Math.PI)/2;this.camera.position.lerpVectors(r,s,u),this.camera.lookAt(0,0,0),c<1?requestAnimationFrame(l):(this.onGizmoInteractionEnd&&this.onGizmoInteractionEnd(),console.log(`‚úÖ Camera aligned to ${e.toUpperCase()}-axis view`))};l()}getState(){return{isDragging:this.isDragging,hoveredAxis:this.hoveredAxis,selectedAxis:this.selectedAxis}}dispose(){this.detachEventListeners()}}function Ei(a,e){if(e===nr)return console.warn("THREE.BufferGeometryUtils.toTrianglesDrawMode(): Geometry already defined as triangles."),a;if(e===Vs||e===Pn){let t=a.getIndex();if(t===null){const r=[],l=a.getAttribute("position");if(l!==void 0){for(let o=0;o<l.count;o++)r.push(o);a.setIndex(r),t=a.getIndex()}else return console.error("THREE.BufferGeometryUtils.toTrianglesDrawMode(): Undefined position attribute. Processing not possible."),a}const s=t.count-2,i=[];if(e===Vs)for(let r=1;r<=s;r++)i.push(t.getX(0)),i.push(t.getX(r)),i.push(t.getX(r+1));else for(let r=0;r<s;r++)r%2===0?(i.push(t.getX(r)),i.push(t.getX(r+1)),i.push(t.getX(r+2))):(i.push(t.getX(r+2)),i.push(t.getX(r+1)),i.push(t.getX(r)));i.length/3!==s&&console.error("THREE.BufferGeometryUtils.toTrianglesDrawMode(): Unable to generate correct amount of triangles.");const n=a.clone();return n.setIndex(i),n.clearGroups(),n}else return console.error("THREE.BufferGeometryUtils.toTrianglesDrawMode(): Unknown draw mode:",e),a}class to extends rr{constructor(e){super(e),this.dracoLoader=null,this.ktx2Loader=null,this.meshoptDecoder=null,this.pluginCallbacks=[],this.register(function(t){return new oo(t)}),this.register(function(t){return new ao(t)}),this.register(function(t){return new yo(t)}),this.register(function(t){return new xo(t)}),this.register(function(t){return new bo(t)}),this.register(function(t){return new co(t)}),this.register(function(t){return new uo(t)}),this.register(function(t){return new ho(t)}),this.register(function(t){return new fo(t)}),this.register(function(t){return new ro(t)}),this.register(function(t){return new mo(t)}),this.register(function(t){return new lo(t)}),this.register(function(t){return new go(t)}),this.register(function(t){return new po(t)}),this.register(function(t){return new io(t)}),this.register(function(t){return new So(t)}),this.register(function(t){return new wo(t)})}load(e,t,s,i){const n=this;let r;if(this.resourcePath!=="")r=this.resourcePath;else if(this.path!==""){const c=St.extractUrlBase(e);r=St.resolveURL(c,this.path)}else r=St.extractUrlBase(e);this.manager.itemStart(e);const l=function(c){i?i(c):console.error(c),n.manager.itemError(e),n.manager.itemEnd(e)},o=new Tn(this.manager);o.setPath(this.path),o.setResponseType("arraybuffer"),o.setRequestHeader(this.requestHeader),o.setWithCredentials(this.withCredentials),o.load(e,function(c){try{n.parse(c,r,function(u){t(u),n.manager.itemEnd(e)},l)}catch(u){l(u)}},s,l)}setDRACOLoader(e){return this.dracoLoader=e,this}setKTX2Loader(e){return this.ktx2Loader=e,this}setMeshoptDecoder(e){return this.meshoptDecoder=e,this}register(e){return this.pluginCallbacks.indexOf(e)===-1&&this.pluginCallbacks.push(e),this}unregister(e){return this.pluginCallbacks.indexOf(e)!==-1&&this.pluginCallbacks.splice(this.pluginCallbacks.indexOf(e),1),this}parse(e,t,s,i){let n;const r={},l={},o=new TextDecoder;if(typeof e=="string")n=JSON.parse(e);else if(e instanceof ArrayBuffer)if(o.decode(new Uint8Array(e,0,4))===zn){try{r[I.KHR_BINARY_GLTF]=new Po(e)}catch(h){i&&i(h);return}n=JSON.parse(r[I.KHR_BINARY_GLTF].content)}else n=JSON.parse(o.decode(e));else n=e;if(n.asset===void 0||n.asset.version[0]<2){i&&i(new Error("THREE.GLTFLoader: Unsupported asset. glTF versions >=2.0 are supported."));return}const c=new Do(n,{path:t||this.resourcePath||"",crossOrigin:this.crossOrigin,requestHeader:this.requestHeader,manager:this.manager,ktx2Loader:this.ktx2Loader,meshoptDecoder:this.meshoptDecoder});c.fileLoader.setRequestHeader(this.requestHeader);for(let u=0;u<this.pluginCallbacks.length;u++){const h=this.pluginCallbacks[u](c);h.name||console.error("THREE.GLTFLoader: Invalid plugin found: missing name"),l[h.name]=h,r[h.name]=!0}if(n.extensionsUsed)for(let u=0;u<n.extensionsUsed.length;++u){const h=n.extensionsUsed[u],f=n.extensionsRequired||[];switch(h){case I.KHR_MATERIALS_UNLIT:r[h]=new no;break;case I.KHR_DRACO_MESH_COMPRESSION:r[h]=new To(n,this.dracoLoader);break;case I.KHR_TEXTURE_TRANSFORM:r[h]=new Ao;break;case I.KHR_MESH_QUANTIZATION:r[h]=new _o;break;default:f.indexOf(h)>=0&&l[h]===void 0&&console.warn('THREE.GLTFLoader: Unknown extension "'+h+'".')}}c.setExtensions(r),c.setPlugins(l),c.parse(s,i)}parseAsync(e,t){const s=this;return new Promise(function(i,n){s.parse(e,t,i,n)})}}function so(){let a={};return{get:function(e){return a[e]},add:function(e,t){a[e]=t},remove:function(e){delete a[e]},removeAll:function(){a={}}}}const I={KHR_BINARY_GLTF:"KHR_binary_glTF",KHR_DRACO_MESH_COMPRESSION:"KHR_draco_mesh_compression",KHR_LIGHTS_PUNCTUAL:"KHR_lights_punctual",KHR_MATERIALS_CLEARCOAT:"KHR_materials_clearcoat",KHR_MATERIALS_DISPERSION:"KHR_materials_dispersion",KHR_MATERIALS_IOR:"KHR_materials_ior",KHR_MATERIALS_SHEEN:"KHR_materials_sheen",KHR_MATERIALS_SPECULAR:"KHR_materials_specular",KHR_MATERIALS_TRANSMISSION:"KHR_materials_transmission",KHR_MATERIALS_IRIDESCENCE:"KHR_materials_iridescence",KHR_MATERIALS_ANISOTROPY:"KHR_materials_anisotropy",KHR_MATERIALS_UNLIT:"KHR_materials_unlit",KHR_MATERIALS_VOLUME:"KHR_materials_volume",KHR_TEXTURE_BASISU:"KHR_texture_basisu",KHR_TEXTURE_TRANSFORM:"KHR_texture_transform",KHR_MESH_QUANTIZATION:"KHR_mesh_quantization",KHR_MATERIALS_EMISSIVE_STRENGTH:"KHR_materials_emissive_strength",EXT_MATERIALS_BUMP:"EXT_materials_bump",EXT_TEXTURE_WEBP:"EXT_texture_webp",EXT_TEXTURE_AVIF:"EXT_texture_avif",EXT_MESHOPT_COMPRESSION:"EXT_meshopt_compression",EXT_MESH_GPU_INSTANCING:"EXT_mesh_gpu_instancing"};class io{constructor(e){this.parser=e,this.name=I.KHR_LIGHTS_PUNCTUAL,this.cache={refs:{},uses:{}}}_markDefs(){const e=this.parser,t=this.parser.json.nodes||[];for(let s=0,i=t.length;s<i;s++){const n=t[s];n.extensions&&n.extensions[this.name]&&n.extensions[this.name].light!==void 0&&e._addNodeRef(this.cache,n.extensions[this.name].light)}}_loadLight(e){const t=this.parser,s="light:"+e;let i=t.cache.get(s);if(i)return i;const n=t.json,o=((n.extensions&&n.extensions[this.name]||{}).lights||[])[e];let c;const u=new Be(16777215);o.color!==void 0&&u.setRGB(o.color[0],o.color[1],o.color[2],Ae);const h=o.range!==void 0?o.range:0;switch(o.type){case"directional":c=new at(u),c.target.position.set(0,0,-1),c.add(c.target);break;case"point":c=new ar(u),c.distance=h;break;case"spot":c=new or(u),c.distance=h,o.spot=o.spot||{},o.spot.innerConeAngle=o.spot.innerConeAngle!==void 0?o.spot.innerConeAngle:0,o.spot.outerConeAngle=o.spot.outerConeAngle!==void 0?o.spot.outerConeAngle:Math.PI/4,c.angle=o.spot.outerConeAngle,c.penumbra=1-o.spot.innerConeAngle/o.spot.outerConeAngle,c.target.position.set(0,0,-1),c.add(c.target);break;default:throw new Error("THREE.GLTFLoader: Unexpected light type: "+o.type)}return c.position.set(0,0,0),ge(c,o),o.intensity!==void 0&&(c.intensity=o.intensity),c.name=t.createUniqueName(o.name||"light_"+e),i=Promise.resolve(c),t.cache.add(s,i),i}getDependency(e,t){if(e==="light")return this._loadLight(t)}createNodeAttachment(e){const t=this,s=this.parser,n=s.json.nodes[e],l=(n.extensions&&n.extensions[this.name]||{}).light;return l===void 0?null:this._loadLight(l).then(function(o){return s._getNodeRef(t.cache,l,o)})}}class no{constructor(){this.name=I.KHR_MATERIALS_UNLIT}getMaterialType(){return H}extendParams(e,t,s){const i=[];e.color=new Be(1,1,1),e.opacity=1;const n=t.pbrMetallicRoughness;if(n){if(Array.isArray(n.baseColorFactor)){const r=n.baseColorFactor;e.color.setRGB(r[0],r[1],r[2],Ae),e.opacity=r[3]}n.baseColorTexture!==void 0&&i.push(s.assignTexture(e,"map",n.baseColorTexture,Mt))}return Promise.all(i)}}class ro{constructor(e){this.parser=e,this.name=I.KHR_MATERIALS_EMISSIVE_STRENGTH}extendMaterialParams(e,t){const i=this.parser.json.materials[e];if(!i.extensions||!i.extensions[this.name])return Promise.resolve();const n=i.extensions[this.name].emissiveStrength;return n!==void 0&&(t.emissiveIntensity=n),Promise.resolve()}}class oo{constructor(e){this.parser=e,this.name=I.KHR_MATERIALS_CLEARCOAT}getMaterialType(e){const s=this.parser.json.materials[e];return!s.extensions||!s.extensions[this.name]?null:xe}extendMaterialParams(e,t){const s=this.parser,i=s.json.materials[e];if(!i.extensions||!i.extensions[this.name])return Promise.resolve();const n=[],r=i.extensions[this.name];if(r.clearcoatFactor!==void 0&&(t.clearcoat=r.clearcoatFactor),r.clearcoatTexture!==void 0&&n.push(s.assignTexture(t,"clearcoatMap",r.clearcoatTexture)),r.clearcoatRoughnessFactor!==void 0&&(t.clearcoatRoughness=r.clearcoatRoughnessFactor),r.clearcoatRoughnessTexture!==void 0&&n.push(s.assignTexture(t,"clearcoatRoughnessMap",r.clearcoatRoughnessTexture)),r.clearcoatNormalTexture!==void 0&&(n.push(s.assignTexture(t,"clearcoatNormalMap",r.clearcoatNormalTexture)),r.clearcoatNormalTexture.scale!==void 0)){const l=r.clearcoatNormalTexture.scale;t.clearcoatNormalScale=new q(l,l)}return Promise.all(n)}}class ao{constructor(e){this.parser=e,this.name=I.KHR_MATERIALS_DISPERSION}getMaterialType(e){const s=this.parser.json.materials[e];return!s.extensions||!s.extensions[this.name]?null:xe}extendMaterialParams(e,t){const i=this.parser.json.materials[e];if(!i.extensions||!i.extensions[this.name])return Promise.resolve();const n=i.extensions[this.name];return t.dispersion=n.dispersion!==void 0?n.dispersion:0,Promise.resolve()}}class lo{constructor(e){this.parser=e,this.name=I.KHR_MATERIALS_IRIDESCENCE}getMaterialType(e){const s=this.parser.json.materials[e];return!s.extensions||!s.extensions[this.name]?null:xe}extendMaterialParams(e,t){const s=this.parser,i=s.json.materials[e];if(!i.extensions||!i.extensions[this.name])return Promise.resolve();const n=[],r=i.extensions[this.name];return r.iridescenceFactor!==void 0&&(t.iridescence=r.iridescenceFactor),r.iridescenceTexture!==void 0&&n.push(s.assignTexture(t,"iridescenceMap",r.iridescenceTexture)),r.iridescenceIor!==void 0&&(t.iridescenceIOR=r.iridescenceIor),t.iridescenceThicknessRange===void 0&&(t.iridescenceThicknessRange=[100,400]),r.iridescenceThicknessMinimum!==void 0&&(t.iridescenceThicknessRange[0]=r.iridescenceThicknessMinimum),r.iridescenceThicknessMaximum!==void 0&&(t.iridescenceThicknessRange[1]=r.iridescenceThicknessMaximum),r.iridescenceThicknessTexture!==void 0&&n.push(s.assignTexture(t,"iridescenceThicknessMap",r.iridescenceThicknessTexture)),Promise.all(n)}}class co{constructor(e){this.parser=e,this.name=I.KHR_MATERIALS_SHEEN}getMaterialType(e){const s=this.parser.json.materials[e];return!s.extensions||!s.extensions[this.name]?null:xe}extendMaterialParams(e,t){const s=this.parser,i=s.json.materials[e];if(!i.extensions||!i.extensions[this.name])return Promise.resolve();const n=[];t.sheenColor=new Be(0,0,0),t.sheenRoughness=0,t.sheen=1;const r=i.extensions[this.name];if(r.sheenColorFactor!==void 0){const l=r.sheenColorFactor;t.sheenColor.setRGB(l[0],l[1],l[2],Ae)}return r.sheenRoughnessFactor!==void 0&&(t.sheenRoughness=r.sheenRoughnessFactor),r.sheenColorTexture!==void 0&&n.push(s.assignTexture(t,"sheenColorMap",r.sheenColorTexture,Mt)),r.sheenRoughnessTexture!==void 0&&n.push(s.assignTexture(t,"sheenRoughnessMap",r.sheenRoughnessTexture)),Promise.all(n)}}class uo{constructor(e){this.parser=e,this.name=I.KHR_MATERIALS_TRANSMISSION}getMaterialType(e){const s=this.parser.json.materials[e];return!s.extensions||!s.extensions[this.name]?null:xe}extendMaterialParams(e,t){const s=this.parser,i=s.json.materials[e];if(!i.extensions||!i.extensions[this.name])return Promise.resolve();const n=[],r=i.extensions[this.name];return r.transmissionFactor!==void 0&&(t.transmission=r.transmissionFactor),r.transmissionTexture!==void 0&&n.push(s.assignTexture(t,"transmissionMap",r.transmissionTexture)),Promise.all(n)}}class ho{constructor(e){this.parser=e,this.name=I.KHR_MATERIALS_VOLUME}getMaterialType(e){const s=this.parser.json.materials[e];return!s.extensions||!s.extensions[this.name]?null:xe}extendMaterialParams(e,t){const s=this.parser,i=s.json.materials[e];if(!i.extensions||!i.extensions[this.name])return Promise.resolve();const n=[],r=i.extensions[this.name];t.thickness=r.thicknessFactor!==void 0?r.thicknessFactor:0,r.thicknessTexture!==void 0&&n.push(s.assignTexture(t,"thicknessMap",r.thicknessTexture)),t.attenuationDistance=r.attenuationDistance||1/0;const l=r.attenuationColor||[1,1,1];return t.attenuationColor=new Be().setRGB(l[0],l[1],l[2],Ae),Promise.all(n)}}class fo{constructor(e){this.parser=e,this.name=I.KHR_MATERIALS_IOR}getMaterialType(e){const s=this.parser.json.materials[e];return!s.extensions||!s.extensions[this.name]?null:xe}extendMaterialParams(e,t){const i=this.parser.json.materials[e];if(!i.extensions||!i.extensions[this.name])return Promise.resolve();const n=i.extensions[this.name];return t.ior=n.ior!==void 0?n.ior:1.5,Promise.resolve()}}class mo{constructor(e){this.parser=e,this.name=I.KHR_MATERIALS_SPECULAR}getMaterialType(e){const s=this.parser.json.materials[e];return!s.extensions||!s.extensions[this.name]?null:xe}extendMaterialParams(e,t){const s=this.parser,i=s.json.materials[e];if(!i.extensions||!i.extensions[this.name])return Promise.resolve();const n=[],r=i.extensions[this.name];t.specularIntensity=r.specularFactor!==void 0?r.specularFactor:1,r.specularTexture!==void 0&&n.push(s.assignTexture(t,"specularIntensityMap",r.specularTexture));const l=r.specularColorFactor||[1,1,1];return t.specularColor=new Be().setRGB(l[0],l[1],l[2],Ae),r.specularColorTexture!==void 0&&n.push(s.assignTexture(t,"specularColorMap",r.specularColorTexture,Mt)),Promise.all(n)}}class po{constructor(e){this.parser=e,this.name=I.EXT_MATERIALS_BUMP}getMaterialType(e){const s=this.parser.json.materials[e];return!s.extensions||!s.extensions[this.name]?null:xe}extendMaterialParams(e,t){const s=this.parser,i=s.json.materials[e];if(!i.extensions||!i.extensions[this.name])return Promise.resolve();const n=[],r=i.extensions[this.name];return t.bumpScale=r.bumpFactor!==void 0?r.bumpFactor:1,r.bumpTexture!==void 0&&n.push(s.assignTexture(t,"bumpMap",r.bumpTexture)),Promise.all(n)}}class go{constructor(e){this.parser=e,this.name=I.KHR_MATERIALS_ANISOTROPY}getMaterialType(e){const s=this.parser.json.materials[e];return!s.extensions||!s.extensions[this.name]?null:xe}extendMaterialParams(e,t){const s=this.parser,i=s.json.materials[e];if(!i.extensions||!i.extensions[this.name])return Promise.resolve();const n=[],r=i.extensions[this.name];return r.anisotropyStrength!==void 0&&(t.anisotropy=r.anisotropyStrength),r.anisotropyRotation!==void 0&&(t.anisotropyRotation=r.anisotropyRotation),r.anisotropyTexture!==void 0&&n.push(s.assignTexture(t,"anisotropyMap",r.anisotropyTexture)),Promise.all(n)}}class yo{constructor(e){this.parser=e,this.name=I.KHR_TEXTURE_BASISU}loadTexture(e){const t=this.parser,s=t.json,i=s.textures[e];if(!i.extensions||!i.extensions[this.name])return null;const n=i.extensions[this.name],r=t.options.ktx2Loader;if(!r){if(s.extensionsRequired&&s.extensionsRequired.indexOf(this.name)>=0)throw new Error("THREE.GLTFLoader: setKTX2Loader must be called before loading KTX2 textures");return null}return t.loadTextureImage(e,n.source,r)}}class xo{constructor(e){this.parser=e,this.name=I.EXT_TEXTURE_WEBP}loadTexture(e){const t=this.name,s=this.parser,i=s.json,n=i.textures[e];if(!n.extensions||!n.extensions[t])return null;const r=n.extensions[t],l=i.images[r.source];let o=s.textureLoader;if(l.uri){const c=s.options.manager.getHandler(l.uri);c!==null&&(o=c)}return s.loadTextureImage(e,r.source,o)}}class bo{constructor(e){this.parser=e,this.name=I.EXT_TEXTURE_AVIF}loadTexture(e){const t=this.name,s=this.parser,i=s.json,n=i.textures[e];if(!n.extensions||!n.extensions[t])return null;const r=n.extensions[t],l=i.images[r.source];let o=s.textureLoader;if(l.uri){const c=s.options.manager.getHandler(l.uri);c!==null&&(o=c)}return s.loadTextureImage(e,r.source,o)}}class So{constructor(e){this.name=I.EXT_MESHOPT_COMPRESSION,this.parser=e}loadBufferView(e){const t=this.parser.json,s=t.bufferViews[e];if(s.extensions&&s.extensions[this.name]){const i=s.extensions[this.name],n=this.parser.getDependency("buffer",i.buffer),r=this.parser.options.meshoptDecoder;if(!r||!r.supported){if(t.extensionsRequired&&t.extensionsRequired.indexOf(this.name)>=0)throw new Error("THREE.GLTFLoader: setMeshoptDecoder must be called before loading compressed files");return null}return n.then(function(l){const o=i.byteOffset||0,c=i.byteLength||0,u=i.count,h=i.byteStride,f=new Uint8Array(l,o,c);return r.decodeGltfBufferAsync?r.decodeGltfBufferAsync(u,h,f,i.mode,i.filter).then(function(d){return d.buffer}):r.ready.then(function(){const d=new ArrayBuffer(u*h);return r.decodeGltfBuffer(new Uint8Array(d),u,h,f,i.mode,i.filter),d})})}else return null}}class wo{constructor(e){this.name=I.EXT_MESH_GPU_INSTANCING,this.parser=e}createNodeMesh(e){const t=this.parser.json,s=t.nodes[e];if(!s.extensions||!s.extensions[this.name]||s.mesh===void 0)return null;const i=t.meshes[s.mesh];for(const c of i.primitives)if(c.mode!==oe.TRIANGLES&&c.mode!==oe.TRIANGLE_STRIP&&c.mode!==oe.TRIANGLE_FAN&&c.mode!==void 0)return null;const r=s.extensions[this.name].attributes,l=[],o={};for(const c in r)l.push(this.parser.getDependency("accessor",r[c]).then(u=>(o[c]=u,o[c])));return l.length<1?null:(l.push(this.parser.createNodeMesh(e)),Promise.all(l).then(c=>{const u=c.pop(),h=u.isGroup?u.children:[u],f=c[0].count,d=[];for(const x of h){const w=new ee,S=new v,y=new Tt,p=new v(1,1,1),m=new lr(x.geometry,x.material,f);for(let g=0;g<f;g++)o.TRANSLATION&&S.fromBufferAttribute(o.TRANSLATION,g),o.ROTATION&&y.fromBufferAttribute(o.ROTATION,g),o.SCALE&&p.fromBufferAttribute(o.SCALE,g),m.setMatrixAt(g,w.compose(S,y,p));for(const g in o)if(g==="_COLOR_0"){const b=o[g];m.instanceColor=new cr(b.array,b.itemSize,b.normalized)}else g!=="TRANSLATION"&&g!=="ROTATION"&&g!=="SCALE"&&x.geometry.setAttribute(g,o[g]);An.prototype.copy.call(m,x),this.parser.assignFinalMaterial(m),d.push(m)}return u.isGroup?(u.clear(),u.add(...d),u):d[0]}))}}const zn="glTF",ht=12,zi={JSON:1313821514,BIN:5130562};class Po{constructor(e){this.name=I.KHR_BINARY_GLTF,this.content=null,this.body=null;const t=new DataView(e,0,ht),s=new TextDecoder;if(this.header={magic:s.decode(new Uint8Array(e.slice(0,4))),version:t.getUint32(4,!0),length:t.getUint32(8,!0)},this.header.magic!==zn)throw new Error("THREE.GLTFLoader: Unsupported glTF-Binary header.");if(this.header.version<2)throw new Error("THREE.GLTFLoader: Legacy binary file detected.");const i=this.header.length-ht,n=new DataView(e,ht);let r=0;for(;r<i;){const l=n.getUint32(r,!0);r+=4;const o=n.getUint32(r,!0);if(r+=4,o===zi.JSON){const c=new Uint8Array(e,ht+r,l);this.content=s.decode(c)}else if(o===zi.BIN){const c=ht+r;this.body=e.slice(c,c+l)}r+=l}if(this.content===null)throw new Error("THREE.GLTFLoader: JSON content not found.")}}class To{constructor(e,t){if(!t)throw new Error("THREE.GLTFLoader: No DRACOLoader instance provided.");this.name=I.KHR_DRACO_MESH_COMPRESSION,this.json=e,this.dracoLoader=t,this.dracoLoader.preload()}decodePrimitive(e,t){const s=this.json,i=this.dracoLoader,n=e.extensions[this.name].bufferView,r=e.extensions[this.name].attributes,l={},o={},c={};for(const u in r){const h=$s[u]||u.toLowerCase();l[h]=r[u]}for(const u in e.attributes){const h=$s[u]||u.toLowerCase();if(r[u]!==void 0){const f=s.accessors[e.attributes[u]],d=ct[f.componentType];c[h]=d.name,o[h]=f.normalized===!0}}return t.getDependency("bufferView",n).then(function(u){return new Promise(function(h,f){i.decodeDracoFile(u,function(d){for(const x in d.attributes){const w=d.attributes[x],S=o[x];S!==void 0&&(w.normalized=S)}h(d)},l,c,Ae,f)})})}}class Ao{constructor(){this.name=I.KHR_TEXTURE_TRANSFORM}extendTexture(e,t){return(t.texCoord===void 0||t.texCoord===e.channel)&&t.offset===void 0&&t.rotation===void 0&&t.scale===void 0||(e=e.clone(),t.texCoord!==void 0&&(e.channel=t.texCoord),t.offset!==void 0&&e.offset.fromArray(t.offset),t.rotation!==void 0&&(e.rotation=t.rotation),t.scale!==void 0&&e.repeat.fromArray(t.scale),e.needsUpdate=!0),e}}class _o{constructor(){this.name=I.KHR_MESH_QUANTIZATION}}class Rn extends zr{constructor(e,t,s,i){super(e,t,s,i)}copySampleValue_(e){const t=this.resultBuffer,s=this.sampleValues,i=this.valueSize,n=e*i*3+i;for(let r=0;r!==i;r++)t[r]=s[n+r];return t}interpolate_(e,t,s,i){const n=this.resultBuffer,r=this.sampleValues,l=this.valueSize,o=l*2,c=l*3,u=i-t,h=(s-t)/u,f=h*h,d=f*h,x=e*c,w=x-c,S=-2*d+3*f,y=d-f,p=1-S,m=y-f+h;for(let g=0;g!==l;g++){const b=r[w+g+l],T=r[w+g+o]*u,P=r[x+g+l],A=r[x+g]*u;n[g]=p*b+m*T+S*P+y*A}return n}}const Mo=new Tt;class Co extends Rn{interpolate_(e,t,s,i){const n=super.interpolate_(e,t,s,i);return Mo.fromArray(n).normalize().toArray(n),n}}const oe={POINTS:0,LINES:1,LINE_LOOP:2,LINE_STRIP:3,TRIANGLES:4,TRIANGLE_STRIP:5,TRIANGLE_FAN:6},ct={5120:Int8Array,5121:Uint8Array,5122:Int16Array,5123:Uint16Array,5125:Uint32Array,5126:Float32Array},Ri={9728:Mn,9729:Ys,9984:pr,9985:mr,9986:dr,9987:_n},Li={33071:yr,33648:gr,10497:Ks},bs={SCALAR:1,VEC2:2,VEC3:3,VEC4:4,MAT2:4,MAT3:9,MAT4:16},$s={POSITION:"position",NORMAL:"normal",TANGENT:"tangent",TEXCOORD_0:"uv",TEXCOORD_1:"uv1",TEXCOORD_2:"uv2",TEXCOORD_3:"uv3",COLOR_0:"color",WEIGHTS_0:"skinWeight",JOINTS_0:"skinIndex"},Me={scale:"scale",translation:"position",rotation:"quaternion",weights:"morphTargetInfluences"},vo={CUBICSPLINE:void 0,LINEAR:Cn,STEP:vr},Ss={OPAQUE:"OPAQUE",MASK:"MASK",BLEND:"BLEND"};function Eo(a){return a.DefaultMaterial===void 0&&(a.DefaultMaterial=new O({color:16777215,emissive:0,metalness:1,roughness:1,transparent:!1,depthTest:!0,side:Xs})),a.DefaultMaterial}function He(a,e,t){for(const s in t.extensions)a[s]===void 0&&(e.userData.gltfExtensions=e.userData.gltfExtensions||{},e.userData.gltfExtensions[s]=t.extensions[s])}function ge(a,e){e.extras!==void 0&&(typeof e.extras=="object"?Object.assign(a.userData,e.extras):console.warn("THREE.GLTFLoader: Ignoring primitive type .extras, "+e.extras))}function zo(a,e,t){let s=!1,i=!1,n=!1;for(let c=0,u=e.length;c<u;c++){const h=e[c];if(h.POSITION!==void 0&&(s=!0),h.NORMAL!==void 0&&(i=!0),h.COLOR_0!==void 0&&(n=!0),s&&i&&n)break}if(!s&&!i&&!n)return Promise.resolve(a);const r=[],l=[],o=[];for(let c=0,u=e.length;c<u;c++){const h=e[c];if(s){const f=h.POSITION!==void 0?t.getDependency("accessor",h.POSITION):a.attributes.position;r.push(f)}if(i){const f=h.NORMAL!==void 0?t.getDependency("accessor",h.NORMAL):a.attributes.normal;l.push(f)}if(n){const f=h.COLOR_0!==void 0?t.getDependency("accessor",h.COLOR_0):a.attributes.color;o.push(f)}}return Promise.all([Promise.all(r),Promise.all(l),Promise.all(o)]).then(function(c){const u=c[0],h=c[1],f=c[2];return s&&(a.morphAttributes.position=u),i&&(a.morphAttributes.normal=h),n&&(a.morphAttributes.color=f),a.morphTargetsRelative=!0,a})}function Ro(a,e){if(a.updateMorphTargets(),e.weights!==void 0)for(let t=0,s=e.weights.length;t<s;t++)a.morphTargetInfluences[t]=e.weights[t];if(e.extras&&Array.isArray(e.extras.targetNames)){const t=e.extras.targetNames;if(a.morphTargetInfluences.length===t.length){a.morphTargetDictionary={};for(let s=0,i=t.length;s<i;s++)a.morphTargetDictionary[t[s]]=s}else console.warn("THREE.GLTFLoader: Invalid extras.targetNames length. Ignoring names.")}}function Lo(a){let e;const t=a.extensions&&a.extensions[I.KHR_DRACO_MESH_COMPRESSION];if(t?e="draco:"+t.bufferView+":"+t.indices+":"+ws(t.attributes):e=a.indices+":"+ws(a.attributes)+":"+a.mode,a.targets!==void 0)for(let s=0,i=a.targets.length;s<i;s++)e+=":"+ws(a.targets[s]);return e}function ws(a){let e="";const t=Object.keys(a).sort();for(let s=0,i=t.length;s<i;s++)e+=t[s]+":"+a[t[s]]+";";return e}function Ws(a){switch(a){case Int8Array:return 1/127;case Uint8Array:return 1/255;case Int16Array:return 1/32767;case Uint16Array:return 1/65535;default:throw new Error("THREE.GLTFLoader: Unsupported normalized accessor component type.")}}function Io(a){return a.search(/\.jpe?g($|\?)/i)>0||a.search(/^data\:image\/jpeg/)===0?"image/jpeg":a.search(/\.webp($|\?)/i)>0||a.search(/^data\:image\/webp/)===0?"image/webp":a.search(/\.ktx2($|\?)/i)>0||a.search(/^data\:image\/ktx2/)===0?"image/ktx2":"image/png"}const Oo=new ee;class Do{constructor(e={},t={}){this.json=e,this.extensions={},this.plugins={},this.options=t,this.cache=new so,this.associations=new Map,this.primitiveCache={},this.nodeCache={},this.meshCache={refs:{},uses:{}},this.cameraCache={refs:{},uses:{}},this.lightCache={refs:{},uses:{}},this.sourceCache={},this.textureCache={},this.nodeNamesUsed={};let s=!1,i=-1,n=!1,r=-1;if(typeof navigator<"u"){const l=navigator.userAgent;s=/^((?!chrome|android).)*safari/i.test(l)===!0;const o=l.match(/Version\/(\d+)/);i=s&&o?parseInt(o[1],10):-1,n=l.indexOf("Firefox")>-1,r=n?l.match(/Firefox\/([0-9]+)\./)[1]:-1}typeof createImageBitmap>"u"||s&&i<17||n&&r<98?this.textureLoader=new ur(this.options.manager):this.textureLoader=new hr(this.options.manager),this.textureLoader.setCrossOrigin(this.options.crossOrigin),this.textureLoader.setRequestHeader(this.options.requestHeader),this.fileLoader=new Tn(this.options.manager),this.fileLoader.setResponseType("arraybuffer"),this.options.crossOrigin==="use-credentials"&&this.fileLoader.setWithCredentials(!0)}setExtensions(e){this.extensions=e}setPlugins(e){this.plugins=e}parse(e,t){const s=this,i=this.json,n=this.extensions;this.cache.removeAll(),this.nodeCache={},this._invokeAll(function(r){return r._markDefs&&r._markDefs()}),Promise.all(this._invokeAll(function(r){return r.beforeRoot&&r.beforeRoot()})).then(function(){return Promise.all([s.getDependencies("scene"),s.getDependencies("animation"),s.getDependencies("camera")])}).then(function(r){const l={scene:r[0][i.scene||0],scenes:r[0],animations:r[1],cameras:r[2],asset:i.asset,parser:s,userData:{}};return He(n,l,i),ge(l,i),Promise.all(s._invokeAll(function(o){return o.afterRoot&&o.afterRoot(l)})).then(function(){for(const o of l.scenes)o.updateMatrixWorld();e(l)})}).catch(t)}_markDefs(){const e=this.json.nodes||[],t=this.json.skins||[],s=this.json.meshes||[];for(let i=0,n=t.length;i<n;i++){const r=t[i].joints;for(let l=0,o=r.length;l<o;l++)e[r[l]].isBone=!0}for(let i=0,n=e.length;i<n;i++){const r=e[i];r.mesh!==void 0&&(this._addNodeRef(this.meshCache,r.mesh),r.skin!==void 0&&(s[r.mesh].isSkinnedMesh=!0)),r.camera!==void 0&&this._addNodeRef(this.cameraCache,r.camera)}}_addNodeRef(e,t){t!==void 0&&(e.refs[t]===void 0&&(e.refs[t]=e.uses[t]=0),e.refs[t]++)}_getNodeRef(e,t,s){if(e.refs[t]<=1)return s;const i=s.clone(),n=(r,l)=>{const o=this.associations.get(r);o!=null&&this.associations.set(l,o);for(const[c,u]of r.children.entries())n(u,l.children[c])};return n(s,i),i.name+="_instance_"+e.uses[t]++,i}_invokeOne(e){const t=Object.values(this.plugins);t.push(this);for(let s=0;s<t.length;s++){const i=e(t[s]);if(i)return i}return null}_invokeAll(e){const t=Object.values(this.plugins);t.unshift(this);const s=[];for(let i=0;i<t.length;i++){const n=e(t[i]);n&&s.push(n)}return s}getDependency(e,t){const s=e+":"+t;let i=this.cache.get(s);if(!i){switch(e){case"scene":i=this.loadScene(t);break;case"node":i=this._invokeOne(function(n){return n.loadNode&&n.loadNode(t)});break;case"mesh":i=this._invokeOne(function(n){return n.loadMesh&&n.loadMesh(t)});break;case"accessor":i=this.loadAccessor(t);break;case"bufferView":i=this._invokeOne(function(n){return n.loadBufferView&&n.loadBufferView(t)});break;case"buffer":i=this.loadBuffer(t);break;case"material":i=this._invokeOne(function(n){return n.loadMaterial&&n.loadMaterial(t)});break;case"texture":i=this._invokeOne(function(n){return n.loadTexture&&n.loadTexture(t)});break;case"skin":i=this.loadSkin(t);break;case"animation":i=this._invokeOne(function(n){return n.loadAnimation&&n.loadAnimation(t)});break;case"camera":i=this.loadCamera(t);break;default:if(i=this._invokeOne(function(n){return n!=this&&n.getDependency&&n.getDependency(e,t)}),!i)throw new Error("Unknown type: "+e);break}this.cache.add(s,i)}return i}getDependencies(e){let t=this.cache.get(e);if(!t){const s=this,i=this.json[e+(e==="mesh"?"es":"s")]||[];t=Promise.all(i.map(function(n,r){return s.getDependency(e,r)})),this.cache.add(e,t)}return t}loadBuffer(e){const t=this.json.buffers[e],s=this.fileLoader;if(t.type&&t.type!=="arraybuffer")throw new Error("THREE.GLTFLoader: "+t.type+" buffer type is not supported.");if(t.uri===void 0&&e===0)return Promise.resolve(this.extensions[I.KHR_BINARY_GLTF].body);const i=this.options;return new Promise(function(n,r){s.load(St.resolveURL(t.uri,i.path),n,void 0,function(){r(new Error('THREE.GLTFLoader: Failed to load buffer "'+t.uri+'".'))})})}loadBufferView(e){const t=this.json.bufferViews[e];return this.getDependency("buffer",t.buffer).then(function(s){const i=t.byteLength||0,n=t.byteOffset||0;return s.slice(n,n+i)})}loadAccessor(e){const t=this,s=this.json,i=this.json.accessors[e];if(i.bufferView===void 0&&i.sparse===void 0){const r=bs[i.type],l=ct[i.componentType],o=i.normalized===!0,c=new l(i.count*r);return Promise.resolve(new Ye(c,r,o))}const n=[];return i.bufferView!==void 0?n.push(this.getDependency("bufferView",i.bufferView)):n.push(null),i.sparse!==void 0&&(n.push(this.getDependency("bufferView",i.sparse.indices.bufferView)),n.push(this.getDependency("bufferView",i.sparse.values.bufferView))),Promise.all(n).then(function(r){const l=r[0],o=bs[i.type],c=ct[i.componentType],u=c.BYTES_PER_ELEMENT,h=u*o,f=i.byteOffset||0,d=i.bufferView!==void 0?s.bufferViews[i.bufferView].byteStride:void 0,x=i.normalized===!0;let w,S;if(d&&d!==h){const y=Math.floor(f/d),p="InterleavedBuffer:"+i.bufferView+":"+i.componentType+":"+y+":"+i.count;let m=t.cache.get(p);m||(w=new c(l,y*d,i.count*d/u),m=new fr(w,d/u),t.cache.add(p,m)),S=new Er(m,o,f%d/u,x)}else l===null?w=new c(i.count*o):w=new c(l,f,i.count*o),S=new Ye(w,o,x);if(i.sparse!==void 0){const y=bs.SCALAR,p=ct[i.sparse.indices.componentType],m=i.sparse.indices.byteOffset||0,g=i.sparse.values.byteOffset||0,b=new p(r[1],m,i.sparse.count*y),T=new c(r[2],g,i.sparse.count*o);l!==null&&(S=new Ye(S.array.slice(),S.itemSize,S.normalized)),S.normalized=!1;for(let P=0,A=b.length;P<A;P++){const C=b[P];if(S.setX(C,T[P*o]),o>=2&&S.setY(C,T[P*o+1]),o>=3&&S.setZ(C,T[P*o+2]),o>=4&&S.setW(C,T[P*o+3]),o>=5)throw new Error("THREE.GLTFLoader: Unsupported itemSize in sparse BufferAttribute.")}S.normalized=x}return S})}loadTexture(e){const t=this.json,s=this.options,n=t.textures[e].source,r=t.images[n];let l=this.textureLoader;if(r.uri){const o=s.manager.getHandler(r.uri);o!==null&&(l=o)}return this.loadTextureImage(e,n,l)}loadTextureImage(e,t,s){const i=this,n=this.json,r=n.textures[e],l=n.images[t],o=(l.uri||l.bufferView)+":"+r.sampler;if(this.textureCache[o])return this.textureCache[o];const c=this.loadImageSource(t,s).then(function(u){u.flipY=!1,u.name=r.name||l.name||"",u.name===""&&typeof l.uri=="string"&&l.uri.startsWith("data:image/")===!1&&(u.name=l.uri);const f=(n.samplers||{})[r.sampler]||{};return u.magFilter=Ri[f.magFilter]||Ys,u.minFilter=Ri[f.minFilter]||_n,u.wrapS=Li[f.wrapS]||Ks,u.wrapT=Li[f.wrapT]||Ks,u.generateMipmaps=!u.isCompressedTexture&&u.minFilter!==Mn&&u.minFilter!==Ys,i.associations.set(u,{textures:e}),u}).catch(function(){return null});return this.textureCache[o]=c,c}loadImageSource(e,t){const s=this,i=this.json,n=this.options;if(this.sourceCache[e]!==void 0)return this.sourceCache[e].then(h=>h.clone());const r=i.images[e],l=self.URL||self.webkitURL;let o=r.uri||"",c=!1;if(r.bufferView!==void 0)o=s.getDependency("bufferView",r.bufferView).then(function(h){c=!0;const f=new Blob([h],{type:r.mimeType});return o=l.createObjectURL(f),o});else if(r.uri===void 0)throw new Error("THREE.GLTFLoader: Image "+e+" is missing URI and bufferView");const u=Promise.resolve(o).then(function(h){return new Promise(function(f,d){let x=f;t.isImageBitmapLoader===!0&&(x=function(w){const S=new Si(w);S.needsUpdate=!0,f(S)}),t.load(St.resolveURL(h,n.path),x,void 0,d)})}).then(function(h){return c===!0&&l.revokeObjectURL(o),ge(h,r),h.userData.mimeType=r.mimeType||Io(r.uri),h}).catch(function(h){throw console.error("THREE.GLTFLoader: Couldn't load texture",o),h});return this.sourceCache[e]=u,u}assignTexture(e,t,s,i){const n=this;return this.getDependency("texture",s.index).then(function(r){if(!r)return null;if(s.texCoord!==void 0&&s.texCoord>0&&(r=r.clone(),r.channel=s.texCoord),n.extensions[I.KHR_TEXTURE_TRANSFORM]){const l=s.extensions!==void 0?s.extensions[I.KHR_TEXTURE_TRANSFORM]:void 0;if(l){const o=n.associations.get(r);r=n.extensions[I.KHR_TEXTURE_TRANSFORM].extendTexture(r,l),n.associations.set(r,o)}}return i!==void 0&&(r.colorSpace=i),e[t]=r,r})}assignFinalMaterial(e){const t=e.geometry;let s=e.material;const i=t.attributes.tangent===void 0,n=t.attributes.color!==void 0,r=t.attributes.normal===void 0;if(e.isPoints){const l="PointsMaterial:"+s.uuid;let o=this.cache.get(l);o||(o=new xr,ys.prototype.copy.call(o,s),o.color.copy(s.color),o.map=s.map,o.sizeAttenuation=!1,this.cache.add(l,o)),s=o}else if(e.isLine){const l="LineBasicMaterial:"+s.uuid;let o=this.cache.get(l);o||(o=new br,ys.prototype.copy.call(o,s),o.color.copy(s.color),o.map=s.map,this.cache.add(l,o)),s=o}if(i||n||r){let l="ClonedMaterial:"+s.uuid+":";i&&(l+="derivative-tangents:"),n&&(l+="vertex-colors:"),r&&(l+="flat-shading:");let o=this.cache.get(l);o||(o=s.clone(),n&&(o.vertexColors=!0),r&&(o.flatShading=!0),i&&(o.normalScale&&(o.normalScale.y*=-1),o.clearcoatNormalScale&&(o.clearcoatNormalScale.y*=-1)),this.cache.add(l,o),this.associations.set(o,this.associations.get(s))),s=o}e.material=s}getMaterialType(){return O}loadMaterial(e){const t=this,s=this.json,i=this.extensions,n=s.materials[e];let r;const l={},o=n.extensions||{},c=[];if(o[I.KHR_MATERIALS_UNLIT]){const h=i[I.KHR_MATERIALS_UNLIT];r=h.getMaterialType(),c.push(h.extendParams(l,n,t))}else{const h=n.pbrMetallicRoughness||{};if(l.color=new Be(1,1,1),l.opacity=1,Array.isArray(h.baseColorFactor)){const f=h.baseColorFactor;l.color.setRGB(f[0],f[1],f[2],Ae),l.opacity=f[3]}h.baseColorTexture!==void 0&&c.push(t.assignTexture(l,"map",h.baseColorTexture,Mt)),l.metalness=h.metallicFactor!==void 0?h.metallicFactor:1,l.roughness=h.roughnessFactor!==void 0?h.roughnessFactor:1,h.metallicRoughnessTexture!==void 0&&(c.push(t.assignTexture(l,"metalnessMap",h.metallicRoughnessTexture)),c.push(t.assignTexture(l,"roughnessMap",h.metallicRoughnessTexture))),r=this._invokeOne(function(f){return f.getMaterialType&&f.getMaterialType(e)}),c.push(Promise.all(this._invokeAll(function(f){return f.extendMaterialParams&&f.extendMaterialParams(e,l)})))}n.doubleSided===!0&&(l.side=k);const u=n.alphaMode||Ss.OPAQUE;if(u===Ss.BLEND?(l.transparent=!0,l.depthWrite=!1):(l.transparent=!1,u===Ss.MASK&&(l.alphaTest=n.alphaCutoff!==void 0?n.alphaCutoff:.5)),n.normalTexture!==void 0&&r!==H&&(c.push(t.assignTexture(l,"normalMap",n.normalTexture)),l.normalScale=new q(1,1),n.normalTexture.scale!==void 0)){const h=n.normalTexture.scale;l.normalScale.set(h,h)}if(n.occlusionTexture!==void 0&&r!==H&&(c.push(t.assignTexture(l,"aoMap",n.occlusionTexture)),n.occlusionTexture.strength!==void 0&&(l.aoMapIntensity=n.occlusionTexture.strength)),n.emissiveFactor!==void 0&&r!==H){const h=n.emissiveFactor;l.emissive=new Be().setRGB(h[0],h[1],h[2],Ae)}return n.emissiveTexture!==void 0&&r!==H&&c.push(t.assignTexture(l,"emissiveMap",n.emissiveTexture,Mt)),Promise.all(c).then(function(){const h=new r(l);return n.name&&(h.name=n.name),ge(h,n),t.associations.set(h,{materials:e}),n.extensions&&He(i,h,n),h})}createUniqueName(e){const t=Sr.sanitizeNodeName(e||"");return t in this.nodeNamesUsed?t+"_"+ ++this.nodeNamesUsed[t]:(this.nodeNamesUsed[t]=0,t)}loadGeometries(e){const t=this,s=this.extensions,i=this.primitiveCache;function n(l){return s[I.KHR_DRACO_MESH_COMPRESSION].decodePrimitive(l,t).then(function(o){return Ii(o,l,t)})}const r=[];for(let l=0,o=e.length;l<o;l++){const c=e[l],u=Lo(c),h=i[u];if(h)r.push(h.promise);else{let f;c.extensions&&c.extensions[I.KHR_DRACO_MESH_COMPRESSION]?f=n(c):f=Ii(new At,c,t),i[u]={primitive:c,promise:f},r.push(f)}}return Promise.all(r)}loadMesh(e){const t=this,s=this.json,i=this.extensions,n=s.meshes[e],r=n.primitives,l=[];for(let o=0,c=r.length;o<c;o++){const u=r[o].material===void 0?Eo(this.cache):this.getDependency("material",r[o].material);l.push(u)}return l.push(t.loadGeometries(r)),Promise.all(l).then(function(o){const c=o.slice(0,o.length-1),u=o[o.length-1],h=[];for(let d=0,x=u.length;d<x;d++){const w=u[d],S=r[d];let y;const p=c[d];if(S.mode===oe.TRIANGLES||S.mode===oe.TRIANGLE_STRIP||S.mode===oe.TRIANGLE_FAN||S.mode===void 0)y=n.isSkinnedMesh===!0?new wr(w,p):new D(w,p),y.isSkinnedMesh===!0&&y.normalizeSkinWeights(),S.mode===oe.TRIANGLE_STRIP?y.geometry=Ei(y.geometry,Pn):S.mode===oe.TRIANGLE_FAN&&(y.geometry=Ei(y.geometry,Vs));else if(S.mode===oe.LINES)y=new Pr(w,p);else if(S.mode===oe.LINE_STRIP)y=new _t(w,p);else if(S.mode===oe.LINE_LOOP)y=new Tr(w,p);else if(S.mode===oe.POINTS)y=new Ar(w,p);else throw new Error("THREE.GLTFLoader: Primitive mode unsupported: "+S.mode);Object.keys(y.geometry.morphAttributes).length>0&&Ro(y,n),y.name=t.createUniqueName(n.name||"mesh_"+e),ge(y,n),S.extensions&&He(i,y,S),t.assignFinalMaterial(y),h.push(y)}for(let d=0,x=h.length;d<x;d++)t.associations.set(h[d],{meshes:e,primitives:d});if(h.length===1)return n.extensions&&He(i,h[0],n),h[0];const f=new De;n.extensions&&He(i,f,n),t.associations.set(f,{meshes:e});for(let d=0,x=h.length;d<x;d++)f.add(h[d]);return f})}loadCamera(e){let t;const s=this.json.cameras[e],i=s[s.type];if(!i){console.warn("THREE.GLTFLoader: Missing camera parameters.");return}return s.type==="perspective"?t=new ai(wn.radToDeg(i.yfov),i.aspectRatio||1,i.znear||1,i.zfar||2e6):s.type==="orthographic"&&(t=new Ee(-i.xmag,i.xmag,i.ymag,-i.ymag,i.znear,i.zfar)),s.name&&(t.name=this.createUniqueName(s.name)),ge(t,s),Promise.resolve(t)}loadSkin(e){const t=this.json.skins[e],s=[];for(let i=0,n=t.joints.length;i<n;i++)s.push(this._loadNodeShallow(t.joints[i]));return t.inverseBindMatrices!==void 0?s.push(this.getDependency("accessor",t.inverseBindMatrices)):s.push(null),Promise.all(s).then(function(i){const n=i.pop(),r=i,l=[],o=[];for(let c=0,u=r.length;c<u;c++){const h=r[c];if(h){l.push(h);const f=new ee;n!==null&&f.fromArray(n.array,c*16),o.push(f)}else console.warn('THREE.GLTFLoader: Joint "%s" could not be found.',t.joints[c])}return new _r(l,o)})}loadAnimation(e){const t=this.json,s=this,i=t.animations[e],n=i.name?i.name:"animation_"+e,r=[],l=[],o=[],c=[],u=[];for(let h=0,f=i.channels.length;h<f;h++){const d=i.channels[h],x=i.samplers[d.sampler],w=d.target,S=w.node,y=i.parameters!==void 0?i.parameters[x.input]:x.input,p=i.parameters!==void 0?i.parameters[x.output]:x.output;w.node!==void 0&&(r.push(this.getDependency("node",S)),l.push(this.getDependency("accessor",y)),o.push(this.getDependency("accessor",p)),c.push(x),u.push(w))}return Promise.all([Promise.all(r),Promise.all(l),Promise.all(o),Promise.all(c),Promise.all(u)]).then(function(h){const f=h[0],d=h[1],x=h[2],w=h[3],S=h[4],y=[];for(let m=0,g=f.length;m<g;m++){const b=f[m],T=d[m],P=x[m],A=w[m],C=S[m];if(b===void 0)continue;b.updateMatrix&&b.updateMatrix();const _=s._createAnimationTracks(b,T,P,A,C);if(_)for(let E=0;E<_.length;E++)y.push(_[E])}const p=new Mr(n,void 0,y);return ge(p,i),p})}createNodeMesh(e){const t=this.json,s=this,i=t.nodes[e];return i.mesh===void 0?null:s.getDependency("mesh",i.mesh).then(function(n){const r=s._getNodeRef(s.meshCache,i.mesh,n);return i.weights!==void 0&&r.traverse(function(l){if(l.isMesh)for(let o=0,c=i.weights.length;o<c;o++)l.morphTargetInfluences[o]=i.weights[o]}),r})}loadNode(e){const t=this.json,s=this,i=t.nodes[e],n=s._loadNodeShallow(e),r=[],l=i.children||[];for(let c=0,u=l.length;c<u;c++)r.push(s.getDependency("node",l[c]));const o=i.skin===void 0?Promise.resolve(null):s.getDependency("skin",i.skin);return Promise.all([n,Promise.all(r),o]).then(function(c){const u=c[0],h=c[1],f=c[2];f!==null&&u.traverse(function(d){d.isSkinnedMesh&&d.bind(f,Oo)});for(let d=0,x=h.length;d<x;d++)u.add(h[d]);return u})}_loadNodeShallow(e){const t=this.json,s=this.extensions,i=this;if(this.nodeCache[e]!==void 0)return this.nodeCache[e];const n=t.nodes[e],r=n.name?i.createUniqueName(n.name):"",l=[],o=i._invokeOne(function(c){return c.createNodeMesh&&c.createNodeMesh(e)});return o&&l.push(o),n.camera!==void 0&&l.push(i.getDependency("camera",n.camera).then(function(c){return i._getNodeRef(i.cameraCache,n.camera,c)})),i._invokeAll(function(c){return c.createNodeAttachment&&c.createNodeAttachment(e)}).forEach(function(c){l.push(c)}),this.nodeCache[e]=Promise.all(l).then(function(c){let u;if(n.isBone===!0?u=new Cr:c.length>1?u=new De:c.length===1?u=c[0]:u=new An,u!==c[0])for(let h=0,f=c.length;h<f;h++)u.add(c[h]);if(n.name&&(u.userData.name=n.name,u.name=r),ge(u,n),n.extensions&&He(s,u,n),n.matrix!==void 0){const h=new ee;h.fromArray(n.matrix),u.applyMatrix4(h)}else n.translation!==void 0&&u.position.fromArray(n.translation),n.rotation!==void 0&&u.quaternion.fromArray(n.rotation),n.scale!==void 0&&u.scale.fromArray(n.scale);if(!i.associations.has(u))i.associations.set(u,{});else if(n.mesh!==void 0&&i.meshCache.refs[n.mesh]>1){const h=i.associations.get(u);i.associations.set(u,{...h})}return i.associations.get(u).nodes=e,u}),this.nodeCache[e]}loadScene(e){const t=this.extensions,s=this.json.scenes[e],i=this,n=new De;s.name&&(n.name=i.createUniqueName(s.name)),ge(n,s),s.extensions&&He(t,n,s);const r=s.nodes||[],l=[];for(let o=0,c=r.length;o<c;o++)l.push(i.getDependency("node",r[o]));return Promise.all(l).then(function(o){for(let u=0,h=o.length;u<h;u++)n.add(o[u]);const c=u=>{const h=new Map;for(const[f,d]of i.associations)(f instanceof ys||f instanceof Si)&&h.set(f,d);return u.traverse(f=>{const d=i.associations.get(f);d!=null&&h.set(f,d)}),h};return i.associations=c(n),n})}_createAnimationTracks(e,t,s,i,n){const r=[],l=e.name?e.name:e.uuid,o=[];Me[n.path]===Me.weights?e.traverse(function(f){f.morphTargetInfluences&&o.push(f.name?f.name:f.uuid)}):o.push(l);let c;switch(Me[n.path]){case Me.weights:c=Pi;break;case Me.rotation:c=Ti;break;case Me.translation:case Me.scale:c=wi;break;default:s.itemSize===1?c=Pi:c=wi;break}const u=i.interpolation!==void 0?vo[i.interpolation]:Cn,h=this._getArrayFromAccessor(s);for(let f=0,d=o.length;f<d;f++){const x=new c(o[f]+"."+Me[n.path],t.array,h,u);i.interpolation==="CUBICSPLINE"&&this._createCubicSplineTrackInterpolant(x),r.push(x)}return r}_getArrayFromAccessor(e){let t=e.array;if(e.normalized){const s=Ws(t.constructor),i=new Float32Array(t.length);for(let n=0,r=t.length;n<r;n++)i[n]=t[n]*s;t=i}return t}_createCubicSplineTrackInterpolant(e){e.createInterpolant=function(s){const i=this instanceof Ti?Co:Rn;return new i(this.times,this.values,this.getValueSize()/3,s)},e.createInterpolant.isInterpolantFactoryMethodGLTFCubicSpline=!0}}function Bo(a,e,t){const s=e.attributes,i=new he;if(s.POSITION!==void 0){const l=t.json.accessors[s.POSITION],o=l.min,c=l.max;if(o!==void 0&&c!==void 0){if(i.set(new v(o[0],o[1],o[2]),new v(c[0],c[1],c[2])),l.normalized){const u=Ws(ct[l.componentType]);i.min.multiplyScalar(u),i.max.multiplyScalar(u)}}else{console.warn("THREE.GLTFLoader: Missing min/max properties for accessor POSITION.");return}}else return;const n=e.targets;if(n!==void 0){const l=new v,o=new v;for(let c=0,u=n.length;c<u;c++){const h=n[c];if(h.POSITION!==void 0){const f=t.json.accessors[h.POSITION],d=f.min,x=f.max;if(d!==void 0&&x!==void 0){if(o.setX(Math.max(Math.abs(d[0]),Math.abs(x[0]))),o.setY(Math.max(Math.abs(d[1]),Math.abs(x[1]))),o.setZ(Math.max(Math.abs(d[2]),Math.abs(x[2]))),f.normalized){const w=Ws(ct[f.componentType]);o.multiplyScalar(w)}l.max(o)}else console.warn("THREE.GLTFLoader: Missing min/max properties for accessor POSITION.")}}i.expandByVector(l)}a.boundingBox=i;const r=new Rr;i.getCenter(r.center),r.radius=i.min.distanceTo(i.max)/2,a.boundingSphere=r}function Ii(a,e,t){const s=e.attributes,i=[];function n(r,l){return t.getDependency("accessor",r).then(function(o){a.setAttribute(l,o)})}for(const r in s){const l=$s[r]||r.toLowerCase();l in a.attributes||i.push(n(s[r],l))}if(e.indices!==void 0&&!a.index){const r=t.getDependency("accessor",e.indices).then(function(l){a.setIndex(l)});i.push(r)}return Ai.workingColorSpace!==Ae&&"COLOR_0"in s&&console.warn(`THREE.GLTFLoader: Converting vertex colors from "srgb-linear" to "${Ai.workingColorSpace}" not supported.`),ge(a,e),Bo(a,e,t),Promise.all(i).then(function(){return e.targets!==void 0?zo(a,e.targets,t):a})}class No{constructor(){this.loader=new to}async loadModel(e,t={}){return new Promise((s,i)=>{console.log(`üì¶ Loading model from: ${e}`),t.decolorize&&console.log("   ‚Üí Will apply decolorized materials (white/gray)"),this.loader.load(e,n=>{const r=n.scene,l=new he().setFromObject(r),o=l.getCenter(new v);r.position.sub(o);const c=l.getSize(new v),f=2/Math.max(c.x,c.y,c.z);r.scale.setScalar(f),r.traverse(d=>{if(d.isMesh){if(d.castShadow=!0,d.receiveShadow=!0,t.decolorize&&d.material){const x=d.material.clone();if(x.color){const w=x.color.r*.299+x.color.g*.587+x.color.b*.114,S=Math.min(w+.3,1);x.color.setRGB(S,S,S)}d.material=x}d.material&&(d.material.side=k)}}),console.log("‚úÖ Model loaded successfully"),console.log(`   - Original size: ${c.x.toFixed(2)} x ${c.y.toFixed(2)} x ${c.z.toFixed(2)}`),console.log(`   - Scale factor: ${f.toFixed(2)}`),console.log(`   - Meshes: ${this.countMeshes(r)}`),t.decolorize&&console.log("   - Materials: Decolorized (white/gray)"),s(r)},n=>{if(n.total>0){const r=(n.loaded/n.total*100).toFixed(0);console.log(`‚è≥ Loading model: ${r}%`)}},n=>{console.error("‚ùå Error loading model:",n),i(n)})})}countMeshes(e){let t=0;return e.traverse(s=>{s.isMesh&&t++}),t}decolorizeModel(e){const t=e.clone();return t.traverse(s=>{if(s.isMesh&&s.material){const i=s.material.clone();if(i.color){const n=i.color.r*.299+i.color.g*.587+i.color.b*.114;i.color.setRGB(n,n,n)}i.transparent&&(i.opacity*=.8),s.material=i}}),t}}const Ln=0,Ho=1,Fo=2,Oi=2,Ps=1.25,Di=1,W=32,Y=W/4,In=65535,Jt=Math.pow(2,-24),ci=Symbol("SKIP_GENERATION"),On={strategy:Ln,maxDepth:40,maxLeafSize:10,useSharedArrayBuffer:!1,setBoundingBox:!0,onProgress:null,indirect:!1,verbose:!0,range:null,[ci]:!1};function U(a,e,t){return t.min.x=e[a],t.min.y=e[a+1],t.min.z=e[a+2],t.max.x=e[a+3],t.max.y=e[a+4],t.max.z=e[a+5],t}function Bi(a){let e=-1,t=-1/0;for(let s=0;s<3;s++){const i=a[s+3]-a[s];i>t&&(t=i,e=s)}return e}function Ni(a,e){e.set(a)}function Hi(a,e,t){let s,i;for(let n=0;n<3;n++){const r=n+3;s=a[n],i=e[n],t[n]=s<i?s:i,s=a[r],i=e[r],t[r]=s>i?s:i}}function zt(a,e,t){for(let s=0;s<3;s++){const i=e[a+2*s],n=e[a+2*s+1],r=i-n,l=i+n;r<t[s]&&(t[s]=r),l>t[s+3]&&(t[s+3]=l)}}function ft(a){const e=a[3]-a[0],t=a[4]-a[1],s=a[5]-a[2];return 2*(e*t+t*s+s*e)}function K(a,e){return e[a+15]===In}function Z(a,e){return e[a+6]}function J(a,e){return e[a+14]}function X(a){return a+Y}function $(a,e){const t=e[a+6];return a+t*Y}function ui(a,e){return e[a+7]}function Ts(a,e,t,s,i){let n=1/0,r=1/0,l=1/0,o=-1/0,c=-1/0,u=-1/0,h=1/0,f=1/0,d=1/0,x=-1/0,w=-1/0,S=-1/0;const y=a.offset||0;for(let p=(e-y)*6,m=(e+t-y)*6;p<m;p+=6){const g=a[p+0],b=a[p+1],T=g-b,P=g+b;T<n&&(n=T),P>o&&(o=P),g<h&&(h=g),g>x&&(x=g);const A=a[p+2],C=a[p+3],_=A-C,E=A+C;_<r&&(r=_),E>c&&(c=E),A<f&&(f=A),A>w&&(w=A);const M=a[p+4],z=a[p+5],R=M-z,L=M+z;R<l&&(l=R),L>u&&(u=L),M<d&&(d=M),M>S&&(S=M)}s[0]=n,s[1]=r,s[2]=l,s[3]=o,s[4]=c,s[5]=u,i[0]=h,i[1]=f,i[2]=d,i[3]=x,i[4]=w,i[5]=S}const Pe=32,ko=(a,e)=>a.candidate-e.candidate,Ce=new Array(Pe).fill().map(()=>({count:0,bounds:new Float32Array(6),rightCacheBounds:new Float32Array(6),leftCacheBounds:new Float32Array(6),candidate:0})),Rt=new Float32Array(6);function qo(a,e,t,s,i,n){let r=-1,l=0;if(n===Ln)r=Bi(e),r!==-1&&(l=(e[r]+e[r+3])/2);else if(n===Ho)r=Bi(a),r!==-1&&(l=Uo(t,s,i,r));else if(n===Fo){const o=ft(a);let c=Ps*i;const u=t.offset||0,h=(s-u)*6,f=(s+i-u)*6;for(let d=0;d<3;d++){const x=e[d],y=(e[d+3]-x)/Pe;if(i<Pe/4){const p=[...Ce];p.length=i;let m=0;for(let b=h;b<f;b+=6,m++){const T=p[m];T.candidate=t[b+2*d],T.count=0;const{bounds:P,leftCacheBounds:A,rightCacheBounds:C}=T;for(let _=0;_<3;_++)C[_]=1/0,C[_+3]=-1/0,A[_]=1/0,A[_+3]=-1/0,P[_]=1/0,P[_+3]=-1/0;zt(b,t,P)}p.sort(ko);let g=i;for(let b=0;b<g;b++){const T=p[b];for(;b+1<g&&p[b+1].candidate===T.candidate;)p.splice(b+1,1),g--}for(let b=h;b<f;b+=6){const T=t[b+2*d];for(let P=0;P<g;P++){const A=p[P];T>=A.candidate?zt(b,t,A.rightCacheBounds):(zt(b,t,A.leftCacheBounds),A.count++)}}for(let b=0;b<g;b++){const T=p[b],P=T.count,A=i-T.count,C=T.leftCacheBounds,_=T.rightCacheBounds;let E=0;P!==0&&(E=ft(C)/o);let M=0;A!==0&&(M=ft(_)/o);const z=Di+Ps*(E*P+M*A);z<c&&(r=d,c=z,l=T.candidate)}}else{for(let g=0;g<Pe;g++){const b=Ce[g];b.count=0,b.candidate=x+y+g*y;const T=b.bounds;for(let P=0;P<3;P++)T[P]=1/0,T[P+3]=-1/0}for(let g=h;g<f;g+=6){let P=~~((t[g+2*d]-x)/y);P>=Pe&&(P=Pe-1);const A=Ce[P];A.count++,zt(g,t,A.bounds)}const p=Ce[Pe-1];Ni(p.bounds,p.rightCacheBounds);for(let g=Pe-2;g>=0;g--){const b=Ce[g],T=Ce[g+1];Hi(b.bounds,T.rightCacheBounds,b.rightCacheBounds)}let m=0;for(let g=0;g<Pe-1;g++){const b=Ce[g],T=b.count,P=b.bounds,C=Ce[g+1].rightCacheBounds;T!==0&&(m===0?Ni(P,Rt):Hi(P,Rt,Rt)),m+=T;let _=0,E=0;m!==0&&(_=ft(Rt)/o);const M=i-m;M!==0&&(E=ft(C)/o);const z=Di+Ps*(_*m+E*M);z<c&&(r=d,c=z,l=b.candidate)}}}}else console.warn(`BVH: Invalid build strategy value ${n} used.`);return{axis:r,pos:l}}function Uo(a,e,t,s){let i=0;const n=a.offset;for(let r=e,l=e+t;r<l;r++)i+=a[(r-n)*6+s*2];return i/t}class As{constructor(){this.boundingData=new Float32Array(6)}}function Go(a,e,t,s,i,n){let r=s,l=s+i-1;const o=n.pos,c=n.axis*2,u=t.offset||0;for(;;){for(;r<=l&&t[(r-u)*6+c]<o;)r++;for(;r<=l&&t[(l-u)*6+c]>=o;)l--;if(r<l){for(let h=0;h<e;h++){let f=a[r*e+h];a[r*e+h]=a[l*e+h],a[l*e+h]=f}for(let h=0;h<6;h++){const f=r-u,d=l-u,x=t[f*6+h];t[f*6+h]=t[d*6+h],t[d*6+h]=x}r++,l--}else return r}}let Dn,es,Zs,Bn;const jo=Math.pow(2,32);function Qs(a){return"count"in a?1:1+Qs(a.left)+Qs(a.right)}function Vo(a,e,t){return Dn=new Float32Array(t),es=new Uint32Array(t),Zs=new Uint16Array(t),Bn=new Uint8Array(t),Js(a,e)}function Js(a,e){const t=a/4,s=a/2,i="count"in e,n=e.boundingData;for(let r=0;r<6;r++)Dn[t+r]=n[r];if(i)return e.buffer?(Bn.set(new Uint8Array(e.buffer),a),a+e.buffer.byteLength):(es[t+6]=e.offset,Zs[s+14]=e.count,Zs[s+15]=In,a+W);{const{left:r,right:l,splitAxis:o}=e,c=a+W;let u=Js(c,r);const h=a/W,d=u/W-h;if(d>jo)throw new Error("MeshBVH: Cannot store relative child node offset greater than 32 bits.");return es[t+6]=d,es[t+7]=o,Js(u,l)}}function Yo(a,e,t,s,i){const{maxDepth:n,verbose:r,maxLeafSize:l,strategy:o,onProgress:c}=i,u=a.primitiveBuffer,h=a.primitiveBufferStride,f=new Float32Array(6);let d=!1;const x=new As;return Ts(e,t,s,x.boundingData,f),S(x,t,s,f),x;function w(y){c&&c(y/s)}function S(y,p,m,g=null,b=0){if(!d&&b>=n&&(d=!0,r&&console.warn(`BVH: Max depth of ${n} reached when generating BVH. Consider increasing maxDepth.`)),m<=l||b>=n)return w(p+m),y.offset=p,y.count=m,y;const T=qo(y.boundingData,g,e,p,m,o);if(T.axis===-1)return w(p+m),y.offset=p,y.count=m,y;const P=Go(u,h,e,p,m,T);if(P===p||P===p+m)w(p+m),y.offset=p,y.count=m;else{y.splitAxis=T.axis;const A=new As,C=p,_=P-p;y.left=A,Ts(e,C,_,A.boundingData,f),S(A,C,_,f,b+1);const E=new As,M=P,z=m-_;y.right=E,Ts(e,M,z,E.boundingData,f),S(E,M,z,f,b+1)}return y}}function Ko(a,e){const t=e.useSharedArrayBuffer?SharedArrayBuffer:ArrayBuffer,s=a.getRootRanges(e.range),i=s[0],n=s[s.length-1],r={offset:i.offset,count:n.offset+n.count-i.offset},l=new Float32Array(6*r.count);l.offset=r.offset,a.computePrimitiveBounds(r.offset,r.count,l),a._roots=s.map(o=>{const c=Yo(a,l,o.offset,o.count,e),u=Qs(c),h=new t(W*u);return Vo(0,c,h),h})}class hi{constructor(e){this._getNewPrimitive=e,this._primitives=[]}getPrimitive(){const e=this._primitives;return e.length===0?this._getNewPrimitive():e.pop()}releasePrimitive(e){this._primitives.push(e)}}class Xo{constructor(){this.float32Array=null,this.uint16Array=null,this.uint32Array=null;const e=[];let t=null;this.setBuffer=s=>{t&&e.push(t),t=s,this.float32Array=new Float32Array(s),this.uint16Array=new Uint16Array(s),this.uint32Array=new Uint32Array(s)},this.clearBuffer=()=>{t=null,this.float32Array=null,this.uint16Array=null,this.uint32Array=null,e.length!==0&&this.setBuffer(e.pop())}}}const F=new Xo;let Ie,ot;const Ze=[],Lt=new hi(()=>new he);function $o(a,e,t,s,i,n){Ie=Lt.getPrimitive(),ot=Lt.getPrimitive(),Ze.push(Ie,ot),F.setBuffer(a._roots[e]);const r=ei(0,a.geometry,t,s,i,n);F.clearBuffer(),Lt.releasePrimitive(Ie),Lt.releasePrimitive(ot),Ze.pop(),Ze.pop();const l=Ze.length;return l>0&&(ot=Ze[l-1],Ie=Ze[l-2]),r}function ei(a,e,t,s,i=null,n=0,r=0){const{float32Array:l,uint16Array:o,uint32Array:c}=F;let u=a*2;if(K(u,o)){const f=Z(a,c),d=J(u,o);return U(a,l,Ie),s(f,d,!1,r,n+a/Y,Ie)}else{let _=function(M){const{uint16Array:z,uint32Array:R}=F;let L=M*2;for(;!K(L,z);)M=X(M),L=M*2;return Z(M,R)},E=function(M){const{uint16Array:z,uint32Array:R}=F;let L=M*2;for(;!K(L,z);)M=$(M,R),L=M*2;return Z(M,R)+J(L,z)};const f=X(a),d=$(a,c);let x=f,w=d,S,y,p,m;if(i&&(p=Ie,m=ot,U(x,l,p),U(w,l,m),S=i(p),y=i(m),y<S)){x=d,w=f;const M=S;S=y,y=M,p=m}p||(p=Ie,U(x,l,p));const g=K(x*2,o),b=t(p,g,S,r+1,n+x/Y);let T;if(b===Oi){const M=_(x),R=E(x)-M;T=s(M,R,!0,r+1,n+x/Y,p)}else T=b&&ei(x,e,t,s,i,n,r+1);if(T)return!0;m=ot,U(w,l,m);const P=K(w*2,o),A=t(m,P,y,r+1,n+w/Y);let C;if(A===Oi){const M=_(w),R=E(w)-M;C=s(M,R,!0,r+1,n+w/Y,m)}else C=A&&ei(w,e,t,s,i,n,r+1);return!!C}}const wt=new F.constructor,rs=new F.constructor,ze=new hi(()=>new he),Qe=new he,Je=new he,_s=new he,Ms=new he;let Cs=!1;function Wo(a,e,t,s){if(Cs)throw new Error("MeshBVH: Recursive calls to bvhcast not supported.");Cs=!0;const i=a._roots,n=e._roots;let r,l=0,o=0;const c=new ee().copy(t).invert();for(let u=0,h=i.length;u<h;u++){wt.setBuffer(i[u]),o=0;const f=ze.getPrimitive();U(0,wt.float32Array,f),f.applyMatrix4(c);for(let d=0,x=n.length;d<x&&(rs.setBuffer(n[d]),r=de(0,0,t,c,s,l,o,0,0,f),rs.clearBuffer(),o+=n[d].byteLength/W,!r);d++);if(ze.releasePrimitive(f),wt.clearBuffer(),l+=i[u].byteLength/W,r)break}return Cs=!1,r}function de(a,e,t,s,i,n=0,r=0,l=0,o=0,c=null,u=!1){let h,f;u?(h=rs,f=wt):(h=wt,f=rs);const d=h.float32Array,x=h.uint32Array,w=h.uint16Array,S=f.float32Array,y=f.uint32Array,p=f.uint16Array,m=a*2,g=e*2,b=K(m,w),T=K(g,p);let P=!1;if(T&&b)u?P=i(Z(e,y),J(e*2,p),Z(a,x),J(a*2,w),o,r+e/Y,l,n+a/Y):P=i(Z(a,x),J(a*2,w),Z(e,y),J(e*2,p),l,n+a/Y,o,r+e/Y);else if(T){const A=ze.getPrimitive();U(e,S,A),A.applyMatrix4(t);const C=X(a),_=$(a,x);U(C,d,Qe),U(_,d,Je);const E=A.intersectsBox(Qe),M=A.intersectsBox(Je);P=E&&de(e,C,s,t,i,r,n,o,l+1,A,!u)||M&&de(e,_,s,t,i,r,n,o,l+1,A,!u),ze.releasePrimitive(A)}else{const A=X(e),C=$(e,y);U(A,S,_s),U(C,S,Ms);const _=c.intersectsBox(_s),E=c.intersectsBox(Ms);if(_&&E)P=de(a,A,t,s,i,n,r,l,o+1,c,u)||de(a,C,t,s,i,n,r,l,o+1,c,u);else if(_)if(b)P=de(a,A,t,s,i,n,r,l,o+1,c,u);else{const M=ze.getPrimitive();M.copy(_s).applyMatrix4(t);const z=X(a),R=$(a,x);U(z,d,Qe),U(R,d,Je);const L=M.intersectsBox(Qe),B=M.intersectsBox(Je);P=L&&de(A,z,s,t,i,r,n,o,l+1,M,!u)||B&&de(A,R,s,t,i,r,n,o,l+1,M,!u),ze.releasePrimitive(M)}else if(E)if(b)P=de(a,C,t,s,i,n,r,l,o+1,c,u);else{const M=ze.getPrimitive();M.copy(Ms).applyMatrix4(t);const z=X(a),R=$(a,x);U(z,d,Qe),U(R,d,Je);const L=M.intersectsBox(Qe),B=M.intersectsBox(Je);P=L&&de(C,z,s,t,i,r,n,o,l+1,M,!u)||B&&de(C,R,s,t,i,r,n,o,l+1,M,!u),ze.releasePrimitive(M)}}return P}const Fi=new he,et=new Float32Array(6);class Zo{constructor(){this._roots=null,this.primitiveBuffer=null,this.primitiveBufferStride=null}init(e){e={...On,...e},Ko(this,e)}getRootRanges(){throw new Error("BVH: getRootRanges() not implemented")}writePrimitiveBounds(){throw new Error("BVH: writePrimitiveBounds() not implemented")}writePrimitiveRangeBounds(e,t,s,i){let n=1/0,r=1/0,l=1/0,o=-1/0,c=-1/0,u=-1/0;for(let h=e,f=e+t;h<f;h++){this.writePrimitiveBounds(h,et,0);const[d,x,w,S,y,p]=et;d<n&&(n=d),S>o&&(o=S),x<r&&(r=x),y>c&&(c=y),w<l&&(l=w),p>u&&(u=p)}return s[i+0]=n,s[i+1]=r,s[i+2]=l,s[i+3]=o,s[i+4]=c,s[i+5]=u,s}computePrimitiveBounds(e,t,s){const i=s.offset||0;for(let n=e,r=e+t;n<r;n++){this.writePrimitiveBounds(n,et,0);const[l,o,c,u,h,f]=et,d=(l+u)/2,x=(o+h)/2,w=(c+f)/2,S=(u-l)/2,y=(h-o)/2,p=(f-c)/2,m=(n-i)*6;s[m+0]=d,s[m+1]=S+(Math.abs(d)+S)*Jt,s[m+2]=x,s[m+3]=y+(Math.abs(x)+y)*Jt,s[m+4]=w,s[m+5]=p+(Math.abs(w)+p)*Jt}return s}shiftPrimitiveOffsets(e){const t=this._indirectBuffer;if(t)for(let s=0,i=t.length;s<i;s++)t[s]+=e;else{const s=this._roots;for(let i=0;i<s.length;i++){const n=s[i],r=new Uint32Array(n),l=new Uint16Array(n),o=n.byteLength/W;for(let c=0;c<o;c++){const u=Y*c,h=2*u;K(h,l)&&(r[u+6]+=e)}}}}traverse(e,t=0){const s=this._roots[t],i=new Uint32Array(s),n=new Uint16Array(s);r(0);function r(l,o=0){const c=l*2,u=K(c,n);if(u){const h=i[l+6],f=n[c+14];e(o,u,new Float32Array(s,l*4,6),h,f)}else{const h=X(l),f=$(l,i),d=ui(l,i);e(o,u,new Float32Array(s,l*4,6),d)||(r(h,o+1),r(f,o+1))}}}refit(){const e=this._roots;for(let t=0,s=e.length;t<s;t++){const i=e[t],n=new Uint32Array(i),r=new Uint16Array(i),l=new Float32Array(i),o=i.byteLength/W;for(let c=o-1;c>=0;c--){const u=c*Y,h=u*2;if(K(h,r)){const d=Z(u,n),x=J(h,r);this.writePrimitiveRangeBounds(d,x,et,0),l.set(et,u)}else{const d=X(u),x=$(u,n);for(let w=0;w<3;w++){const S=l[d+w],y=l[d+w+3],p=l[x+w],m=l[x+w+3];l[u+w]=S<p?S:p,l[u+w+3]=y>m?y:m}}}}}getBoundingBox(e){return e.makeEmpty(),this._roots.forEach(s=>{U(0,new Float32Array(s),Fi),e.union(Fi)}),e}shapecast(e){let{boundsTraverseOrder:t,intersectsBounds:s,intersectsRange:i,intersectsPrimitive:n,scratchPrimitive:r,iterate:l}=e;if(i&&n){const h=i;i=(f,d,x,w,S)=>h(f,d,x,w,S)?!0:l(f,d,this,n,x,w,r)}else i||(n?i=(h,f,d,x)=>l(h,f,this,n,d,x,r):i=(h,f,d)=>d);let o=!1,c=0;const u=this._roots;for(let h=0,f=u.length;h<f;h++){const d=u[h];if(o=$o(this,h,s,i,t,c),o)break;c+=d.byteLength/W}return o}bvhcast(e,t,s){let{intersectsRanges:i}=s;return Wo(this,e,t,i)}}function Qo(){return typeof SharedArrayBuffer<"u"}function fi(a){return a.index?a.index.count:a.attributes.position.count}function us(a){return fi(a)/3}function Jo(a,e=ArrayBuffer){return a>65535?new Uint32Array(new e(4*a)):new Uint16Array(new e(2*a))}function ea(a,e){if(!a.index){const t=a.attributes.position.count,s=e.useSharedArrayBuffer?SharedArrayBuffer:ArrayBuffer,i=Jo(t,s);a.setIndex(new Ye(i,1));for(let n=0;n<t;n++)i[n]=n}}function ta(a,e,t){const s=fi(a)/t,i=e||a.drawRange,n=i.start/t,r=(i.start+i.count)/t,l=Math.max(0,n),o=Math.min(s,r)-l;return{offset:Math.floor(l),count:Math.floor(o)}}function sa(a,e){return a.groups.map(t=>({offset:t.start/e,count:t.count/e}))}function ki(a,e,t){const s=ta(a,e,t),i=sa(a,t);if(!i.length)return[s];const n=[],r=s.offset,l=s.offset+s.count,o=fi(a)/t,c=[];for(const f of i){const{offset:d,count:x}=f,w=d,S=isFinite(x)?x:o-d,y=d+S;w<l&&y>r&&(c.push({pos:Math.max(r,w),isStart:!0}),c.push({pos:Math.min(l,y),isStart:!1}))}c.sort((f,d)=>f.pos!==d.pos?f.pos-d.pos:f.type==="end"?-1:1);let u=0,h=null;for(const f of c){const d=f.pos;u!==0&&d!==h&&n.push({offset:h,count:d-h}),u+=f.isStart?1:-1,h=d}return n}function ia(a,e){const t=a[a.length-1],s=t.offset+t.count>2**16,i=a.reduce((c,u)=>c+u.count,0),n=s?4:2,r=e?new SharedArrayBuffer(i*n):new ArrayBuffer(i*n),l=s?new Uint32Array(r):new Uint16Array(r);let o=0;for(let c=0;c<a.length;c++){const{offset:u,count:h}=a[c];for(let f=0;f<h;f++)l[o+f]=u+f;o+=h}return l}class na extends Zo{get indirect(){return!!this._indirectBuffer}get primitiveStride(){return null}get primitiveBufferStride(){return this.indirect?1:this.primitiveStride}set primitiveBufferStride(e){}get primitiveBuffer(){return this.indirect?this._indirectBuffer:this.geometry.index.array}set primitiveBuffer(e){}constructor(e,t={}){if(e.isBufferGeometry){if(e.index&&e.index.isInterleavedBufferAttribute)throw new Error("BVH: InterleavedBufferAttribute is not supported for the index attribute.")}else throw new Error("BVH: Only BufferGeometries are supported.");if(t.useSharedArrayBuffer&&!Qo())throw new Error("BVH: SharedArrayBuffer is not available.");super(),this.geometry=e,this.resolvePrimitiveIndex=t.indirect?s=>this._indirectBuffer[s]:s=>s,this.primitiveBuffer=null,this.primitiveBufferStride=null,this._indirectBuffer=null,t={...On,...t},t[ci]||this.init(t)}init(e){const{geometry:t,primitiveStride:s}=this;if(e.indirect){const i=ki(t,e.range,s),n=ia(i,e.useSharedArrayBuffer);this._indirectBuffer=n}else ea(t,e);super.init(e),!t.boundingBox&&e.setBoundingBox&&(t.boundingBox=this.getBoundingBox(new he))}getRootRanges(e){return this.indirect?[{offset:0,count:this._indirectBuffer.length}]:ki(this.geometry,e,this.primitiveStride)}raycastObject3D(){throw new Error("BVH: raycastObject3D() not implemented")}}class _e{constructor(){this.min=1/0,this.max=-1/0}setFromPointsField(e,t){let s=1/0,i=-1/0;for(let n=0,r=e.length;n<r;n++){const o=e[n][t];s=o<s?o:s,i=o>i?o:i}this.min=s,this.max=i}setFromPoints(e,t){let s=1/0,i=-1/0;for(let n=0,r=t.length;n<r;n++){const l=t[n],o=e.dot(l);s=o<s?o:s,i=o>i?o:i}this.min=s,this.max=i}isSeparated(e){return this.min>e.max||e.min>this.max}}_e.prototype.setFromBox=(function(){const a=new v;return function(t,s){const i=s.min,n=s.max;let r=1/0,l=-1/0;for(let o=0;o<=1;o++)for(let c=0;c<=1;c++)for(let u=0;u<=1;u++){a.x=i.x*o+n.x*(1-o),a.y=i.y*c+n.y*(1-c),a.z=i.z*u+n.z*(1-u);const h=t.dot(a);r=Math.min(h,r),l=Math.max(h,l)}this.min=r,this.max=l}})();const ra=(function(){const a=new v,e=new v,t=new v;return function(i,n,r){const l=i.start,o=a,c=n.start,u=e;t.subVectors(l,c),a.subVectors(i.end,i.start),e.subVectors(n.end,n.start);const h=t.dot(u),f=u.dot(o),d=u.dot(u),x=t.dot(o),S=o.dot(o)*d-f*f;let y,p;S!==0?y=(h*f-x*d)/S:y=0,p=(h+y*f)/d,r.x=y,r.y=p}})(),di=(function(){const a=new q,e=new v,t=new v;return function(i,n,r,l){ra(i,n,a);let o=a.x,c=a.y;if(o>=0&&o<=1&&c>=0&&c<=1){i.at(o,r),n.at(c,l);return}else if(o>=0&&o<=1){c<0?n.at(0,l):n.at(1,l),i.closestPointToPoint(l,!0,r);return}else if(c>=0&&c<=1){o<0?i.at(0,r):i.at(1,r),n.closestPointToPoint(r,!0,l);return}else{let u;o<0?u=i.start:u=i.end;let h;c<0?h=n.start:h=n.end;const f=e,d=t;if(i.closestPointToPoint(h,!0,e),n.closestPointToPoint(u,!0,t),f.distanceToSquared(h)<=d.distanceToSquared(u)){r.copy(f),l.copy(h);return}else{r.copy(u),l.copy(d);return}}}})(),oa=(function(){const a=new v,e=new v,t=new me,s=new ce;return function(n,r){const{radius:l,center:o}=n,{a:c,b:u,c:h}=r;if(s.start=c,s.end=u,s.closestPointToPoint(o,!0,a).distanceTo(o)<=l||(s.start=c,s.end=h,s.closestPointToPoint(o,!0,a).distanceTo(o)<=l)||(s.start=u,s.end=h,s.closestPointToPoint(o,!0,a).distanceTo(o)<=l))return!0;const w=r.getPlane(t);if(Math.abs(w.distanceToPoint(o))<=l){const y=w.projectPoint(o,e);if(r.containsPoint(y))return!0}return!1}})(),aa=["x","y","z"],Te=1e-15,qi=Te*Te;function re(a){return Math.abs(a)<Te}class ue extends ie{constructor(...e){super(...e),this.isExtendedTriangle=!0,this.satAxes=new Array(4).fill().map(()=>new v),this.satBounds=new Array(4).fill().map(()=>new _e),this.points=[this.a,this.b,this.c],this.plane=new me,this.isDegenerateIntoSegment=!1,this.isDegenerateIntoPoint=!1,this.degenerateSegment=new ce,this.needsUpdate=!0}intersectsSphere(e){return oa(e,this)}update(){const e=this.a,t=this.b,s=this.c,i=this.points,n=this.satAxes,r=this.satBounds,l=n[0],o=r[0];this.getNormal(l),o.setFromPoints(l,i);const c=n[1],u=r[1];c.subVectors(e,t),u.setFromPoints(c,i);const h=n[2],f=r[2];h.subVectors(t,s),f.setFromPoints(h,i);const d=n[3],x=r[3];d.subVectors(s,e),x.setFromPoints(d,i);const w=c.length(),S=h.length(),y=d.length();this.isDegenerateIntoPoint=!1,this.isDegenerateIntoSegment=!1,w<Te?S<Te||y<Te?this.isDegenerateIntoPoint=!0:(this.isDegenerateIntoSegment=!0,this.degenerateSegment.start.copy(e),this.degenerateSegment.end.copy(s)):S<Te?y<Te?this.isDegenerateIntoPoint=!0:(this.isDegenerateIntoSegment=!0,this.degenerateSegment.start.copy(t),this.degenerateSegment.end.copy(e)):y<Te&&(this.isDegenerateIntoSegment=!0,this.degenerateSegment.start.copy(s),this.degenerateSegment.end.copy(t)),this.plane.setFromNormalAndCoplanarPoint(l,e),this.needsUpdate=!1}}ue.prototype.closestPointToSegment=(function(){const a=new v,e=new v,t=new ce;return function(i,n=null,r=null){const{start:l,end:o}=i,c=this.points;let u,h=1/0;for(let f=0;f<3;f++){const d=(f+1)%3;t.start.copy(c[f]),t.end.copy(c[d]),di(t,i,a,e),u=a.distanceToSquared(e),u<h&&(h=u,n&&n.copy(a),r&&r.copy(e))}return this.closestPointToPoint(l,a),u=l.distanceToSquared(a),u<h&&(h=u,n&&n.copy(a),r&&r.copy(l)),this.closestPointToPoint(o,a),u=o.distanceToSquared(a),u<h&&(h=u,n&&n.copy(a),r&&r.copy(o)),Math.sqrt(h)}})();ue.prototype.intersectsTriangle=(function(){const a=new ue,e=new _e,t=new _e,s=new v,i=new v,n=new v,r=new v,l=new ce,o=new ce,c=new v,u=new q,h=new q;function f(m,g,b,T){const P=s;!m.isDegenerateIntoPoint&&!m.isDegenerateIntoSegment?P.copy(m.plane.normal):P.copy(g.plane.normal);const A=m.satBounds,C=m.satAxes;for(let M=1;M<4;M++){const z=A[M],R=C[M];if(e.setFromPoints(R,g.points),z.isSeparated(e)||(r.copy(P).cross(R),e.setFromPoints(r,m.points),t.setFromPoints(r,g.points),e.isSeparated(t)))return!1}const _=g.satBounds,E=g.satAxes;for(let M=1;M<4;M++){const z=_[M],R=E[M];if(e.setFromPoints(R,m.points),z.isSeparated(e)||(r.crossVectors(P,R),e.setFromPoints(r,m.points),t.setFromPoints(r,g.points),e.isSeparated(t)))return!1}return b&&(T||console.warn("ExtendedTriangle.intersectsTriangle: Triangles are coplanar which does not support an output edge. Setting edge to 0, 0, 0."),b.start.set(0,0,0),b.end.set(0,0,0)),!0}function d(m,g,b,T,P,A,C,_,E,M,z){let R=C/(C-_);M.x=T+(P-T)*R,z.start.subVectors(g,m).multiplyScalar(R).add(m),R=C/(C-E),M.y=T+(A-T)*R,z.end.subVectors(b,m).multiplyScalar(R).add(m)}function x(m,g,b,T,P,A,C,_,E,M,z){if(P>0)d(m.c,m.a,m.b,T,g,b,E,C,_,M,z);else if(A>0)d(m.b,m.a,m.c,b,g,T,_,C,E,M,z);else if(_*E>0||C!=0)d(m.a,m.b,m.c,g,b,T,C,_,E,M,z);else if(_!=0)d(m.b,m.a,m.c,b,g,T,_,C,E,M,z);else if(E!=0)d(m.c,m.a,m.b,T,g,b,E,C,_,M,z);else return!0;return!1}function w(m,g,b,T){const P=g.degenerateSegment,A=m.plane.distanceToPoint(P.start),C=m.plane.distanceToPoint(P.end);return re(A)?re(C)?f(m,g,b,T):(b&&(b.start.copy(P.start),b.end.copy(P.start)),m.containsPoint(P.start)):re(C)?(b&&(b.start.copy(P.end),b.end.copy(P.end)),m.containsPoint(P.end)):m.plane.intersectLine(P,s)!=null?(b&&(b.start.copy(s),b.end.copy(s)),m.containsPoint(s)):!1}function S(m,g,b){const T=g.a;return re(m.plane.distanceToPoint(T))&&m.containsPoint(T)?(b&&(b.start.copy(T),b.end.copy(T)),!0):!1}function y(m,g,b){const T=m.degenerateSegment,P=g.a;return T.closestPointToPoint(P,!0,s),P.distanceToSquared(s)<qi?(b&&(b.start.copy(P),b.end.copy(P)),!0):!1}function p(m,g,b,T){if(m.isDegenerateIntoSegment)if(g.isDegenerateIntoSegment){const P=m.degenerateSegment,A=g.degenerateSegment,C=i,_=n;P.delta(C),A.delta(_);const E=s.subVectors(A.start,P.start),M=C.x*_.y-C.y*_.x;if(re(M))return!1;const z=(E.x*_.y-E.y*_.x)/M,R=-(C.x*E.y-C.y*E.x)/M;if(z<0||z>1||R<0||R>1)return!1;const L=P.start.z+C.z*z,B=A.start.z+_.z*R;return re(L-B)?(b&&(b.start.copy(P.start).addScaledVector(C,z),b.end.copy(P.start).addScaledVector(C,z)),!0):!1}else return g.isDegenerateIntoPoint?y(m,g,b):w(g,m,b,T);else{if(m.isDegenerateIntoPoint)return g.isDegenerateIntoPoint?g.a.distanceToSquared(m.a)<qi?(b&&(b.start.copy(m.a),b.end.copy(m.a)),!0):!1:g.isDegenerateIntoSegment?y(g,m,b):S(g,m,b);if(g.isDegenerateIntoPoint)return S(m,g,b);if(g.isDegenerateIntoSegment)return w(m,g,b,T)}}return function(g,b=null,T=!1){this.needsUpdate&&this.update(),g.isExtendedTriangle?g.needsUpdate&&g.update():(a.copy(g),a.update(),g=a);const P=p(this,g,b,T);if(P!==void 0)return P;const A=this.plane,C=g.plane;let _=C.distanceToPoint(this.a),E=C.distanceToPoint(this.b),M=C.distanceToPoint(this.c);re(_)&&(_=0),re(E)&&(E=0),re(M)&&(M=0);const z=_*E,R=_*M;if(z>0&&R>0)return!1;let L=A.distanceToPoint(g.a),B=A.distanceToPoint(g.b),fe=A.distanceToPoint(g.c);re(L)&&(L=0),re(B)&&(B=0),re(fe)&&(fe=0);const fs=L*B,Ct=L*fe;if(fs>0&&Ct>0)return!1;i.copy(A.normal),n.copy(C.normal);const ds=i.cross(n);let ms=0,ps=Math.abs(ds.x);const gi=Math.abs(ds.y);gi>ps&&(ps=gi,ms=1),Math.abs(ds.z)>ps&&(ms=2);const $e=aa[ms],Vn=this.a[$e],Yn=this.b[$e],Kn=this.c[$e],Xn=g.a[$e],$n=g.b[$e],Wn=g.c[$e];if(x(this,Vn,Yn,Kn,z,R,_,E,M,u,l))return f(this,g,b,T);if(x(g,Xn,$n,Wn,fs,Ct,L,B,fe,h,o))return f(this,g,b,T);if(u.y<u.x){const gs=u.y;u.y=u.x,u.x=gs,c.copy(l.start),l.start.copy(l.end),l.end.copy(c)}if(h.y<h.x){const gs=h.y;h.y=h.x,h.x=gs,c.copy(o.start),o.start.copy(o.end),o.end.copy(c)}return u.y<h.x||h.y<u.x?!1:(b&&(h.x>u.x?b.start.copy(o.start):b.start.copy(l.start),h.y<u.y?b.end.copy(o.end):b.end.copy(l.end)),!0)}})();ue.prototype.distanceToPoint=(function(){const a=new v;return function(t){return this.closestPointToPoint(t,a),t.distanceTo(a)}})();ue.prototype.distanceToTriangle=(function(){const a=new v,e=new v,t=["a","b","c"],s=new ce,i=new ce;return function(r,l=null,o=null){const c=l||o?s:null;if(this.intersectsTriangle(r,c))return(l||o)&&(l&&c.getCenter(l),o&&c.getCenter(o)),0;let u=1/0;for(let h=0;h<3;h++){let f;const d=t[h],x=r[d];this.closestPointToPoint(x,a),f=x.distanceToSquared(a),f<u&&(u=f,l&&l.copy(a),o&&o.copy(x));const w=this[d];r.closestPointToPoint(w,a),f=w.distanceToSquared(a),f<u&&(u=f,l&&l.copy(w),o&&o.copy(a))}for(let h=0;h<3;h++){const f=t[h],d=t[(h+1)%3];s.set(this[f],this[d]);for(let x=0;x<3;x++){const w=t[x],S=t[(x+1)%3];i.set(r[w],r[S]),di(s,i,a,e);const y=a.distanceToSquared(e);y<u&&(u=y,l&&l.copy(a),o&&o.copy(e))}}return Math.sqrt(u)}})();class te{constructor(e,t,s){this.isOrientedBox=!0,this.min=new v,this.max=new v,this.matrix=new ee,this.invMatrix=new ee,this.points=new Array(8).fill().map(()=>new v),this.satAxes=new Array(3).fill().map(()=>new v),this.satBounds=new Array(3).fill().map(()=>new _e),this.alignedSatBounds=new Array(3).fill().map(()=>new _e),this.needsUpdate=!1,e&&this.min.copy(e),t&&this.max.copy(t),s&&this.matrix.copy(s)}set(e,t,s){this.min.copy(e),this.max.copy(t),this.matrix.copy(s),this.needsUpdate=!0}copy(e){this.min.copy(e.min),this.max.copy(e.max),this.matrix.copy(e.matrix),this.needsUpdate=!0}}te.prototype.update=(function(){return function(){const e=this.matrix,t=this.min,s=this.max,i=this.points;for(let c=0;c<=1;c++)for(let u=0;u<=1;u++)for(let h=0;h<=1;h++){const f=1*c|2*u|4*h,d=i[f];d.x=c?s.x:t.x,d.y=u?s.y:t.y,d.z=h?s.z:t.z,d.applyMatrix4(e)}const n=this.satBounds,r=this.satAxes,l=i[0];for(let c=0;c<3;c++){const u=r[c],h=n[c],f=1<<c,d=i[f];u.subVectors(l,d),h.setFromPoints(u,i)}const o=this.alignedSatBounds;o[0].setFromPointsField(i,"x"),o[1].setFromPointsField(i,"y"),o[2].setFromPointsField(i,"z"),this.invMatrix.copy(this.matrix).invert(),this.needsUpdate=!1}})();te.prototype.intersectsBox=(function(){const a=new _e;return function(t){this.needsUpdate&&this.update();const s=t.min,i=t.max,n=this.satBounds,r=this.satAxes,l=this.alignedSatBounds;if(a.min=s.x,a.max=i.x,l[0].isSeparated(a)||(a.min=s.y,a.max=i.y,l[1].isSeparated(a))||(a.min=s.z,a.max=i.z,l[2].isSeparated(a)))return!1;for(let o=0;o<3;o++){const c=r[o],u=n[o];if(a.setFromBox(c,t),u.isSeparated(a))return!1}return!0}})();te.prototype.intersectsTriangle=(function(){const a=new ue,e=new Array(3),t=new _e,s=new _e,i=new v;return function(r){this.needsUpdate&&this.update(),r.isExtendedTriangle?r.needsUpdate&&r.update():(a.copy(r),a.update(),r=a);const l=this.satBounds,o=this.satAxes;e[0]=r.a,e[1]=r.b,e[2]=r.c;for(let f=0;f<3;f++){const d=l[f],x=o[f];if(t.setFromPoints(x,e),d.isSeparated(t))return!1}const c=r.satBounds,u=r.satAxes,h=this.points;for(let f=0;f<3;f++){const d=c[f],x=u[f];if(t.setFromPoints(x,h),d.isSeparated(t))return!1}for(let f=0;f<3;f++){const d=o[f];for(let x=0;x<4;x++){const w=u[x];if(i.crossVectors(d,w),t.setFromPoints(i,e),s.setFromPoints(i,h),t.isSeparated(s))return!1}}return!0}})();te.prototype.closestPointToPoint=(function(){return function(e,t){return this.needsUpdate&&this.update(),t.copy(e).applyMatrix4(this.invMatrix).clamp(this.min,this.max).applyMatrix4(this.matrix),t}})();te.prototype.distanceToPoint=(function(){const a=new v;return function(t){return this.closestPointToPoint(t,a),t.distanceTo(a)}})();te.prototype.distanceToBox=(function(){const a=["x","y","z"],e=new Array(12).fill().map(()=>new ce),t=new Array(12).fill().map(()=>new ce),s=new v,i=new v;return function(r,l=0,o=null,c=null){if(this.needsUpdate&&this.update(),this.intersectsBox(r))return(o||c)&&(r.getCenter(i),this.closestPointToPoint(i,s),r.closestPointToPoint(s,i),o&&o.copy(s),c&&c.copy(i)),0;const u=l*l,h=r.min,f=r.max,d=this.points;let x=1/0;for(let S=0;S<8;S++){const y=d[S];i.copy(y).clamp(h,f);const p=y.distanceToSquared(i);if(p<x&&(x=p,o&&o.copy(y),c&&c.copy(i),p<u))return Math.sqrt(p)}let w=0;for(let S=0;S<3;S++)for(let y=0;y<=1;y++)for(let p=0;p<=1;p++){const m=(S+1)%3,g=(S+2)%3,b=y<<m|p<<g,T=1<<S|y<<m|p<<g,P=d[b],A=d[T];e[w].set(P,A);const _=a[S],E=a[m],M=a[g],z=t[w],R=z.start,L=z.end;R[_]=h[_],R[E]=y?h[E]:f[E],R[M]=p?h[M]:f[E],L[_]=f[_],L[E]=y?h[E]:f[E],L[M]=p?h[M]:f[E],w++}for(let S=0;S<=1;S++)for(let y=0;y<=1;y++)for(let p=0;p<=1;p++){i.x=S?f.x:h.x,i.y=y?f.y:h.y,i.z=p?f.z:h.z,this.closestPointToPoint(i,s);const m=i.distanceToSquared(s);if(m<x&&(x=m,o&&o.copy(s),c&&c.copy(i),m<u))return Math.sqrt(m)}for(let S=0;S<12;S++){const y=e[S];for(let p=0;p<12;p++){const m=t[p];di(y,m,s,i);const g=s.distanceToSquared(i);if(g<x&&(x=g,o&&o.copy(s),c&&c.copy(i),g<u))return Math.sqrt(g)}}return Math.sqrt(x)}})();class la extends hi{constructor(){super(()=>new ue)}}const le=new la,dt=new v,vs=new v;function ca(a,e,t={},s=0,i=1/0){const n=s*s,r=i*i;let l=1/0,o=null;if(a.shapecast({boundsTraverseOrder:u=>(dt.copy(e).clamp(u.min,u.max),dt.distanceToSquared(e)),intersectsBounds:(u,h,f)=>f<l&&f<r,intersectsTriangle:(u,h)=>{u.closestPointToPoint(e,dt);const f=e.distanceToSquared(dt);return f<l&&(vs.copy(dt),l=f,o=h),f<n}}),l===1/0)return null;const c=Math.sqrt(l);return t.point?t.point.copy(vs):t.point=vs.clone(),t.distance=c,t.faceIndex=o,t}const It=parseInt(vn)>=169,ua=parseInt(vn)<=161,Fe=new v,ke=new v,qe=new v,Ot=new q,Dt=new q,Bt=new q,Ui=new v,Gi=new v,ji=new v,mt=new v;function ha(a,e,t,s,i,n,r,l){let o;if(n===Lr?o=a.intersectTriangle(s,t,e,!0,i):o=a.intersectTriangle(e,t,s,n!==k,i),o===null)return null;const c=a.origin.distanceTo(i);return c<r||c>l?null:{distance:c,point:i.clone()}}function Vi(a,e,t,s,i,n,r,l,o,c,u){Fe.fromBufferAttribute(e,n),ke.fromBufferAttribute(e,r),qe.fromBufferAttribute(e,l);const h=ha(a,Fe,ke,qe,mt,o,c,u);if(h){if(s){Ot.fromBufferAttribute(s,n),Dt.fromBufferAttribute(s,r),Bt.fromBufferAttribute(s,l),h.uv=new q;const d=ie.getInterpolation(mt,Fe,ke,qe,Ot,Dt,Bt,h.uv);It||(h.uv=d)}if(i){Ot.fromBufferAttribute(i,n),Dt.fromBufferAttribute(i,r),Bt.fromBufferAttribute(i,l),h.uv1=new q;const d=ie.getInterpolation(mt,Fe,ke,qe,Ot,Dt,Bt,h.uv1);It||(h.uv1=d),ua&&(h.uv2=h.uv1)}if(t){Ui.fromBufferAttribute(t,n),Gi.fromBufferAttribute(t,r),ji.fromBufferAttribute(t,l),h.normal=new v;const d=ie.getInterpolation(mt,Fe,ke,qe,Ui,Gi,ji,h.normal);h.normal.dot(a.direction)>0&&h.normal.multiplyScalar(-1),It||(h.normal=d)}const f={a:n,b:r,c:l,normal:new v,materialIndex:0};if(ie.getNormal(Fe,ke,qe,f.normal),h.face=f,h.faceIndex=n,It){const d=new v;ie.getBarycoord(mt,Fe,ke,qe,d),h.barycoord=d}}return h}function Yi(a){return a&&a.isMaterial?a.side:a}function hs(a,e,t,s,i,n,r){const l=s*3;let o=l+0,c=l+1,u=l+2;const{index:h,groups:f}=a;a.index&&(o=h.getX(o),c=h.getX(c),u=h.getX(u));const{position:d,normal:x,uv:w,uv1:S}=a.attributes;if(Array.isArray(e)){const y=s*3;for(let p=0,m=f.length;p<m;p++){const{start:g,count:b,materialIndex:T}=f[p];if(y>=g&&y<g+b){const P=Yi(e[T]),A=Vi(t,d,x,w,S,o,c,u,P,n,r);if(A)if(A.faceIndex=s,A.face.materialIndex=T,i)i.push(A);else return A}}}else{const y=Yi(e),p=Vi(t,d,x,w,S,o,c,u,y,n,r);if(p)if(p.faceIndex=s,p.face.materialIndex=0,i)i.push(p);else return p}return null}function j(a,e,t,s){const i=a.a,n=a.b,r=a.c;let l=e,o=e+1,c=e+2;t&&(l=t.getX(l),o=t.getX(o),c=t.getX(c)),i.x=s.getX(l),i.y=s.getY(l),i.z=s.getZ(l),n.x=s.getX(o),n.y=s.getY(o),n.z=s.getZ(o),r.x=s.getX(c),r.y=s.getY(c),r.z=s.getZ(c)}function fa(a,e,t,s,i,n,r,l){const{geometry:o,_indirectBuffer:c}=a;for(let u=s,h=s+i;u<h;u++)hs(o,e,t,u,n,r,l)}function da(a,e,t,s,i,n,r){const{geometry:l,_indirectBuffer:o}=a;let c=1/0,u=null;for(let h=s,f=s+i;h<f;h++){let d;d=hs(l,e,t,h,null,n,r),d&&d.distance<c&&(u=d,c=d.distance)}return u}function ma(a,e,t,s,i,n,r){const{geometry:l}=t,{index:o}=l,c=l.attributes.position;for(let u=a,h=e+a;u<h;u++){let f;if(f=u,j(r,f*3,o,c),r.needsUpdate=!0,s(r,f,i,n))return!0}return!1}function pa(a,e=null){e&&Array.isArray(e)&&(e=new Set(e));const t=a.geometry,s=t.index?t.index.array:null,i=t.attributes.position;let n,r,l,o,c=0;const u=a._roots;for(let f=0,d=u.length;f<d;f++)n=u[f],r=new Uint32Array(n),l=new Uint16Array(n),o=new Float32Array(n),h(0,c),c+=n.byteLength;function h(f,d,x=!1){const w=f*2;if(K(w,l)){const S=Z(f,r),y=J(w,l);let p=1/0,m=1/0,g=1/0,b=-1/0,T=-1/0,P=-1/0;for(let A=3*S,C=3*(S+y);A<C;A++){let _=s[A];const E=i.getX(_),M=i.getY(_),z=i.getZ(_);E<p&&(p=E),E>b&&(b=E),M<m&&(m=M),M>T&&(T=M),z<g&&(g=z),z>P&&(P=z)}return o[f+0]!==p||o[f+1]!==m||o[f+2]!==g||o[f+3]!==b||o[f+4]!==T||o[f+5]!==P?(o[f+0]=p,o[f+1]=m,o[f+2]=g,o[f+3]=b,o[f+4]=T,o[f+5]=P,!0):!1}else{const S=X(f),y=$(f,r);let p=x,m=!1,g=!1;if(e){if(!p){const _=S/Y+d/W,E=y/Y+d/W;m=e.has(_),g=e.has(E),p=!m&&!g}}else m=!0,g=!0;const b=p||m,T=p||g;let P=!1;b&&(P=h(S,d,p));let A=!1;T&&(A=h(y,d,p));const C=P||A;if(C)for(let _=0;_<3;_++){const E=S+_,M=y+_,z=o[E],R=o[E+3],L=o[M],B=o[M+3];o[f+_]=z<L?z:L,o[f+_+3]=R>B?R:B}return C}}}function Ne(a,e,t,s,i){let n,r,l,o,c,u;const h=1/t.direction.x,f=1/t.direction.y,d=1/t.direction.z,x=t.origin.x,w=t.origin.y,S=t.origin.z;let y=e[a],p=e[a+3],m=e[a+1],g=e[a+3+1],b=e[a+2],T=e[a+3+2];return h>=0?(n=(y-x)*h,r=(p-x)*h):(n=(p-x)*h,r=(y-x)*h),f>=0?(l=(m-w)*f,o=(g-w)*f):(l=(g-w)*f,o=(m-w)*f),n>o||l>r||((l>n||isNaN(n))&&(n=l),(o<r||isNaN(r))&&(r=o),d>=0?(c=(b-S)*d,u=(T-S)*d):(c=(T-S)*d,u=(b-S)*d),n>u||c>r)?!1:((c>n||n!==n)&&(n=c),(u<r||r!==r)&&(r=u),n<=i&&r>=s)}function ga(a,e,t,s,i,n,r,l){const{geometry:o,_indirectBuffer:c}=a;for(let u=s,h=s+i;u<h;u++){let f=c?c[u]:u;hs(o,e,t,f,n,r,l)}}function ya(a,e,t,s,i,n,r){const{geometry:l,_indirectBuffer:o}=a;let c=1/0,u=null;for(let h=s,f=s+i;h<f;h++){let d;d=hs(l,e,t,o?o[h]:h,null,n,r),d&&d.distance<c&&(u=d,c=d.distance)}return u}function xa(a,e,t,s,i,n,r){const{geometry:l}=t,{index:o}=l,c=l.attributes.position;for(let u=a,h=e+a;u<h;u++){let f;if(f=t.resolveTriangleIndex(u),j(r,f*3,o,c),r.needsUpdate=!0,s(r,f,i,n))return!0}return!1}function ba(a,e,t,s,i,n,r){F.setBuffer(a._roots[e]),ti(0,a,t,s,i,n,r),F.clearBuffer()}function ti(a,e,t,s,i,n,r){const{float32Array:l,uint16Array:o,uint32Array:c}=F,u=a*2;if(K(u,o)){const f=Z(a,c),d=J(u,o);fa(e,t,s,f,d,i,n,r)}else{const f=X(a);Ne(f,l,s,n,r)&&ti(f,e,t,s,i,n,r);const d=$(a,c);Ne(d,l,s,n,r)&&ti(d,e,t,s,i,n,r)}}const Sa=["x","y","z"];function wa(a,e,t,s,i,n){F.setBuffer(a._roots[e]);const r=si(0,a,t,s,i,n);return F.clearBuffer(),r}function si(a,e,t,s,i,n){const{float32Array:r,uint16Array:l,uint32Array:o}=F;let c=a*2;if(K(c,l)){const h=Z(a,o),f=J(c,l);return da(e,t,s,h,f,i,n)}else{const h=ui(a,o),f=Sa[h],x=s.direction[f]>=0;let w,S;x?(w=X(a),S=$(a,o)):(w=$(a,o),S=X(a));const p=Ne(w,r,s,i,n)?si(w,e,t,s,i,n):null;if(p){const b=p.point[f];if(x?b<=r[S+h]:b>=r[S+h+3])return p}const g=Ne(S,r,s,i,n)?si(S,e,t,s,i,n):null;return p&&g?p.distance<=g.distance?p:g:p||g||null}}const Nt=new he,tt=new ue,st=new ue,pt=new ee,Ki=new te,Ht=new te;function Pa(a,e,t,s){F.setBuffer(a._roots[e]);const i=ii(0,a,t,s);return F.clearBuffer(),i}function ii(a,e,t,s,i=null){const{float32Array:n,uint16Array:r,uint32Array:l}=F;let o=a*2;if(i===null&&(t.boundingBox||t.computeBoundingBox(),Ki.set(t.boundingBox.min,t.boundingBox.max,s),i=Ki),K(o,r)){const u=e.geometry,h=u.index,f=u.attributes.position,d=t.index,x=t.attributes.position,w=Z(a,l),S=J(o,r);if(pt.copy(s).invert(),t.boundsTree)return U(a,n,Ht),Ht.matrix.copy(pt),Ht.needsUpdate=!0,t.boundsTree.shapecast({intersectsBounds:p=>Ht.intersectsBox(p),intersectsTriangle:p=>{p.a.applyMatrix4(s),p.b.applyMatrix4(s),p.c.applyMatrix4(s),p.needsUpdate=!0;for(let m=w*3,g=(S+w)*3;m<g;m+=3)if(j(st,m,h,f),st.needsUpdate=!0,p.intersectsTriangle(st))return!0;return!1}});{const y=us(t);for(let p=w*3,m=(S+w)*3;p<m;p+=3){j(tt,p,h,f),tt.a.applyMatrix4(pt),tt.b.applyMatrix4(pt),tt.c.applyMatrix4(pt),tt.needsUpdate=!0;for(let g=0,b=y*3;g<b;g+=3)if(j(st,g,d,x),st.needsUpdate=!0,tt.intersectsTriangle(st))return!0}}}else{const u=X(a),h=$(a,l);return U(u,n,Nt),!!(i.intersectsBox(Nt)&&ii(u,e,t,s,i)||(U(h,n,Nt),i.intersectsBox(Nt)&&ii(h,e,t,s,i)))}}const Ft=new ee,Es=new te,gt=new te,Ta=new v,Aa=new v,_a=new v,Ma=new v;function Ca(a,e,t,s={},i={},n=0,r=1/0){e.boundingBox||e.computeBoundingBox(),Es.set(e.boundingBox.min,e.boundingBox.max,t),Es.needsUpdate=!0;const l=a.geometry,o=l.attributes.position,c=l.index,u=e.attributes.position,h=e.index,f=le.getPrimitive(),d=le.getPrimitive();let x=Ta,w=Aa,S=null,y=null;i&&(S=_a,y=Ma);let p=1/0,m=null,g=null;return Ft.copy(t).invert(),gt.matrix.copy(Ft),a.shapecast({boundsTraverseOrder:b=>Es.distanceToBox(b),intersectsBounds:(b,T,P)=>P<p&&P<r?(T&&(gt.min.copy(b.min),gt.max.copy(b.max),gt.needsUpdate=!0),!0):!1,intersectsRange:(b,T)=>{if(e.boundsTree)return e.boundsTree.shapecast({boundsTraverseOrder:A=>gt.distanceToBox(A),intersectsBounds:(A,C,_)=>_<p&&_<r,intersectsRange:(A,C)=>{for(let _=A,E=A+C;_<E;_++){j(d,3*_,h,u),d.a.applyMatrix4(t),d.b.applyMatrix4(t),d.c.applyMatrix4(t),d.needsUpdate=!0;for(let M=b,z=b+T;M<z;M++){j(f,3*M,c,o),f.needsUpdate=!0;const R=f.distanceToTriangle(d,x,S);if(R<p&&(w.copy(x),y&&y.copy(S),p=R,m=M,g=_),R<n)return!0}}}});{const P=us(e);for(let A=0,C=P;A<C;A++){j(d,3*A,h,u),d.a.applyMatrix4(t),d.b.applyMatrix4(t),d.c.applyMatrix4(t),d.needsUpdate=!0;for(let _=b,E=b+T;_<E;_++){j(f,3*_,c,o),f.needsUpdate=!0;const M=f.distanceToTriangle(d,x,S);if(M<p&&(w.copy(x),y&&y.copy(S),p=M,m=_,g=A),M<n)return!0}}}}}),le.releasePrimitive(f),le.releasePrimitive(d),p===1/0?null:(s.point?s.point.copy(w):s.point=w.clone(),s.distance=p,s.faceIndex=m,i&&(i.point?i.point.copy(y):i.point=y.clone(),i.point.applyMatrix4(Ft),w.applyMatrix4(Ft),i.distance=w.sub(i.point).length(),i.faceIndex=g),s)}function va(a,e=null){e&&Array.isArray(e)&&(e=new Set(e));const t=a.geometry,s=t.index?t.index.array:null,i=t.attributes.position;let n,r,l,o,c=0;const u=a._roots;for(let f=0,d=u.length;f<d;f++)n=u[f],r=new Uint32Array(n),l=new Uint16Array(n),o=new Float32Array(n),h(0,c),c+=n.byteLength;function h(f,d,x=!1){const w=f*2;if(K(w,l)){const S=Z(f,r),y=J(w,l);let p=1/0,m=1/0,g=1/0,b=-1/0,T=-1/0,P=-1/0;for(let A=S,C=S+y;A<C;A++){const _=3*a.resolveTriangleIndex(A);for(let E=0;E<3;E++){let M=_+E;M=s?s[M]:M;const z=i.getX(M),R=i.getY(M),L=i.getZ(M);z<p&&(p=z),z>b&&(b=z),R<m&&(m=R),R>T&&(T=R),L<g&&(g=L),L>P&&(P=L)}}return o[f+0]!==p||o[f+1]!==m||o[f+2]!==g||o[f+3]!==b||o[f+4]!==T||o[f+5]!==P?(o[f+0]=p,o[f+1]=m,o[f+2]=g,o[f+3]=b,o[f+4]=T,o[f+5]=P,!0):!1}else{const S=X(f),y=$(f,r);let p=x,m=!1,g=!1;if(e){if(!p){const _=S/Y+d/W,E=y/Y+d/W;m=e.has(_),g=e.has(E),p=!m&&!g}}else m=!0,g=!0;const b=p||m,T=p||g;let P=!1;b&&(P=h(S,d,p));let A=!1;T&&(A=h(y,d,p));const C=P||A;if(C)for(let _=0;_<3;_++){const E=S+_,M=y+_,z=o[E],R=o[E+3],L=o[M],B=o[M+3];o[f+_]=z<L?z:L,o[f+_+3]=R>B?R:B}return C}}}function Ea(a,e,t,s,i,n,r){F.setBuffer(a._roots[e]),ni(0,a,t,s,i,n,r),F.clearBuffer()}function ni(a,e,t,s,i,n,r){const{float32Array:l,uint16Array:o,uint32Array:c}=F,u=a*2;if(K(u,o)){const f=Z(a,c),d=J(u,o);ga(e,t,s,f,d,i,n,r)}else{const f=X(a);Ne(f,l,s,n,r)&&ni(f,e,t,s,i,n,r);const d=$(a,c);Ne(d,l,s,n,r)&&ni(d,e,t,s,i,n,r)}}const za=["x","y","z"];function Ra(a,e,t,s,i,n){F.setBuffer(a._roots[e]);const r=ri(0,a,t,s,i,n);return F.clearBuffer(),r}function ri(a,e,t,s,i,n){const{float32Array:r,uint16Array:l,uint32Array:o}=F;let c=a*2;if(K(c,l)){const h=Z(a,o),f=J(c,l);return ya(e,t,s,h,f,i,n)}else{const h=ui(a,o),f=za[h],x=s.direction[f]>=0;let w,S;x?(w=X(a),S=$(a,o)):(w=$(a,o),S=X(a));const p=Ne(w,r,s,i,n)?ri(w,e,t,s,i,n):null;if(p){const b=p.point[f];if(x?b<=r[S+h]:b>=r[S+h+3])return p}const g=Ne(S,r,s,i,n)?ri(S,e,t,s,i,n):null;return p&&g?p.distance<=g.distance?p:g:p||g||null}}const kt=new he,it=new ue,nt=new ue,yt=new ee,Xi=new te,qt=new te;function La(a,e,t,s){F.setBuffer(a._roots[e]);const i=oi(0,a,t,s);return F.clearBuffer(),i}function oi(a,e,t,s,i=null){const{float32Array:n,uint16Array:r,uint32Array:l}=F;let o=a*2;if(i===null&&(t.boundingBox||t.computeBoundingBox(),Xi.set(t.boundingBox.min,t.boundingBox.max,s),i=Xi),K(o,r)){const u=e.geometry,h=u.index,f=u.attributes.position,d=t.index,x=t.attributes.position,w=Z(a,l),S=J(o,r);if(yt.copy(s).invert(),t.boundsTree)return U(a,n,qt),qt.matrix.copy(yt),qt.needsUpdate=!0,t.boundsTree.shapecast({intersectsBounds:p=>qt.intersectsBox(p),intersectsTriangle:p=>{p.a.applyMatrix4(s),p.b.applyMatrix4(s),p.c.applyMatrix4(s),p.needsUpdate=!0;for(let m=w,g=S+w;m<g;m++)if(j(nt,3*e.resolveTriangleIndex(m),h,f),nt.needsUpdate=!0,p.intersectsTriangle(nt))return!0;return!1}});{const y=us(t);for(let p=w,m=S+w;p<m;p++){const g=e.resolveTriangleIndex(p);j(it,3*g,h,f),it.a.applyMatrix4(yt),it.b.applyMatrix4(yt),it.c.applyMatrix4(yt),it.needsUpdate=!0;for(let b=0,T=y*3;b<T;b+=3)if(j(nt,b,d,x),nt.needsUpdate=!0,it.intersectsTriangle(nt))return!0}}}else{const u=X(a),h=$(a,l);return U(u,n,kt),!!(i.intersectsBox(kt)&&oi(u,e,t,s,i)||(U(h,n,kt),i.intersectsBox(kt)&&oi(h,e,t,s,i)))}}const Ut=new ee,zs=new te,xt=new te,Ia=new v,Oa=new v,Da=new v,Ba=new v;function Na(a,e,t,s={},i={},n=0,r=1/0){e.boundingBox||e.computeBoundingBox(),zs.set(e.boundingBox.min,e.boundingBox.max,t),zs.needsUpdate=!0;const l=a.geometry,o=l.attributes.position,c=l.index,u=e.attributes.position,h=e.index,f=le.getPrimitive(),d=le.getPrimitive();let x=Ia,w=Oa,S=null,y=null;i&&(S=Da,y=Ba);let p=1/0,m=null,g=null;return Ut.copy(t).invert(),xt.matrix.copy(Ut),a.shapecast({boundsTraverseOrder:b=>zs.distanceToBox(b),intersectsBounds:(b,T,P)=>P<p&&P<r?(T&&(xt.min.copy(b.min),xt.max.copy(b.max),xt.needsUpdate=!0),!0):!1,intersectsRange:(b,T)=>{if(e.boundsTree){const P=e.boundsTree;return P.shapecast({boundsTraverseOrder:A=>xt.distanceToBox(A),intersectsBounds:(A,C,_)=>_<p&&_<r,intersectsRange:(A,C)=>{for(let _=A,E=A+C;_<E;_++){const M=P.resolveTriangleIndex(_);j(d,3*M,h,u),d.a.applyMatrix4(t),d.b.applyMatrix4(t),d.c.applyMatrix4(t),d.needsUpdate=!0;for(let z=b,R=b+T;z<R;z++){const L=a.resolveTriangleIndex(z);j(f,3*L,c,o),f.needsUpdate=!0;const B=f.distanceToTriangle(d,x,S);if(B<p&&(w.copy(x),y&&y.copy(S),p=B,m=z,g=_),B<n)return!0}}}})}else{const P=us(e);for(let A=0,C=P;A<C;A++){j(d,3*A,h,u),d.a.applyMatrix4(t),d.b.applyMatrix4(t),d.c.applyMatrix4(t),d.needsUpdate=!0;for(let _=b,E=b+T;_<E;_++){const M=a.resolveTriangleIndex(_);j(f,3*M,c,o),f.needsUpdate=!0;const z=f.distanceToTriangle(d,x,S);if(z<p&&(w.copy(x),y&&y.copy(S),p=z,m=_,g=A),z<n)return!0}}}}}),le.releasePrimitive(f),le.releasePrimitive(d),p===1/0?null:(s.point?s.point.copy(w):s.point=w.clone(),s.distance=p,s.faceIndex=m,i&&(i.point?i.point.copy(y):i.point=y.clone(),i.point.applyMatrix4(Ut),w.applyMatrix4(Ut),i.distance=w.sub(i.point).length(),i.faceIndex=g),s)}function $i(a,e,t){return a===null?null:(a.point.applyMatrix4(e.matrixWorld),a.distance=a.point.distanceTo(t.ray.origin),a.object=e,a)}const Gt=new te,jt=new cs,Wi=new v,Zi=new ee,Qi=new v,Rs=["getX","getY","getZ"];class os extends na{static serialize(e,t={}){t={cloneBuffers:!0,...t};const s=e.geometry,i=e._roots,n=e._indirectBuffer,r=s.getIndex(),l={version:1,roots:null,index:null,indirectBuffer:null};return t.cloneBuffers?(l.roots=i.map(o=>o.slice()),l.index=r?r.array.slice():null,l.indirectBuffer=n?n.slice():null):(l.roots=i,l.index=r?r.array:null,l.indirectBuffer=n),l}static deserialize(e,t,s={}){s={setIndex:!0,indirect:!!e.indirectBuffer,...s};const{index:i,roots:n,indirectBuffer:r}=e;e.version||(console.warn("MeshBVH.deserialize: Serialization format has been changed and will be fixed up. It is recommended to regenerate any stored serialized data."),o(n));const l=new os(t,{...s,[ci]:!0});if(l._roots=n,l._indirectBuffer=r||null,s.setIndex){const c=t.getIndex();if(c===null){const u=new Ye(e.index,1,!1);t.setIndex(u)}else c.array!==i&&(c.array.set(i),c.needsUpdate=!0)}return l;function o(c){for(let u=0;u<c.length;u++){const h=c[u],f=new Uint32Array(h),d=new Uint16Array(h);for(let x=0,w=h.byteLength/W;x<w;x++){const S=Y*x,y=2*S;K(y,d)||(f[S+6]=f[S+6]/Y-x)}}}}get primitiveStride(){return 3}get resolveTriangleIndex(){return this.resolvePrimitiveIndex}constructor(e,t={}){t.maxLeafTris&&(console.warn('MeshBVH: "maxLeafTris" option has been deprecated. Use maxLeafSize, instead.'),t={...t,maxLeafSize:t.maxLeafTris}),super(e,t)}shiftTriangleOffsets(e){return super.shiftPrimitiveOffsets(e)}writePrimitiveBounds(e,t,s){const i=this.geometry,n=this._indirectBuffer,r=i.attributes.position,l=i.index?i.index.array:null,c=(n?n[e]:e)*3;let u=c+0,h=c+1,f=c+2;l&&(u=l[u],h=l[h],f=l[f]);for(let d=0;d<3;d++){const x=r[Rs[d]](u),w=r[Rs[d]](h),S=r[Rs[d]](f);let y=x;w<y&&(y=w),S<y&&(y=S);let p=x;w>p&&(p=w),S>p&&(p=S),t[s+d]=y,t[s+d+3]=p}return t}computePrimitiveBounds(e,t,s){const i=this.geometry,n=this._indirectBuffer,r=i.attributes.position,l=i.index?i.index.array:null,o=r.normalized;if(e<0||t+e-s.offset>s.length/6)throw new Error("MeshBVH: compute triangle bounds range is invalid.");const c=r.array,u=r.offset||0;let h=3;r.isInterleavedBufferAttribute&&(h=r.data.stride);const f=["getX","getY","getZ"],d=s.offset;for(let x=e,w=e+t;x<w;x++){const y=(n?n[x]:x)*3,p=(x-d)*6;let m=y+0,g=y+1,b=y+2;l&&(m=l[m],g=l[g],b=l[b]),o||(m=m*h+u,g=g*h+u,b=b*h+u);for(let T=0;T<3;T++){let P,A,C;o?(P=r[f[T]](m),A=r[f[T]](g),C=r[f[T]](b)):(P=c[m+T],A=c[g+T],C=c[b+T]);let _=P;A<_&&(_=A),C<_&&(_=C);let E=P;A>E&&(E=A),C>E&&(E=C);const M=(E-_)/2,z=T*2;s[p+z+0]=_+M,s[p+z+1]=M+(Math.abs(_)+M)*Jt}}return s}raycastObject3D(e,t,s=[]){const{material:i}=e;if(i===void 0)return;Zi.copy(e.matrixWorld).invert(),jt.copy(t.ray).applyMatrix4(Zi),Qi.setFromMatrixScale(e.matrixWorld),Wi.copy(jt.direction).multiply(Qi);const n=Wi.length(),r=t.near/n,l=t.far/n;if(t.firstHitOnly===!0){let o=this.raycastFirst(jt,i,r,l);o=$i(o,e,t),o&&s.push(o)}else{const o=this.raycast(jt,i,r,l);for(let c=0,u=o.length;c<u;c++){const h=$i(o[c],e,t);h&&s.push(h)}}return s}refit(e=null){return(this.indirect?va:pa)(this,e)}raycast(e,t=Xs,s=0,i=1/0){const n=this._roots,r=[],l=this.indirect?Ea:ba;for(let o=0,c=n.length;o<c;o++)l(this,o,t,e,r,s,i);return r}raycastFirst(e,t=Xs,s=0,i=1/0){const n=this._roots;let r=null;const l=this.indirect?Ra:wa;for(let o=0,c=n.length;o<c;o++){const u=l(this,o,t,e,s,i);u!=null&&(r==null||u.distance<r.distance)&&(r=u)}return r}intersectsGeometry(e,t){let s=!1;const i=this._roots,n=this.indirect?La:Pa;for(let r=0,l=i.length;r<l&&(s=n(this,r,e,t),!s);r++);return s}shapecast(e){const t=le.getPrimitive(),s=super.shapecast({...e,intersectsPrimitive:e.intersectsTriangle,scratchPrimitive:t,iterate:this.indirect?xa:ma});return le.releasePrimitive(t),s}bvhcast(e,t,s){let{intersectsRanges:i,intersectsTriangles:n}=s;const r=le.getPrimitive(),l=this.geometry.index,o=this.geometry.attributes.position,c=this.indirect?x=>{const w=this.resolveTriangleIndex(x);j(r,w*3,l,o)}:x=>{j(r,x*3,l,o)},u=le.getPrimitive(),h=e.geometry.index,f=e.geometry.attributes.position,d=e.indirect?x=>{const w=e.resolveTriangleIndex(x);j(u,w*3,h,f)}:x=>{j(u,x*3,h,f)};if(n){if(!(e instanceof os))throw new Error('MeshBVH: "intersectsTriangles" callback can only be used with another MeshBVH.');const x=(w,S,y,p,m,g,b,T)=>{for(let P=y,A=y+p;P<A;P++){d(P),u.a.applyMatrix4(t),u.b.applyMatrix4(t),u.c.applyMatrix4(t),u.needsUpdate=!0;for(let C=w,_=w+S;C<_;C++)if(c(C),r.needsUpdate=!0,n(r,u,C,P,m,g,b,T))return!0}return!1};if(i){const w=i;i=function(S,y,p,m,g,b,T,P){return w(S,y,p,m,g,b,T,P)?!0:x(S,y,p,m,g,b,T,P)}}else i=x}return super.bvhcast(e,t,{intersectsRanges:i})}intersectsBox(e,t){return Gt.set(e.min,e.max,t),Gt.needsUpdate=!0,this.shapecast({intersectsBounds:s=>Gt.intersectsBox(s),intersectsTriangle:s=>Gt.intersectsTriangle(s)})}intersectsSphere(e){return this.shapecast({intersectsBounds:t=>e.intersectsBox(t),intersectsTriangle:t=>t.intersectsSphere(e)})}closestPointToGeometry(e,t,s={},i={},n=0,r=1/0){return(this.indirect?Na:Ca)(this,e,t,s,i,n,r)}closestPointToPoint(e,t={},s=0,i=1/0){return ca(this,e,t,s,i)}}const Nn=1e-6,Ha=Nn*.5,Hn=Math.pow(10,-Math.log10(Nn)),Fa=Ha*Hn;function ye(a){return~~(a*Hn+Fa)}function ka(a){return`${ye(a.x)},${ye(a.y)}`}function Ji(a){return`${ye(a.x)},${ye(a.y)},${ye(a.z)}`}function qa(a){return`${ye(a.x)},${ye(a.y)},${ye(a.z)},${ye(a.w)}`}function Ua(a,e,t){t.direction.subVectors(e,a).normalize();const s=a.dot(t.direction);return t.origin.copy(a).addScaledVector(t.direction,-s),t}function Fn(){return typeof SharedArrayBuffer<"u"}function Ga(a){if(a.buffer instanceof SharedArrayBuffer)return a;const e=a.constructor,t=a.buffer,s=new SharedArrayBuffer(t.byteLength),i=new Uint8Array(t);return new Uint8Array(s).set(i,0),new e(s)}function ja(a,e=ArrayBuffer){return a>65535?new Uint32Array(new e(4*a)):new Uint16Array(new e(2*a))}function Va(a,e){if(!a.index){const t=a.attributes.position.count,s=e.useSharedArrayBuffer?SharedArrayBuffer:ArrayBuffer,i=ja(t,s);a.setIndex(new Ye(i,1));for(let n=0;n<t;n++)i[n]=n}}function Ya(a){return a.index?a.index.count:a.attributes.position.count}function mi(a){return Ya(a)/3}const Ka=1e-8,Xa=new v;function $a(a){return~~(a/3)}function Wa(a){return a%3}function en(a,e){return a.start-e.start}function tn(a,e){return Xa.subVectors(e,a.origin).dot(a.direction)}function Za(a,e,t,s=Ka){a.sort(en),e.sort(en);for(let l=0;l<a.length;l++){const o=a[l];for(let c=0;c<e.length;c++){const u=e[c];if(!(u.start>o.end)){if(o.end<u.start||u.end<o.start)continue;if(o.start<=u.start&&o.end>=u.end)n(u.end,o.end)||a.splice(l+1,0,{start:u.end,end:o.end,index:o.index}),o.end=u.start,u.start=0,u.end=0;else if(o.start>=u.start&&o.end<=u.end)n(o.end,u.end)||e.splice(c+1,0,{start:o.end,end:u.end,index:u.index}),u.end=o.start,o.start=0,o.end=0;else if(o.start<=u.start&&o.end<=u.end){const h=o.end;o.end=u.start,u.start=h}else if(o.start>=u.start&&o.end>=u.end){const h=u.end;u.end=o.start,o.start=h}else throw new Error}if(t.has(o.index)||t.set(o.index,[]),t.has(u.index)||t.set(u.index,[]),t.get(o.index).push(u.index),t.get(u.index).push(o.index),r(u)&&(e.splice(c,1),c--),r(o)){a.splice(l,1),l--;break}}}i(a),i(e);function i(l){for(let o=0;o<l.length;o++)r(l[o])&&(l.splice(o,1),o--)}function n(l,o){return Math.abs(o-l)<s}function r(l){return Math.abs(l.end-l.start)<s}}const sn=1e-5,nn=1e-4;class Qa{constructor(){this._rays=[]}addRay(e){this._rays.push(e)}findClosestRay(e){const t=this._rays,s=e.clone();s.direction.multiplyScalar(-1);let i=1/0,n=null;for(let o=0,c=t.length;o<c;o++){const u=t[o];if(r(u,e)&&r(u,s))continue;const h=l(u,e),f=l(u,s),d=Math.min(h,f);d<i&&(i=d,n=u)}return n;function r(o,c){const u=o.origin.distanceTo(c.origin)>sn;return o.direction.angleTo(c.direction)>nn||u}function l(o,c){const u=o.origin.distanceTo(c.origin),h=o.direction.angleTo(c.direction);return u/sn+h/nn}}}const Ls=new v,Is=new v,Vt=new cs;function Ja(a,e,t){const s=a.attributes,i=a.index,n=s.position,r=new Map,l=new Map,o=Array.from(e),c=new Qa;for(let u=0,h=o.length;u<h;u++){const f=o[u],d=$a(f),x=Wa(f);let w=3*d+x,S=3*d+(x+1)%3;i&&(w=i.getX(w),S=i.getX(S)),Ls.fromBufferAttribute(n,w),Is.fromBufferAttribute(n,S),Ua(Ls,Is,Vt);let y,p=c.findClosestRay(Vt);p===null&&(p=Vt.clone(),c.addRay(p)),l.has(p)||l.set(p,{forward:[],reverse:[],ray:p}),y=l.get(p);let m=tn(p,Ls),g=tn(p,Is);m>g&&([m,g]=[g,m]),Vt.direction.dot(p.direction)<0?y.reverse.push({start:m,end:g,index:f}):y.forward.push({start:m,end:g,index:f})}return l.forEach(({forward:u,reverse:h},f)=>{Za(u,h,r,t),u.length===0&&h.length===0&&l.delete(f)}),{disjointConnectivityMap:r,fragmentMap:l}}const el=new q,Os=new v,tl=new Xe,Ds=["","",""];class sl{constructor(e=null){this.data=null,this.disjointConnections=null,this.unmatchedDisjointEdges=null,this.unmatchedEdges=-1,this.matchedEdges=-1,this.useDrawRange=!0,this.useAllAttributes=!1,this.matchDisjointEdges=!1,this.degenerateEpsilon=1e-8,e&&this.updateFrom(e)}getSiblingTriangleIndex(e,t){const s=this.data[e*3+t];return s===-1?-1:~~(s/3)}getSiblingEdgeIndex(e,t){const s=this.data[e*3+t];return s===-1?-1:s%3}getDisjointSiblingTriangleIndices(e,t){const s=e*3+t,i=this.disjointConnections.get(s);return i?i.map(n=>~~(n/3)):[]}getDisjointSiblingEdgeIndices(e,t){const s=e*3+t,i=this.disjointConnections.get(s);return i?i.map(n=>n%3):[]}isFullyConnected(){return this.unmatchedEdges===0}updateFrom(e){const{useAllAttributes:t,useDrawRange:s,matchDisjointEdges:i,degenerateEpsilon:n}=this,r=t?m:p,l=new Map,{attributes:o}=e,c=t?Object.keys(o):null,u=e.index,h=o.position;let f=mi(e);const d=f;let x=0;s&&(x=e.drawRange.start,e.drawRange.count!==1/0&&(f=~~(e.drawRange.count/3)));let w=this.data;(!w||w.length<3*d)&&(w=new Int32Array(3*d)),w.fill(-1);let S=0,y=new Set;for(let g=x,b=f*3+x;g<b;g+=3){const T=g;for(let P=0;P<3;P++){let A=T+P;u&&(A=u.getX(A)),Ds[P]=r(A)}for(let P=0;P<3;P++){const A=(P+1)%3,C=Ds[P],_=Ds[A],E=`${_}_${C}`;if(l.has(E)){const M=T+P,z=l.get(E);w[M]=z,w[z]=M,l.delete(E),S+=2,y.delete(z)}else{const M=`${C}_${_}`,z=T+P;l.set(M,z),y.add(z)}}}if(i){const{fragmentMap:g,disjointConnectivityMap:b}=Ja(e,y,n);y.clear(),g.forEach(({forward:T,reverse:P})=>{T.forEach(({index:A})=>y.add(A)),P.forEach(({index:A})=>y.add(A))}),this.unmatchedDisjointEdges=g,this.disjointConnections=b,S=f*3-y.size}this.matchedEdges=S,this.unmatchedEdges=y.size,this.data=w;function p(g){return Os.fromBufferAttribute(h,g),Ji(Os)}function m(g){let b="";for(let T=0,P=c.length;T<P;T++){const A=o[c[T]];let C;switch(A.itemSize){case 1:C=ye(A.getX(g));break;case 2:C=ka(el.fromBufferAttribute(A,g));break;case 3:C=Ji(Os.fromBufferAttribute(A,g));break;case 4:C=qa(tl.fromBufferAttribute(A,g));break}b!==""&&(b+="|"),b+=C}return b}}}class as extends D{constructor(...e){super(...e),this.isBrush=!0,this._previousMatrix=new ee,this._previousMatrix.elements.fill(0)}markUpdated(){this._previousMatrix.copy(this.matrix)}isDirty(){const{matrix:e,_previousMatrix:t}=this,s=e.elements,i=t.elements;for(let n=0;n<16;n++)if(s[n]!==i[n])return!0;return!1}prepareGeometry(){const e=this.geometry,t=e.attributes,s=Fn();if(s)for(const i in t){const n=t[i];if(n.isInterleavedBufferAttribute)throw new Error("Brush: InterleavedBufferAttributes are not supported.");n.array=Ga(n.array)}if(e.boundsTree||(Va(e,{useSharedArrayBuffer:s}),e.boundsTree=new os(e,{maxLeafTris:3,indirect:!0,useSharedArrayBuffer:s})),e.halfEdges||(e.halfEdges=new sl(e)),!e.groupIndices){const i=mi(e),n=new Uint16Array(i),r=e.groups;for(let l=0,o=r.length;l<o;l++){const{start:c,count:u}=r[l];for(let h=c/3,f=(c+u)/3;h<f;h++)n[h]=l}e.groupIndices=n}}disposeCacheData(){const{geometry:e}=this;e.halfEdges=null,e.boundsTree=null,e.groupIndices=null}}const il=1e-14,Bs=new v,rn=new v,on=new v;function Re(a,e=il){Bs.subVectors(a.b,a.a),rn.subVectors(a.c,a.a),on.subVectors(a.b,a.c);const t=Bs.angleTo(rn),s=Bs.angleTo(on),i=Math.PI-t-s;return Math.abs(t)<e||Math.abs(s)<e||Math.abs(i)<e||a.a.distanceToSquared(a.b)<e||a.a.distanceToSquared(a.c)<e||a.b.distanceToSquared(a.c)<e}const Ns=1e-10,bt=1e-10,nl=1e-10,be=new ce,G=new ce,Se=new v,Hs=new v,an=new v,Yt=new me,Fs=new ue;class rl{constructor(){this._pool=[],this._index=0}getTriangle(){return this._index>=this._pool.length&&this._pool.push(new ie),this._pool[this._index++]}clear(){this._index=0}reset(){this._pool.length=0,this._index=0}}class ol{constructor(){this.trianglePool=new rl,this.triangles=[],this.normal=new v,this.coplanarTriangleUsed=!1}initialize(e){this.reset();const{triangles:t,trianglePool:s,normal:i}=this;if(Array.isArray(e))for(let n=0,r=e.length;n<r;n++){const l=e[n];if(n===0)l.getNormal(i);else if(Math.abs(1-l.getNormal(Se).dot(i))>Ns)throw new Error("Triangle Splitter: Cannot initialize with triangles that have different normals.");const o=s.getTriangle();o.copy(l),t.push(o)}else{e.getNormal(i);const n=s.getTriangle();n.copy(e),t.push(n)}}splitByTriangle(e){const{normal:t,triangles:s}=this;if(e.getNormal(Hs).normalize(),Math.abs(1-Math.abs(Hs.dot(t)))<nl){this.coplanarTriangleUsed=!0;for(let n=0,r=s.length;n<r;n++){const l=s[n];l.coplanarCount=0}const i=[e.a,e.b,e.c];for(let n=0;n<3;n++){const r=(n+1)%3,l=i[n],o=i[r];Se.subVectors(o,l).normalize(),an.crossVectors(Hs,Se),Yt.setFromNormalAndCoplanarPoint(an,l),this.splitByPlane(Yt,e)}}else e.getPlane(Yt),this.splitByPlane(Yt,e)}splitByPlane(e,t){const{triangles:s,trianglePool:i}=this;Fs.copy(t),Fs.needsUpdate=!0;for(let n=0,r=s.length;n<r;n++){const l=s[n];if(!Fs.intersectsTriangle(l,be,!0))continue;const{a:o,b:c,c:u}=l;let h=0,f=-1,d=!1,x=[],w=[];const S=[o,c,u];for(let y=0;y<3;y++){const p=(y+1)%3;be.start.copy(S[y]),be.end.copy(S[p]);const m=e.distanceToPoint(be.start),g=e.distanceToPoint(be.end);if(Math.abs(m)<bt&&Math.abs(g)<bt){d=!0;break}if(m>0?x.push(y):w.push(y),Math.abs(m)<bt)continue;let b=!!e.intersectLine(be,Se);!b&&Math.abs(g)<bt&&(Se.copy(be.end),b=!0),b&&!(Se.distanceTo(be.start)<Ns)&&(Se.distanceTo(be.end)<Ns&&(f=y),h===0?G.start.copy(Se):G.end.copy(Se),h++)}if(!d&&h===2&&G.distance()>bt)if(f!==-1){f=(f+1)%3;let y=0;y===f&&(y=(y+1)%3);let p=y+1;p===f&&(p=(p+1)%3);const m=i.getTriangle();m.a.copy(S[p]),m.b.copy(G.end),m.c.copy(G.start),Re(m)||s.push(m),l.a.copy(S[y]),l.b.copy(G.start),l.c.copy(G.end),Re(l)&&(s.splice(n,1),n--,r--)}else{const y=x.length>=2?w[0]:x[0];if(y===0){let T=G.start;G.start=G.end,G.end=T}const p=(y+1)%3,m=(y+2)%3,g=i.getTriangle(),b=i.getTriangle();S[p].distanceToSquared(G.start)<S[m].distanceToSquared(G.end)?(g.a.copy(S[p]),g.b.copy(G.start),g.c.copy(G.end),b.a.copy(S[p]),b.b.copy(S[m]),b.c.copy(G.start)):(g.a.copy(S[m]),g.b.copy(G.start),g.c.copy(G.end),b.a.copy(S[p]),b.b.copy(S[m]),b.c.copy(G.end)),l.a.copy(S[y]),l.b.copy(G.end),l.c.copy(G.start),Re(g)||s.push(g),Re(b)||s.push(b),Re(l)&&(s.splice(n,1),n--,r--)}else h===3&&console.warn("TriangleClipper: Coplanar clip not handled")}}reset(){this.triangles.length=0,this.trianglePool.clear(),this.coplanarTriangleUsed=!1}}function al(a){return a=~~a,a+4-a%4}class ln{constructor(e,t=500){this.expansionFactor=1.5,this.type=e,this.length=0,this.array=null,this.setSize(t)}setType(e){if(this.length!==0)throw new Error("TypeBackedArray: Cannot change the type while there is used data in the buffer.");const t=this.array.buffer;this.array=new e(t),this.type=e}setSize(e){if(this.array&&e===this.array.length)return;const t=this.type,s=Fn()?SharedArrayBuffer:ArrayBuffer,i=new t(new s(al(e*t.BYTES_PER_ELEMENT)));this.array&&i.set(this.array,0),this.array=i}expand(){const{array:e,expansionFactor:t}=this;this.setSize(e.length*t)}push(...e){let{array:t,length:s}=this;s+e.length>t.length&&(this.expand(),t=this.array);for(let i=0,n=e.length;i<n;i++)t[s+i]=e[i];this.length+=e.length}clear(){this.length=0}}class ll{constructor(){this.groupAttributes=[{}],this.groupCount=0}getType(e){return this.groupAttributes[0][e].type}getItemSize(e){return this.groupAttributes[0][e].itemSize}getNormalized(e){return this.groupAttributes[0][e].normalized}getCount(e){if(this.groupCount<=e)return 0;const t=this.getGroupAttrArray("position",e);return t.length/t.itemSize}getTotalLength(e){const{groupCount:t,groupAttributes:s}=this;let i=0;for(let n=0;n<t;n++){const r=s[n];i+=r[e].length}return i}getGroupAttrSet(e=0){const{groupAttributes:t}=this;if(t[e])return this.groupCount=Math.max(this.groupCount,e+1),t[e];const s=t[0];for(this.groupCount=Math.max(this.groupCount,e+1);e>=t.length;){const i={};t.push(i);for(const n in s){const r=s[n],l=new ln(r.type);l.itemSize=r.itemSize,l.normalized=r.normalized,i[n]=l}}return t[e]}getGroupAttrArray(e,t=0){const{groupAttributes:s}=this;if(!s[0][e])throw new Error(`TypedAttributeData: Attribute with "${e}" has not been initialized`);return this.getGroupAttrSet(t)[e]}initializeArray(e,t,s,i){const{groupAttributes:n}=this,l=n[0][e];if(l){if(l.type!==t)for(let o=0,c=n.length;o<c;o++){const u=n[o][e];u.setType(t),u.itemSize=s,u.normalized=i}}else for(let o=0,c=n.length;o<c;o++){const u=new ln(t);u.itemSize=s,u.normalized=i,n[o][e]=u}}clear(){this.groupCount=0;const{groupAttributes:e}=this;e.forEach(t=>{for(const s in t)t[s].clear()})}delete(e){this.groupAttributes.forEach(t=>{delete t[e]})}reset(){this.groupAttributes=[],this.groupCount=0}}class cn{constructor(){this.intersectionSet={},this.ids=[]}add(e,t){const{intersectionSet:s,ids:i}=this;s[e]||(s[e]=[],i.push(e)),s[e].push(t)}}const cl=0,ul=1,hl=2,kn=3,fl=4,qn=5,Un=6,ae=new cs,un=new ee,Q=new ie,we=new v,hn=new Xe,fn=new Xe,dn=new Xe,ks=new Xe,Kt=new Xe,Xt=new Xe,mn=new ce,qs=new v,Us=1e-8,dl=1e-15,je=-1,Ve=1,ts=-2,ss=2,Pt=0,Ue=1,pi=2,ml=1e-14;let is=null;function pn(a){is=a}function Gn(a,e){a.getMidpoint(ae.origin),a.getNormal(ae.direction);const t=e.raycastFirst(ae,k);return!!(t&&ae.direction.dot(t.face.normal)>0)?je:Ve}function pl(a,e){function t(){return Math.random()-.5}a.getNormal(qs),ae.direction.copy(qs),a.getMidpoint(ae.origin);const s=3;let i=0,n=1/0;for(let r=0;r<s;r++){ae.direction.x+=t()*Us,ae.direction.y+=t()*Us,ae.direction.z+=t()*Us,ae.direction.multiplyScalar(-1);const l=e.raycastFirst(ae,k);if(l&&ae.direction.dot(l.face.normal)>0&&i++,l!==null&&(n=Math.min(n,l.distance)),n<=dl)return l.face.normal.dot(qs)>0?ss:ts;if(i/s>.5||(r-i+1)/s>.5)break}return i/s>.5?je:Ve}function gl(a,e){const t=new cn,s=new cn;return un.copy(a.matrixWorld).invert().multiply(e.matrixWorld),a.geometry.boundsTree.bvhcast(e.geometry.boundsTree,un,{intersectsTriangles(i,n,r,l){if(!Re(i)&&!Re(n)){let o=i.intersectsTriangle(n,mn,!0);if(!o){const c=i.plane,u=n.plane,h=c.normal,f=u.normal;h.dot(f)===1&&Math.abs(c.constant-u.constant)<ml&&(o=!0)}if(o){let c=a.geometry.boundsTree.resolveTriangleIndex(r),u=e.geometry.boundsTree.resolveTriangleIndex(l);t.add(c,u),s.add(u,c),is&&(is.addEdge(mn),is.addIntersectingTriangles(r,i,l,n))}}return!1}}),{aIntersections:t,bIntersections:s}}function yl(a,e,t,s,i,n,r=!1){const l=t.attributes,o=t.index,c=a*3,u=o.getX(c+0),h=o.getX(c+1),f=o.getX(c+2);for(const d in n){const x=l[d],w=n[d];if(!(d in l))throw new Error(`CSG Operations: Attribute ${d} not available on geometry.`);const S=x.itemSize;d==="position"?(Q.a.fromBufferAttribute(x,u).applyMatrix4(s),Q.b.fromBufferAttribute(x,h).applyMatrix4(s),Q.c.fromBufferAttribute(x,f).applyMatrix4(s),Gs(Q.a,Q.b,Q.c,e,3,w,r)):d==="normal"?(Q.a.fromBufferAttribute(x,u).applyNormalMatrix(i),Q.b.fromBufferAttribute(x,h).applyNormalMatrix(i),Q.c.fromBufferAttribute(x,f).applyNormalMatrix(i),r&&(Q.a.multiplyScalar(-1),Q.b.multiplyScalar(-1),Q.c.multiplyScalar(-1)),Gs(Q.a,Q.b,Q.c,e,3,w,r,!0)):(hn.fromBufferAttribute(x,u),fn.fromBufferAttribute(x,h),dn.fromBufferAttribute(x,f),Gs(hn,fn,dn,e,S,w,r))}}function xl(a,e,t,s,i,n,r,l=!1){js(a,s,i,n,r,l),js(l?t:e,s,i,n,r,l),js(l?e:t,s,i,n,r,l)}function jn(a,e,t=!1){switch(a){case cl:if(e===Ve||e===ss&&!t)return Ue;break;case ul:if(t){if(e===je)return Pt}else if(e===Ve||e===ts)return Ue;break;case hl:if(t){if(e===Ve||e===ts)return Ue}else if(e===je)return Pt;break;case fl:if(e===je)return Pt;if(e===Ve)return Ue;break;case kn:if(e===je||e===ss&&!t)return Ue;break;case qn:if(!t&&(e===Ve||e===ts))return Ue;break;case Un:if(!t&&(e===je||e===ss))return Ue;break;default:throw new Error(`Unrecognized CSG operation enum "${a}".`)}return pi}function Gs(a,e,t,s,i,n,r=!1,l=!1){const o=c=>{n.push(c.x),i>1&&n.push(c.y),i>2&&n.push(c.z),i>3&&n.push(c.w)};ks.set(0,0,0,0).addScaledVector(a,s.a.x).addScaledVector(e,s.a.y).addScaledVector(t,s.a.z),Kt.set(0,0,0,0).addScaledVector(a,s.b.x).addScaledVector(e,s.b.y).addScaledVector(t,s.b.z),Xt.set(0,0,0,0).addScaledVector(a,s.c.x).addScaledVector(e,s.c.y).addScaledVector(t,s.c.z),l&&(ks.normalize(),Kt.normalize(),Xt.normalize()),o(ks),r?(o(Xt),o(Kt)):(o(Kt),o(Xt))}function js(a,e,t,s,i,n=!1){for(const r in i){const l=e[r],o=i[r];if(!(r in e))throw new Error(`CSG Operations: Attribute ${r} no available on geometry.`);const c=l.itemSize;r==="position"?(we.fromBufferAttribute(l,a).applyMatrix4(t),o.push(we.x,we.y,we.z)):r==="normal"?(we.fromBufferAttribute(l,a).applyNormalMatrix(s),n&&we.multiplyScalar(-1),o.push(we.x,we.y,we.z)):(o.push(l.getX(a)),c>1&&o.push(l.getY(a)),c>2&&o.push(l.getZ(a)),c>3&&o.push(l.getW(a)))}}class bl{constructor(e){this.triangle=new ie().copy(e),this.intersects={}}addTriangle(e,t){this.intersects[e]=new ie().copy(t)}getIntersectArray(){const e=[],{intersects:t}=this;for(const s in t)e.push(t[s]);return e}}class gn{constructor(){this.data={}}addTriangleIntersection(e,t,s,i){const{data:n}=this;n[e]||(n[e]=new bl(t)),n[e].addTriangle(s,i)}getTrianglesAsArray(e=null){const{data:t}=this,s=[];if(e!==null)e in t&&s.push(t[e].triangle);else for(const i in t)s.push(t[i].triangle);return s}getTriangleIndices(){return Object.keys(this.data).map(e=>parseInt(e))}getIntersectionIndices(e){const{data:t}=this;return t[e]?Object.keys(t[e].intersects).map(s=>parseInt(s)):[]}getIntersectionsAsArray(e=null,t=null){const{data:s}=this,i=new Set,n=[],r=l=>{if(s[l])if(t!==null)s[l].intersects[t]&&n.push(s[l].intersects[t]);else{const o=s[l].intersects;for(const c in o)i.has(c)||(i.add(c),n.push(o[c]))}};if(e!==null)r(e);else for(const l in s)r(l);return n}reset(){this.data={}}}class Sl{constructor(){this.enabled=!1,this.triangleIntersectsA=new gn,this.triangleIntersectsB=new gn,this.intersectionEdges=[]}addIntersectingTriangles(e,t,s,i){const{triangleIntersectsA:n,triangleIntersectsB:r}=this;n.addTriangleIntersection(e,t,s,i),r.addTriangleIntersection(s,i,e,t)}addEdge(e){this.intersectionEdges.push(e.clone())}reset(){this.triangleIntersectsA.reset(),this.triangleIntersectsB.reset(),this.intersectionEdges=[]}init(){this.enabled&&(this.reset(),pn(this))}complete(){this.enabled&&pn(null)}}const Oe=new ee,ls=new Ir,Ge=new ie,$t=new ie,ve=new ie,Wt=new ie,pe=[],Ke=[];function wl(a){for(const e of a)return e}function Pl(a,e,t,s,i,n={}){const{useGroups:r=!0}=n,{aIntersections:l,bIntersections:o}=gl(a,e),c=[];let u=null,h;return h=r?0:-1,yn(a,e,l,t,!1,s,i,h),xn(a,e,l,t,!1,i,h),t.findIndex(d=>d!==Un&&d!==qn)!==-1&&(h=r?a.geometry.groups.length||1:-1,yn(e,a,o,t,!0,s,i,h),xn(e,a,o,t,!0,i,h)),pe.length=0,Ke.length=0,{groups:c,materials:u}}function yn(a,e,t,s,i,n,r,l=0){const o=a.matrixWorld.determinant()<0;Oe.copy(e.matrixWorld).invert().multiply(a.matrixWorld),ls.getNormalMatrix(a.matrixWorld).multiplyScalar(o?-1:1);const c=a.geometry.groupIndices,u=a.geometry.index,h=a.geometry.attributes.position,f=e.geometry.boundsTree,d=e.geometry.index,x=e.geometry.attributes.position,w=t.ids,S=t.intersectionSet;for(let y=0,p=w.length;y<p;y++){const m=w[y],g=l===-1?0:c[m]+l,b=3*m,T=u.getX(b+0),P=u.getX(b+1),A=u.getX(b+2);Ge.a.fromBufferAttribute(h,T).applyMatrix4(Oe),Ge.b.fromBufferAttribute(h,P).applyMatrix4(Oe),Ge.c.fromBufferAttribute(h,A).applyMatrix4(Oe),n.reset(),n.initialize(Ge);const C=S[m];for(let E=0,M=C.length;E<M;E++){const z=3*C[E],R=d.getX(z+0),L=d.getX(z+1),B=d.getX(z+2);$t.a.fromBufferAttribute(x,R),$t.b.fromBufferAttribute(x,L),$t.c.fromBufferAttribute(x,B),n.splitByTriangle($t)}const _=n.triangles;for(let E=0,M=_.length;E<M;E++){const z=_[E],R=n.coplanarTriangleUsed?pl(z,f):Gn(z,f);pe.length=0,Ke.length=0;for(let L=0,B=s.length;L<B;L++){const fe=jn(s[L],R,i);fe!==pi&&(Ke.push(fe),pe.push(r[L].getGroupAttrSet(g)))}if(pe.length!==0){Ge.getBarycoord(z.a,Wt.a),Ge.getBarycoord(z.b,Wt.b),Ge.getBarycoord(z.c,Wt.c);for(let L=0,B=pe.length;L<B;L++){const fe=pe[L],Ct=Ke[L]===Pt;yl(m,Wt,a.geometry,a.matrixWorld,ls,fe,o!==Ct)}}}}return w.length}function xn(a,e,t,s,i,n,r=0){const l=a.matrixWorld.determinant()<0;Oe.copy(e.matrixWorld).invert().multiply(a.matrixWorld),ls.getNormalMatrix(a.matrixWorld).multiplyScalar(l?-1:1);const o=e.geometry.boundsTree,c=a.geometry.groupIndices,u=a.geometry.index,h=a.geometry.attributes,f=h.position,d=[],x=a.geometry.halfEdges,w=new Set,S=mi(a.geometry);for(let y=0,p=S;y<p;y++)y in t.intersectionSet||w.add(y);for(;w.size>0;){const y=wl(w);w.delete(y),d.push(y);const p=3*y,m=u.getX(p+0),g=u.getX(p+1),b=u.getX(p+2);ve.a.fromBufferAttribute(f,m).applyMatrix4(Oe),ve.b.fromBufferAttribute(f,g).applyMatrix4(Oe),ve.c.fromBufferAttribute(f,b).applyMatrix4(Oe);const T=Gn(ve,o);Ke.length=0,pe.length=0;for(let P=0,A=s.length;P<A;P++){const C=jn(s[P],T,i);C!==pi&&(Ke.push(C),pe.push(n[P]))}for(;d.length>0;){const P=d.pop();for(let A=0;A<3;A++){const C=x.getSiblingTriangleIndex(P,A);C!==-1&&w.has(C)&&(d.push(C),w.delete(C))}if(pe.length!==0){const A=3*P,C=u.getX(A+0),_=u.getX(A+1),E=u.getX(A+2),M=r===-1?0:c[P]+r;if(ve.a.fromBufferAttribute(f,C),ve.b.fromBufferAttribute(f,_),ve.c.fromBufferAttribute(f,E),!Re(ve))for(let z=0,R=pe.length;z<R;z++){const L=Ke[z],B=pe[z].getGroupAttrSet(M),fe=L===Pt;xl(C,_,E,h,a.matrixWorld,ls,B,fe!==l)}}}}}function Tl(a){for(let e=0;e<a.length-1;e++){const t=a[e],s=a[e+1];if(t.materialIndex===s.materialIndex){const i=t.start,n=s.start+s.count;s.start=i,s.count=n-i,a.splice(e,1),e--}}}function Al(a,e,t,s){t.clear();const i=a.attributes;for(let n=0,r=s.length;n<r;n++){const l=s[n],o=i[l];t.initializeArray(l,o.array.constructor,o.itemSize,o.normalized)}for(const n in t.attributes)s.includes(n)||t.delete(n);for(const n in e.attributes)s.includes(n)||(e.deleteAttribute(n),e.dispose())}function _l(a,e,t){let s=!1,i=-1;const n=a.attributes,r=e.groupAttributes[0];for(const o in r){const c=e.getTotalLength(o),u=e.getType(o),h=e.getItemSize(o),f=e.getNormalized(o);let d=n[o];(!d||d.array.length<c)&&(d=new Ye(new u(c),h,f),a.setAttribute(o,d),s=!0);let x=0;for(let w=0,S=Math.min(t.length,e.groupCount);w<S;w++){const y=t[w].index,{array:p,type:m,length:g}=e.groupAttributes[y][o],b=new m(p.buffer,0,g);d.array.set(b,x),x+=b.length}d.needsUpdate=!0,i=c/d.itemSize}if(a.index){const o=a.index.array;if(o.length<i)a.index=null,s=!0;else for(let c=0,u=o.length;c<u;c++)o[c]=c}let l=0;a.clearGroups();for(let o=0,c=Math.min(t.length,e.groupCount);o<c;o++){const{index:u,materialIndex:h}=t[o],f=e.getCount(u);f!==0&&(a.addGroup(l,f,h),l+=f)}a.setDrawRange(0,i),a.boundsTree=null,s&&a.dispose()}function bn(a,e){let t=e;return Array.isArray(e)||(t=[],a.forEach(s=>{t[s.materialIndex]=e})),t}class Ml{constructor(){this.triangleSplitter=new ol,this.attributeData=[],this.attributes=["position","uv","normal"],this.useGroups=!0,this.consolidateGroups=!0,this.debug=new Sl}getGroupRanges(e){return!this.useGroups||e.groups.length===0?[{start:0,count:1/0,materialIndex:0}]:e.groups.map(t=>({...t}))}evaluate(e,t,s,i=new as){let n=!0;if(Array.isArray(s)||(s=[s]),Array.isArray(i)||(i=[i],n=!1),i.length!==s.length)throw new Error("Evaluator: operations and target array passed as different sizes.");e.prepareGeometry(),t.prepareGeometry();const{triangleSplitter:r,attributeData:l,attributes:o,useGroups:c,consolidateGroups:u,debug:h}=this;for(;l.length<i.length;)l.push(new ll);i.forEach((y,p)=>{Al(e.geometry,y.geometry,l[p],o)}),h.init(),Pl(e,t,s,r,l,{useGroups:c}),h.complete();const f=this.getGroupRanges(e.geometry),d=bn(f,e.material),x=this.getGroupRanges(t.geometry),w=bn(x,t.material);x.forEach(y=>y.materialIndex+=d.length);let S=[...f,...x].map((y,p)=>({...y,index:p}));if(c){const y=[...d,...w];u&&(S=S.map(m=>{const g=y[m.materialIndex];return m.materialIndex=y.indexOf(g),m}).sort((m,g)=>m.materialIndex-g.materialIndex));const p=[];for(let m=0,g=y.length;m<g;m++){let b=!1;for(let T=0,P=S.length;T<P;T++){const A=S[T];A.materialIndex===m&&(b=!0,A.materialIndex=p.length)}b&&p.push(y[m])}i.forEach(m=>{m.material=p})}else S=[{start:0,count:1/0,index:0,materialIndex:0}],i.forEach(y=>{y.material=d[0]});return i.forEach((y,p)=>{const m=y.geometry;_l(m,l[p],S),u&&Tl(m.groups)}),n?i:i[0]}evaluateHierarchy(e,t=new as){e.updateMatrixWorld(!0);const s=(n,r)=>{const l=n.children;for(let o=0,c=l.length;o<c;o++){const u=l[o];u.isOperationGroup?s(u,r):r(u)}},i=n=>{const r=n.children;let l=!1;for(let c=0,u=r.length;c<u;c++){const h=r[c];l=i(h)||l}const o=n.isDirty();if(o&&n.markUpdated(),l&&!n.isOperationGroup){let c;return s(n,u=>{c?c=this.evaluate(c,u,u.operation):c=this.evaluate(n,u,u.operation)}),n._cachedGeometry=c.geometry,n._cachedMaterials=c.material,!0}else return l||o};return i(e),t.geometry=e._cachedGeometry,t.material=e._cachedMaterials,t}reset(){this.triangleSplitter.reset()}}class Sn{constructor(){this.renderer=new $r,this.previewSceneManager=new ut,this.workSceneManager=new ut,this.modelLoader=new No,this.testObject=null,this.previewObject=null,this.workSphere=null,this.gizmoYOffset=2.2,this.initialRotation=null,this.previewCameraManager=this.createPreviewCamera(),this.transverseCameraManager=this.createTransverseCamera(),this.coronalCameraManager=this.createCoronalCamera(),this.sagittalCameraManager=this.createSagittalCamera(),this.createTransverseSummaryGizmo(),this.createCoronalSummaryGizmo(),this.createSagittalSummaryGizmo(),this.createSliceIndicators(),this.workCameraManager=new Xr(this.renderer.workRenderer,{type:"orthographic",frustumSize:12,aspect:1.6}),this.initialCameraPosition=this.workCameraManager.getCamera().position.clone(),this.initialCameraTarget=this.workCameraManager.getControls().target.clone(),this.initialCameraZoom=this.workCameraManager.getCamera().zoom||1,this.gizmo=null,this.inputHandler=null}async init(){console.log("üöÄ Initializing 3D Rotation Gizmo...");const e="/models/heart.glb";try{console.log(`üì¶ Attempting to load Blender model from: ${e}`),this.testObject=await this.modelLoader.loadModel(e,{decolorize:!0}),this.testObject.scale.set(.8,.8,.8),this.testObject.position.y=this.gizmoYOffset,this.workSceneManager.add(this.testObject),console.log("‚úÖ Touch screen model loaded (small, decolorized)"),this.previewObject=await this.modelLoader.loadModel(e),this.previewObject.scale.set(15,15,15),this.previewSceneManager.add(this.previewObject),this.enableMaterialClipping(),console.log("‚úÖ Main screen model loaded (large, colored)"),console.log("   Generating MPR cross-sections...")}catch(s){console.warn("‚ö†Ô∏è Could not load Blender model, using fallback cubes"),console.warn("   Make sure your .glb file is in: public/models/"),console.warn("   Error:",s.message),this.testObject=this.createDecolorizedCube(),this.testObject.position.y=this.gizmoYOffset,this.workSceneManager.add(this.testObject),this.previewObject=this.createTestObject(),this.previewObject.scale.set(15,15,15),this.previewSceneManager.add(this.previewObject),this.enableMaterialClipping()}this.workSphere=this.createTransparentSphere(),this.workSphere.visible=!1,this.workSphere.position.y=this.gizmoYOffset,this.workSceneManager.add(this.workSphere),this.workCube=this.createTransparentCube(),this.workCube.visible=!0,this.workCube.position.y=this.gizmoYOffset,this.workSceneManager.add(this.workCube),this.initialRotation=this.testObject.quaternion.clone(),this.gizmo=new Wr(this.testObject,{radius:2.5}),this.gizmo.applyStyle("cube");const t=this.gizmo.getMesh();this.workSceneManager.add(t),this.addGridHelper(),this.inputHandler=new eo(this.workCameraManager.getCamera(),this.renderer.domElement,this.gizmo,this),this.setupOrbitControlsIntegration(),this.setupResetButton(),this.setupStyleSwitcher(),this.setupInfoToggle(),this.setupDraggablePlane(),this.setupResizeHandler(),this.animate(),console.log("‚úì 3D Rotation Gizmo initialized"),console.log("‚úì Dual viewport mode active"),console.log("‚Üí Top: Main screen (your 3D model)"),console.log("‚Üí Bottom: Touch screen (controls)")}setupResizeHandler(){const e=()=>{this.workCameraManager.handleResize(),this.previewCameraManager&&this.previewCameraManager.handleResize&&this.previewCameraManager.handleResize(),this.transverseCameraManager&&this.transverseCameraManager.handleResize&&this.transverseCameraManager.handleResize(),this.coronalCameraManager&&this.coronalCameraManager.handleResize&&this.coronalCameraManager.handleResize(),this.sagittalCameraManager&&this.sagittalCameraManager.handleResize&&this.sagittalCameraManager.handleResize(),console.log("‚úì Cameras resized")};window.addEventListener("resize",e),console.log("‚úì Resize handler initialized")}createPreviewCamera(){const e=new ai(75,.8,.1,1e3);return e.position.set(4,4,4),e.lookAt(0,0,0),e.layers.enableAll(),{getCamera:()=>e,update:()=>{},handleResize:()=>{e.aspect=.8,e.updateProjectionMatrix()}}}async generateAllCrossSections(){if(!this.previewObject){console.warn("Preview object not ready for cross-section generation");return}console.log("üî™ Generating CSG cross-sections..."),this.transverseIndicatorGroup&&this.previewSceneManager.getScene().remove(this.transverseIndicatorGroup),this.coronalIndicatorGroup&&this.previewSceneManager.getScene().remove(this.coronalIndicatorGroup),this.sagittalIndicatorGroup&&this.previewSceneManager.getScene().remove(this.sagittalIndicatorGroup);const e=[];if(this.previewObject.traverse(r=>{r.isMesh&&e.push(r)}),e.length===0){console.warn("No meshes found in preview object");return}console.log(`Found ${e.length} meshes to slice`);const t=e[0],s=this.generateCrossSection(t,"y",0);s&&(s.layers.set(1),this.transverseIndicatorGroup=new De,this.transverseIndicatorGroup.add(s),this.transverseIndicatorGroup.layers.set(1),this.previewSceneManager.add(this.transverseIndicatorGroup),console.log("‚úì Transverse cross-section added"));const i=this.generateCrossSection(t,"z",0);i&&(i.layers.set(2),this.coronalIndicatorGroup=new De,this.coronalIndicatorGroup.add(i),this.coronalIndicatorGroup.layers.set(2),this.previewSceneManager.add(this.coronalIndicatorGroup),console.log("‚úì Coronal cross-section added"));const n=this.generateCrossSection(t,"x",0);n&&(n.layers.set(3),this.sagittalIndicatorGroup=new De,this.sagittalIndicatorGroup.add(n),this.sagittalIndicatorGroup.layers.set(3),this.previewSceneManager.add(this.sagittalIndicatorGroup),console.log("‚úì Sagittal cross-section added")),console.log("‚úÖ All cross-sections generated")}generateCrossSection(e,t,s=0){if(!e||!e.geometry)return console.warn("No valid mesh provided for cross-section"),null;try{const i=new Ml,n=1;let r;const l=50;t==="y"?r=new ne(l,n,l):t==="z"?r=new ne(l,l,n):t==="x"&&(r=new ne(n,l,l));const o=t==="y"?65280:t==="z"?255:16711680,c=new O({color:o,side:k,metalness:.1,roughness:.8}),u=new as(e.geometry);u.position.copy(e.position),u.rotation.copy(e.rotation),u.scale.copy(e.scale),u.updateMatrixWorld();const h=new as(r);t==="y"?h.position.y=s:t==="z"?h.position.z=s:t==="x"&&(h.position.x=s),h.updateMatrixWorld();const f=i.evaluate(u,h,kn);return f.material=c,console.log(`‚úì Generated ${t}-axis cross-section at position ${s}`),f}catch(i){return console.error(`‚ùå Error generating cross-section for ${t}-axis:`,i),null}}enableMaterialClipping(){this.previewObject&&(this.previewObject.traverse(e=>{e.isMesh&&e.material&&(Array.isArray(e.material)?e.material:[e.material]).forEach(s=>{s.side=k,s.needsUpdate=!0})}),console.log("‚úì Materials prepared for clipping"))}createSliceIndicators(){this.sliceThickness=4,this.transverseYPosition=this.gizmoYOffset,this.transverseClipPlanes=[new me(new v(0,-1,0),this.transverseYPosition+this.sliceThickness/2),new me(new v(0,1,0),-this.transverseYPosition+this.sliceThickness/2)],this.coronalClipPlanes=[new me(new v(0,0,-1),this.sliceThickness/2),new me(new v(0,0,1),this.sliceThickness/2)],this.sagittalClipPlanes=[new me(new v(-1,0,0),this.sliceThickness/2),new me(new v(1,0,0),this.sliceThickness/2)],this.createTransversePlaneIndicator(),console.log("‚úì Dual clipping planes created for thin slab visualization"),console.log(`  Slice thickness: ${this.sliceThickness} units`),console.log("  Draggable transverse plane indicator created")}createTransversePlaneIndicator(){const t=new Le(60,60),s=new H({color:65280,transparent:!0,opacity:0,side:k,depthTest:!0,depthWrite:!1});this.transversePlaneIndicator=new D(t,s),this.transversePlaneIndicator.rotation.x=Math.PI/2,this.transversePlaneIndicator.position.y=this.transverseYPosition,this.transversePlaneIndicator.userData={type:"draggable-plane",axis:"y"},this.previewSceneManager.add(this.transversePlaneIndicator),console.log("‚úì Transverse plane indicator created (main screen: invisible)")}updateTransverseClipping(e){this.transverseYPosition=e,this.transverseClipPlanes[0].constant=e+this.sliceThickness/2,this.transverseClipPlanes[1].constant=-e+this.sliceThickness/2,this.transversePlaneIndicator&&(this.transversePlaneIndicator.position.y=e);const t=e-this.gizmoYOffset;this.gizmo&&this.gizmo.squareFrames&&this.gizmo.squareFrames.y&&(this.gizmo.squareFrames.y.position.y=t),this.gizmo&&this.gizmo.axes&&this.gizmo.axes.y&&(this.gizmo.axes.y.mesh.position.y=t),this.gizmo&&this.gizmo.squareHighlightPlanes&&this.gizmo.squareHighlightPlanes.y&&(this.gizmo.squareHighlightPlanes.y.position.y=t),this.gizmo&&this.gizmo.highlightPlanes&&this.gizmo.highlightPlanes.y&&(this.gizmo.highlightPlanes.y.position.y=t),console.log(`üìç Transverse plane at Y = ${e.toFixed(2)} | Frame local Y = ${(e-this.gizmoYOffset).toFixed(2)}`)}setupShaderClipping(){if(!this.previewObject){console.warn("‚ö†Ô∏è Preview object not found for shader setup!");return}let e=0;this.previewObject.traverse(t=>{t.isMesh&&t.material&&(Array.isArray(t.material)?t.material:[t.material]).forEach(i=>{i.userData.shaderClippingSetup||(i.side=k,i.userData.clippingUniforms||(i.userData.clippingUniforms={clippingEnabled:{value:0},clippingPlaneNormal:{value:new v(0,1,0)},clippingPlaneConstant:{value:0}}),i.onBeforeCompile=n=>{n.uniforms.clippingEnabled=i.userData.clippingUniforms.clippingEnabled,n.uniforms.clippingPlaneNormal=i.userData.clippingUniforms.clippingPlaneNormal,n.uniforms.clippingPlaneConstant=i.userData.clippingUniforms.clippingPlaneConstant,n.vertexShader=`
              varying vec3 vWorldPosition;
              ${n.vertexShader}
            `,n.vertexShader=n.vertexShader.replace("#include <project_vertex>",`#include <project_vertex>
              vWorldPosition = (modelMatrix * vec4(position, 1.0)).xyz;`),n.fragmentShader=`
              uniform int clippingEnabled;
              uniform vec3 clippingPlaneNormal;
              uniform float clippingPlaneConstant;
              varying vec3 vWorldPosition;
              ${n.fragmentShader}
            `,n.fragmentShader=n.fragmentShader.replace("void main() {",`void main() {
                // Custom shader-based clipping
                if (clippingEnabled == 1) {
                  float distance = dot(vWorldPosition, clippingPlaneNormal) + clippingPlaneConstant;
                  if (distance < 0.0) {
                    discard;
                  }
                }
              `),i.userData.shader=n},i.userData.shaderClippingSetup=!0,i.needsUpdate=!0,e++)})}),console.log(`üé® Shader-based clipping setup on ${e} materials`)}applyClippingToMaterials(e){if(!this.previewObject)return;const t=e.length>0,s=t?e[0]:null;this.previewObject.traverse(i=>{i.isMesh&&i.material&&(Array.isArray(i.material)?i.material:[i.material]).forEach(r=>{r.userData.clippingUniforms&&(r.userData.clippingUniforms.clippingEnabled.value=t?1:0,t&&s&&(r.userData.clippingUniforms.clippingPlaneNormal.value.copy(s.normal),r.userData.clippingUniforms.clippingPlaneConstant.value=s.constant))})})}createTransverseCamera(){const s=new Ee(-72,72,30,-30,.1,1e3);return s.position.set(0,50,0),s.lookAt(0,0,0),s.up.set(0,0,-1),s.layers.enableAll(),{getCamera:()=>s,update:()=>{},handleResize:()=>{s.left=60*2.4/-2,s.right=60*2.4/2,s.top=60/2,s.bottom=60/-2,s.updateProjectionMatrix()}}}createCoronalCamera(){const s=new Ee(-72,72,30,-30,.1,1e3);return s.position.set(0,0,50),s.lookAt(0,0,0),s.up.set(0,1,0),s.layers.enableAll(),{getCamera:()=>s,update:()=>{},handleResize:()=>{s.left=60*2.4/-2,s.right=60*2.4/2,s.top=60/2,s.bottom=60/-2,s.updateProjectionMatrix()}}}createSagittalCamera(){const s=new Ee(-72,72,30,-30,.1,1e3);return s.position.set(50,0,0),s.lookAt(0,0,0),s.up.set(0,1,0),s.layers.enableAll(),{getCamera:()=>s,update:()=>{},handleResize:()=>{s.left=60*2.4/-2,s.right=60*2.4/2,s.top=60/2,s.bottom=60/-2,s.updateProjectionMatrix()}}}createTestObject(){const e=new ne(2,2,2),t=[new O({color:16711680}),new O({color:16737894}),new O({color:65280}),new O({color:6750054}),new O({color:255}),new O({color:6711039})],s=new D(e,t);return s.position.set(0,0,0),s.castShadow=!0,s.receiveShadow=!0,s}createDecolorizedCube(){const e=new ne(1.2,1.2,1.2),t=[new O({color:15658734}),new O({color:14540253}),new O({color:16777215}),new O({color:13421772}),new O({color:15658734}),new O({color:14540253})],s=new D(e,t);return s.position.set(0,0,0),s.castShadow=!0,s.receiveShadow=!0,s}createTransparentSphere(){const e=new vt(2.5,64,64),t=new H({color:8947848,transparent:!0,opacity:.15,side:k,depthWrite:!1}),s=new D(e,t);return s.position.set(0,0,0),s}async createTransverseSummaryGizmo(){this.summarySceneManager=new ut;const e=8,t=1;this.summaryCamera=new Ee(e*t/-2,e*t/2,e/2,e/-2,.1,1e3),this.summaryCamera.position.set(5,5+this.gizmoYOffset,5),this.summaryCamera.lookAt(0,this.gizmoYOffset,0),this.summaryFrustumSize=e;const s=new Zt(16777215,.6);this.summarySceneManager.add(s);const i=new at(16777215,.4);i.position.set(5,10,5),this.summarySceneManager.add(i);try{const o=await this.modelLoader.loadModel("/models/heart.glb");this.summaryCube=o.clone(),this.summaryCube.scale.set(.9,.9,.9),this.summaryCube.position.y=this.gizmoYOffset,this.summaryCube.traverse(c=>{c.isMesh&&(c.material.depthWrite=!0,c.material.depthTest=!0)}),this.summarySceneManager.add(this.summaryCube),console.log("‚úÖ Heart model loaded for transverse summary")}catch(o){console.warn("‚ö† Failed to load heart for summary, using cube fallback:",o);const c=new ne(1.2,1.2,1.2),u=[new O({color:15658734}),new O({color:14540253}),new O({color:16777215}),new O({color:13421772}),new O({color:15658734}),new O({color:14540253})];this.summaryCube=new D(c,u),this.summaryCube.position.y=this.gizmoYOffset,this.summarySceneManager.add(this.summaryCube)}this.summarySphere=new D(new vt(2.5,64,64),new H({color:8947848,transparent:!0,opacity:.15,side:k,depthWrite:!1})),this.summarySphere.position.y=this.gizmoYOffset,this.summarySphere.visible=!1,this.summarySceneManager.add(this.summarySphere),this.summaryTransparentCube=new D(new ne(3.6,3.6,3.6),new H({color:8947848,transparent:!0,opacity:.15,side:k,depthWrite:!1})),this.summaryTransparentCube.position.y=this.gizmoYOffset,this.summaryTransparentCube.visible=!0,this.summarySceneManager.add(this.summaryTransparentCube),this.createSummaryPlaneOutlines();const n=new H({color:65280,transparent:!0,opacity:.15,side:k,depthTest:!1}),r=new Le(3,3);this.summaryPlaneHighlight=new D(r,n),this.summaryPlaneHighlight.rotation.x=Math.PI/2,this.summaryPlaneHighlight.position.y=this.gizmoYOffset,this.summaryPlaneHighlight.visible=!1,this.summarySceneManager.add(this.summaryPlaneHighlight);const l=new Qt(1.5,64);this.summaryPlaneHighlightCircular=new D(l,n.clone()),this.summaryPlaneHighlightCircular.rotation.x=Math.PI/2,this.summaryPlaneHighlightCircular.position.y=this.gizmoYOffset,this.summaryPlaneHighlightCircular.visible=!1,this.summarySceneManager.add(this.summaryPlaneHighlightCircular),console.log("‚úì Transverse summary gizmo created")}async createCoronalSummaryGizmo(){this.coronalSummarySceneManager=new ut;const e=8,t=1;this.coronalSummaryCamera=new Ee(e*t/-2,e*t/2,e/2,e/-2,.1,1e3),this.coronalSummaryCamera.position.set(5,5+this.gizmoYOffset,5),this.coronalSummaryCamera.lookAt(0,this.gizmoYOffset,0);const s=new Zt(16777215,.6);this.coronalSummarySceneManager.add(s);const i=new at(16777215,.4);i.position.set(5,10,5),this.coronalSummarySceneManager.add(i);try{const o=await this.modelLoader.loadModel("/models/heart.glb");this.coronalSummaryCube=o.clone(),this.coronalSummaryCube.scale.set(.9,.9,.9),this.coronalSummaryCube.position.y=this.gizmoYOffset,this.coronalSummaryCube.traverse(c=>{c.isMesh&&(c.material.depthWrite=!0,c.material.depthTest=!0)}),this.coronalSummarySceneManager.add(this.coronalSummaryCube),console.log("‚úÖ Heart model loaded for coronal summary")}catch(o){console.warn("‚ö† Failed to load heart for coronal summary, using cube fallback:",o);const c=new ne(1.2,1.2,1.2),u=[new O({color:15658734}),new O({color:14540253}),new O({color:16777215}),new O({color:13421772}),new O({color:15658734}),new O({color:14540253})];this.coronalSummaryCube=new D(c,u),this.coronalSummaryCube.position.y=this.gizmoYOffset,this.coronalSummarySceneManager.add(this.coronalSummaryCube)}this.coronalSummarySphere=new D(new vt(2.5,64,64),new H({color:8947848,transparent:!0,opacity:.15,side:k,depthWrite:!1})),this.coronalSummarySphere.position.y=this.gizmoYOffset,this.coronalSummarySphere.visible=!1,this.coronalSummarySceneManager.add(this.coronalSummarySphere),this.coronalSummaryTransparentCube=new D(new ne(3.6,3.6,3.6),new H({color:8947848,transparent:!0,opacity:.15,side:k,depthWrite:!1})),this.coronalSummaryTransparentCube.position.y=this.gizmoYOffset,this.coronalSummaryTransparentCube.visible=!0,this.coronalSummarySceneManager.add(this.coronalSummaryTransparentCube),this.createCoronalSummaryPlaneOutlines();const n=new H({color:16711680,transparent:!0,opacity:.15,side:k,depthTest:!1}),r=new Le(3,3);this.coronalPlaneHighlight=new D(r,n),this.coronalPlaneHighlight.rotation.y=Math.PI/2,this.coronalPlaneHighlight.position.y=this.gizmoYOffset,this.coronalPlaneHighlight.visible=!1,this.coronalSummarySceneManager.add(this.coronalPlaneHighlight);const l=new Qt(1.5,64);this.coronalPlaneHighlightCircular=new D(l,n.clone()),this.coronalPlaneHighlightCircular.rotation.y=Math.PI/2,this.coronalPlaneHighlightCircular.position.y=this.gizmoYOffset,this.coronalPlaneHighlightCircular.visible=!1,this.coronalSummarySceneManager.add(this.coronalPlaneHighlightCircular),console.log("‚úì Coronal summary gizmo created")}async createSagittalSummaryGizmo(){this.sagittalSummarySceneManager=new ut;const e=8,t=1;this.sagittalSummaryCamera=new Ee(e*t/-2,e*t/2,e/2,e/-2,.1,1e3),this.sagittalSummaryCamera.position.set(5,5+this.gizmoYOffset,5),this.sagittalSummaryCamera.lookAt(0,this.gizmoYOffset,0);const s=new Zt(16777215,.6);this.sagittalSummarySceneManager.add(s);const i=new at(16777215,.4);i.position.set(5,10,5),this.sagittalSummarySceneManager.add(i);try{const o=await this.modelLoader.loadModel("/models/heart.glb");this.sagittalSummaryCube=o.clone(),this.sagittalSummaryCube.scale.set(.9,.9,.9),this.sagittalSummaryCube.position.y=this.gizmoYOffset,this.sagittalSummaryCube.traverse(c=>{c.isMesh&&(c.material.depthWrite=!0,c.material.depthTest=!0)}),this.sagittalSummarySceneManager.add(this.sagittalSummaryCube),console.log("‚úÖ Heart model loaded for sagittal summary")}catch(o){console.warn("‚ö† Failed to load heart for sagittal summary, using cube fallback:",o);const c=new ne(1.2,1.2,1.2),u=[new O({color:15658734}),new O({color:14540253}),new O({color:16777215}),new O({color:13421772}),new O({color:15658734}),new O({color:14540253})];this.sagittalSummaryCube=new D(c,u),this.sagittalSummaryCube.position.y=this.gizmoYOffset,this.sagittalSummarySceneManager.add(this.sagittalSummaryCube)}this.sagittalSummarySphere=new D(new vt(2.5,64,64),new H({color:8947848,transparent:!0,opacity:.15,side:k,depthWrite:!1})),this.sagittalSummarySphere.position.y=this.gizmoYOffset,this.sagittalSummarySphere.visible=!1,this.sagittalSummarySceneManager.add(this.sagittalSummarySphere),this.sagittalSummaryTransparentCube=new D(new ne(3.6,3.6,3.6),new H({color:8947848,transparent:!0,opacity:.15,side:k,depthWrite:!1})),this.sagittalSummaryTransparentCube.position.y=this.gizmoYOffset,this.sagittalSummaryTransparentCube.visible=!0,this.sagittalSummarySceneManager.add(this.sagittalSummaryTransparentCube),this.createSagittalSummaryPlaneOutlines();const n=new H({color:255,transparent:!0,opacity:.15,side:k,depthTest:!1}),r=new Le(3,3);this.sagittalPlaneHighlight=new D(r,n),this.sagittalPlaneHighlight.position.y=this.gizmoYOffset,this.sagittalPlaneHighlight.visible=!1,this.sagittalSummarySceneManager.add(this.sagittalPlaneHighlight);const l=new Qt(1.5,64);this.sagittalPlaneHighlightCircular=new D(l,n.clone()),this.sagittalPlaneHighlightCircular.position.y=this.gizmoYOffset,this.sagittalPlaneHighlightCircular.visible=!1,this.sagittalSummarySceneManager.add(this.sagittalPlaneHighlightCircular),console.log("‚úì Sagittal summary gizmo created")}createSummaryPlaneOutlines(){this.summaryCircularPlanes={xy:this.createCircularPlaneOutline(2.5,255,!1),yz:this.createCircularPlaneOutline(2.5,16711680,!1),zx:this.createCircularPlaneOutline(2.5,65280,!0)},this.summaryCircularPlanes.xy.position.y=this.gizmoYOffset,this.summaryCircularPlanes.yz.rotation.y=Math.PI/2,this.summaryCircularPlanes.yz.position.y=this.gizmoYOffset,this.summaryCircularPlanes.zx.rotation.x=Math.PI/2,this.summaryCircularPlanes.zx.position.y=this.gizmoYOffset,this.summaryCircularPlanes.xy.visible=!1,this.summaryCircularPlanes.yz.visible=!1,this.summaryCircularPlanes.zx.visible=!1,this.summarySceneManager.add(this.summaryCircularPlanes.xy),this.summarySceneManager.add(this.summaryCircularPlanes.yz),this.summarySceneManager.add(this.summaryCircularPlanes.zx),this.summarySquarePlanes={xy:this.createSquarePlaneOutline(3.6,255,!1),yz:this.createSquarePlaneOutline(3.6,16711680,!1),zx:this.createSquarePlaneOutline(3.6,65280,!0)},this.summarySquarePlanes.xy.position.y=this.gizmoYOffset,this.summarySquarePlanes.yz.rotation.y=Math.PI/2,this.summarySquarePlanes.yz.position.y=this.gizmoYOffset,this.summarySquarePlanes.zx.rotation.x=Math.PI/2,this.summarySquarePlanes.zx.position.y=this.gizmoYOffset,this.summarySquarePlanes.xy.visible=!0,this.summarySquarePlanes.yz.visible=!0,this.summarySquarePlanes.zx.visible=!0,this.summarySceneManager.add(this.summarySquarePlanes.xy),this.summarySceneManager.add(this.summarySquarePlanes.yz),this.summarySceneManager.add(this.summarySquarePlanes.zx)}createCoronalSummaryPlaneOutlines(){this.coronalSummaryCircularPlanes={xy:this.createCircularPlaneOutline(2.5,255,!1),yz:this.createCircularPlaneOutline(2.5,16711680,!0),zx:this.createCircularPlaneOutline(2.5,65280,!1)},this.coronalSummaryCircularPlanes.xy.position.y=this.gizmoYOffset,this.coronalSummaryCircularPlanes.yz.rotation.y=Math.PI/2,this.coronalSummaryCircularPlanes.yz.position.y=this.gizmoYOffset,this.coronalSummaryCircularPlanes.zx.rotation.x=Math.PI/2,this.coronalSummaryCircularPlanes.zx.position.y=this.gizmoYOffset,this.coronalSummaryCircularPlanes.xy.visible=!1,this.coronalSummaryCircularPlanes.yz.visible=!1,this.coronalSummaryCircularPlanes.zx.visible=!1,this.coronalSummarySceneManager.add(this.coronalSummaryCircularPlanes.xy),this.coronalSummarySceneManager.add(this.coronalSummaryCircularPlanes.yz),this.coronalSummarySceneManager.add(this.coronalSummaryCircularPlanes.zx),this.coronalSummarySquarePlanes={xy:this.createSquarePlaneOutline(3.6,255,!1),yz:this.createSquarePlaneOutline(3.6,16711680,!0),zx:this.createSquarePlaneOutline(3.6,65280,!1)},this.coronalSummarySquarePlanes.xy.position.y=this.gizmoYOffset,this.coronalSummarySquarePlanes.yz.rotation.y=Math.PI/2,this.coronalSummarySquarePlanes.yz.position.y=this.gizmoYOffset,this.coronalSummarySquarePlanes.zx.rotation.x=Math.PI/2,this.coronalSummarySquarePlanes.zx.position.y=this.gizmoYOffset,this.coronalSummarySquarePlanes.xy.visible=!0,this.coronalSummarySquarePlanes.yz.visible=!0,this.coronalSummarySquarePlanes.zx.visible=!0,this.coronalSummarySceneManager.add(this.coronalSummarySquarePlanes.xy),this.coronalSummarySceneManager.add(this.coronalSummarySquarePlanes.yz),this.coronalSummarySceneManager.add(this.coronalSummarySquarePlanes.zx)}createSagittalSummaryPlaneOutlines(){this.sagittalSummaryCircularPlanes={xy:this.createCircularPlaneOutline(2.5,255,!0),yz:this.createCircularPlaneOutline(2.5,16711680,!1),zx:this.createCircularPlaneOutline(2.5,65280,!1)},this.sagittalSummaryCircularPlanes.xy.position.y=this.gizmoYOffset,this.sagittalSummaryCircularPlanes.yz.rotation.y=Math.PI/2,this.sagittalSummaryCircularPlanes.yz.position.y=this.gizmoYOffset,this.sagittalSummaryCircularPlanes.zx.rotation.x=Math.PI/2,this.sagittalSummaryCircularPlanes.zx.position.y=this.gizmoYOffset,this.sagittalSummaryCircularPlanes.xy.visible=!1,this.sagittalSummaryCircularPlanes.yz.visible=!1,this.sagittalSummaryCircularPlanes.zx.visible=!1,this.sagittalSummarySceneManager.add(this.sagittalSummaryCircularPlanes.xy),this.sagittalSummarySceneManager.add(this.sagittalSummaryCircularPlanes.yz),this.sagittalSummarySceneManager.add(this.sagittalSummaryCircularPlanes.zx),this.sagittalSummarySquarePlanes={xy:this.createSquarePlaneOutline(3.6,255,!0),yz:this.createSquarePlaneOutline(3.6,16711680,!1),zx:this.createSquarePlaneOutline(3.6,65280,!1)},this.sagittalSummarySquarePlanes.xy.position.y=this.gizmoYOffset,this.sagittalSummarySquarePlanes.yz.rotation.y=Math.PI/2,this.sagittalSummarySquarePlanes.yz.position.y=this.gizmoYOffset,this.sagittalSummarySquarePlanes.zx.rotation.x=Math.PI/2,this.sagittalSummarySquarePlanes.zx.position.y=this.gizmoYOffset,this.sagittalSummarySquarePlanes.xy.visible=!0,this.sagittalSummarySquarePlanes.yz.visible=!0,this.sagittalSummarySquarePlanes.zx.visible=!0,this.sagittalSummarySceneManager.add(this.sagittalSummarySquarePlanes.xy),this.sagittalSummarySceneManager.add(this.sagittalSummarySquarePlanes.yz),this.sagittalSummarySceneManager.add(this.sagittalSummarySquarePlanes.zx)}createCircularPlaneOutline(e,t,s){const n=new At,r=[];for(let c=0;c<=64;c++){const u=c/64*Math.PI*2;r.push(Math.cos(u)*e,Math.sin(u)*e,0)}n.setAttribute("position",new _i(r,3));const l=new ns({color:s?t:3355443,linewidth:s?3:1,opacity:s?1:.2,transparent:!0,dashSize:.2,gapSize:.1}),o=new _t(n,l);return o.computeLineDistances(),o}createSquarePlaneOutline(e,t,s){const i=e/2,n=new At,r=[-i,-i,0,i,-i,0,i,i,0,-i,i,0,-i,-i,0];n.setAttribute("position",new _i(r,3));const l=new ns({color:s?t:3355443,linewidth:s?3:1,opacity:s?1:.2,transparent:!0,dashSize:.2,gapSize:.1}),o=new _t(n,l);return o.computeLineDistances(),o}createTransparentCube(){const t=new ne(3.6,3.6,3.6),s=new H({color:8947848,transparent:!0,opacity:.15,side:k,depthWrite:!1});return new D(t,s)}setupOrbitControlsIntegration(){const e=this.workCameraManager.getControls();this.inputHandler.onGizmoInteractionStart=()=>{e.enabled=!1},this.inputHandler.onGizmoInteractionEnd=()=>{e.enabled=!0}}setupStyleSwitcher(){const e=document.querySelectorAll(".style-button");e.forEach(t=>{t.addEventListener("click",()=>{e.forEach(i=>i.classList.remove("active")),t.classList.add("active");const s=t.getAttribute("data-style");this.gizmo.applyStyle(s),this.workSphere&&(s==="circular"?(this.workSphere.visible=!0,this.workCube.visible=!1,console.log("‚úì Sphere visible, cube hidden")):s==="linear"?(this.workSphere.visible=!1,this.workCube.visible=!1,console.log("‚úì Sphere hidden, cube hidden")):s==="cube"&&(this.workSphere.visible=!1,this.workCube.visible=!0,console.log("‚úì Sphere hidden, cube visible"))),this.summaryTransparentCube&&this.summarySphere&&(s==="cube"?(this.summaryTransparentCube.visible=!0,this.summarySphere.visible=!1,this.summarySquarePlanes&&(this.summarySquarePlanes.xy.visible=!0,this.summarySquarePlanes.yz.visible=!0,this.summarySquarePlanes.zx.visible=!0),this.summaryCircularPlanes&&(this.summaryCircularPlanes.xy.visible=!1,this.summaryCircularPlanes.yz.visible=!1,this.summaryCircularPlanes.zx.visible=!1),this.summaryPlaneHighlight&&(this.summaryPlaneHighlight.visible=!0),this.summaryPlaneHighlightCircular&&(this.summaryPlaneHighlightCircular.visible=!1)):s==="circular"&&(this.summaryTransparentCube.visible=!1,this.summarySphere.visible=!0,this.summarySquarePlanes&&(this.summarySquarePlanes.xy.visible=!1,this.summarySquarePlanes.yz.visible=!1,this.summarySquarePlanes.zx.visible=!1),this.summaryCircularPlanes&&(this.summaryCircularPlanes.xy.visible=!0,this.summaryCircularPlanes.yz.visible=!0,this.summaryCircularPlanes.zx.visible=!0),this.summaryPlaneHighlight&&(this.summaryPlaneHighlight.visible=!1),this.summaryPlaneHighlightCircular&&(this.summaryPlaneHighlightCircular.visible=!0))),this.coronalSummaryTransparentCube&&this.coronalSummarySphere&&(s==="cube"?(this.coronalSummaryTransparentCube.visible=!0,this.coronalSummarySphere.visible=!1,this.coronalSummarySquarePlanes&&(this.coronalSummarySquarePlanes.xy.visible=!0,this.coronalSummarySquarePlanes.yz.visible=!0,this.coronalSummarySquarePlanes.zx.visible=!0),this.coronalSummaryCircularPlanes&&(this.coronalSummaryCircularPlanes.xy.visible=!1,this.coronalSummaryCircularPlanes.yz.visible=!1,this.coronalSummaryCircularPlanes.zx.visible=!1),this.coronalPlaneHighlight&&(this.coronalPlaneHighlight.visible=!0),this.coronalPlaneHighlightCircular&&(this.coronalPlaneHighlightCircular.visible=!1)):s==="circular"&&(this.coronalSummaryTransparentCube.visible=!1,this.coronalSummarySphere.visible=!0,this.coronalSummarySquarePlanes&&(this.coronalSummarySquarePlanes.xy.visible=!1,this.coronalSummarySquarePlanes.yz.visible=!1,this.coronalSummarySquarePlanes.zx.visible=!1),this.coronalSummaryCircularPlanes&&(this.coronalSummaryCircularPlanes.xy.visible=!0,this.coronalSummaryCircularPlanes.yz.visible=!0,this.coronalSummaryCircularPlanes.zx.visible=!0),this.coronalPlaneHighlight&&(this.coronalPlaneHighlight.visible=!1),this.coronalPlaneHighlightCircular&&(this.coronalPlaneHighlightCircular.visible=!0))),this.sagittalSummaryTransparentCube&&this.sagittalSummarySphere&&(s==="cube"?(this.sagittalSummaryTransparentCube.visible=!0,this.sagittalSummarySphere.visible=!1,this.sagittalSummarySquarePlanes&&(this.sagittalSummarySquarePlanes.xy.visible=!0,this.sagittalSummarySquarePlanes.yz.visible=!0,this.sagittalSummarySquarePlanes.zx.visible=!0),this.sagittalSummaryCircularPlanes&&(this.sagittalSummaryCircularPlanes.xy.visible=!1,this.sagittalSummaryCircularPlanes.yz.visible=!1,this.sagittalSummaryCircularPlanes.zx.visible=!1),this.sagittalPlaneHighlight&&(this.sagittalPlaneHighlight.visible=!0),this.sagittalPlaneHighlightCircular&&(this.sagittalPlaneHighlightCircular.visible=!1)):s==="circular"&&(this.sagittalSummaryTransparentCube.visible=!1,this.sagittalSummarySphere.visible=!0,this.sagittalSummarySquarePlanes&&(this.sagittalSummarySquarePlanes.xy.visible=!1,this.sagittalSummarySquarePlanes.yz.visible=!1,this.sagittalSummarySquarePlanes.zx.visible=!1),this.sagittalSummaryCircularPlanes&&(this.sagittalSummaryCircularPlanes.xy.visible=!0,this.sagittalSummaryCircularPlanes.yz.visible=!0,this.sagittalSummaryCircularPlanes.zx.visible=!0),this.sagittalPlaneHighlight&&(this.sagittalPlaneHighlight.visible=!1),this.sagittalPlaneHighlightCircular&&(this.sagittalPlaneHighlightCircular.visible=!0))),console.log(`‚úì Style switched to: ${s}`)})}),console.log("‚úì Style switcher initialized")}setupResetButton(){const e=document.getElementById("reset-button");e&&e.addEventListener("click",()=>{this.resetRotation()}),console.log("‚úì Reset button initialized")}makeDraggable(e){const t=e.querySelector(".info-header");if(!t){console.warn("‚ö† Info header not found for draggable element");return}let s=!1,i=0,n=0,r=0,l=0,o=0,c=0;t.style.cursor="move",t.style.userSelect="none",e.style.transform="translate(0px, 0px)";const u=d=>{d.target.classList.contains("chevron")||(r=d.clientX-o,l=d.clientY-c,(d.target===t||d.target.tagName==="H1"||t.contains(d.target))&&(s=!0))},h=d=>{s&&(d.preventDefault(),i=d.clientX-r,n=d.clientY-l,o=i,c=n,e.style.transform=`translate(${i}px, ${n}px)`)},f=d=>{r=i,l=n,s=!1};t.addEventListener("mousedown",u),document.addEventListener("mousemove",h),document.addEventListener("mouseup",f),console.log(`‚úì Panel draggable at default position: ${e.id}`)}setupInfoToggle(){["main-screen-info","touch-screen-info"].forEach(t=>{const s=document.getElementById(t);if(!s){console.warn(`‚ö† ${t} panel not found`);return}this.makeDraggable(s);const i=s.querySelector(".info-header"),n=s.querySelector(".info-content"),r=s.querySelector(".chevron");if(!i||!n||!r){console.warn(`‚ö† ${t} elements not found`);return}r.addEventListener("click",l=>{l.stopPropagation(),n.classList.contains("collapsed")?(n.classList.remove("collapsed"),r.classList.remove("collapsed"),r.textContent="‚ñ≤"):(n.classList.add("collapsed"),r.classList.add("collapsed"),r.textContent="‚ñº")})}),console.log("‚úì Info panel toggles initialized")}setupDraggablePlane(){this.isControllingSlice=!1,this.sliceDragStartY=0,this.sliceStartPosition=0,console.log("‚úì Transverse slice control ready (drag Y-axis to control)")}resetRotation(){console.log("üîÑ Resetting rotation, camera, and slice planes to initial state"),this.gizmo.applyStyle("cube"),document.querySelectorAll(".style-button").forEach(f=>{f.getAttribute("data-style")==="cube"?f.classList.add("active"):f.classList.remove("active")}),this.workSphere&&(this.workSphere.visible=!1,this.workCube.visible=!0),this.previewSphere&&this.previewCube&&(this.previewSphere.visible=!1,this.previewCube.visible=!0),this.summaryTransparentCube&&this.summarySphere&&(this.summaryTransparentCube.visible=!0,this.summarySphere.visible=!1,this.summarySquarePlanes&&(this.summarySquarePlanes.xy.visible=!0,this.summarySquarePlanes.yz.visible=!0,this.summarySquarePlanes.zx.visible=!0),this.summaryCircularPlanes&&(this.summaryCircularPlanes.xy.visible=!1,this.summaryCircularPlanes.yz.visible=!1,this.summaryCircularPlanes.zx.visible=!1),this.summaryPlaneHighlight&&(this.summaryPlaneHighlight.visible=!0),this.summaryPlaneHighlightCircular&&(this.summaryPlaneHighlightCircular.visible=!1)),this.coronalSummaryTransparentCube&&this.coronalSummarySphere&&(this.coronalSummaryTransparentCube.visible=!0,this.coronalSummarySphere.visible=!1,this.coronalSummarySquarePlanes&&(this.coronalSummarySquarePlanes.xy.visible=!0,this.coronalSummarySquarePlanes.yz.visible=!0,this.coronalSummarySquarePlanes.zx.visible=!0),this.coronalSummaryCircularPlanes&&(this.coronalSummaryCircularPlanes.xy.visible=!1,this.coronalSummaryCircularPlanes.yz.visible=!1,this.coronalSummaryCircularPlanes.zx.visible=!1),this.coronalPlaneHighlight&&(this.coronalPlaneHighlight.visible=!0),this.coronalPlaneHighlightCircular&&(this.coronalPlaneHighlightCircular.visible=!1)),this.sagittalSummaryTransparentCube&&this.sagittalSummarySphere&&(this.sagittalSummaryTransparentCube.visible=!0,this.sagittalSummarySphere.visible=!1,this.sagittalSummarySquarePlanes&&(this.sagittalSummarySquarePlanes.xy.visible=!0,this.sagittalSummarySquarePlanes.yz.visible=!0,this.sagittalSummarySquarePlanes.zx.visible=!0),this.sagittalSummaryCircularPlanes&&(this.sagittalSummaryCircularPlanes.xy.visible=!1,this.sagittalSummaryCircularPlanes.yz.visible=!1,this.sagittalSummaryCircularPlanes.zx.visible=!1),this.sagittalPlaneHighlight&&(this.sagittalPlaneHighlight.visible=!0),this.sagittalPlaneHighlightCircular&&(this.sagittalPlaneHighlightCircular.visible=!1));const t=this.workCameraManager.getControls();t.enabled=!1;const s=800,i=Date.now(),n=this.workCameraManager.getCamera(),r=this.testObject.quaternion.clone(),l=n.position.clone(),o=t.target.clone(),c=n.zoom||1,u=this.transverseYPosition||0,h=()=>{const f=Date.now()-i,d=Math.min(f/s,1),x=.5-Math.cos(d*Math.PI)/2;this.testObject.quaternion.slerpQuaternions(r,this.initialRotation,x),this.workCameraManager.getCamera().position.lerpVectors(l,this.initialCameraPosition,x),t.target.lerpVectors(o,this.initialCameraTarget,x),n.isOrthographicCamera&&(n.zoom=c+(this.initialCameraZoom-c)*x,n.updateProjectionMatrix());const w=this.gizmoYOffset,S=u+(w-u)*x;this.updateTransverseClipping(S),t.update(),d<1?requestAnimationFrame(h):(t.enabled=!0,console.log("‚úÖ Reset complete - rotation, camera (position, target, zoom), style (cube), and slice planes restored"))};h()}addGridHelper(){}animate(){requestAnimationFrame(()=>this.animate()),this.workCameraManager.update();const e=this.workCameraManager.getCamera(),t=this.previewCameraManager.getCamera(),i=this.workCameraManager.getControls().target.clone(),n=new v().subVectors(e.position,i),l=n.length()*8;n.normalize().multiplyScalar(l),t.position.copy(i).add(n);const o=i.clone();if(o.y+=2,t.lookAt(o),t.zoom=e.zoom,t.updateProjectionMatrix(),this.previewObject.quaternion.copy(this.testObject.quaternion),this.workSphere&&this.workSphere.quaternion.copy(this.testObject.quaternion),this.gizmo.update(),this.summaryCube&&this.summaryCube.quaternion.copy(this.testObject.quaternion),this.coronalSummaryCube&&this.coronalSummaryCube.quaternion.copy(this.testObject.quaternion),this.sagittalSummaryCube&&this.sagittalSummaryCube.quaternion.copy(this.testObject.quaternion),this.summarySquarePlanes&&this.summarySquarePlanes.zx){const c=this.transverseYPosition-this.gizmoYOffset;this.summarySquarePlanes.zx.position.y=this.gizmoYOffset+c}if(this.summaryCircularPlanes&&this.summaryCircularPlanes.zx){const c=this.transverseYPosition-this.gizmoYOffset;this.summaryCircularPlanes.zx.position.y=this.gizmoYOffset+c}if(this.summaryPlaneHighlight){const c=this.transverseYPosition-this.gizmoYOffset;this.summaryPlaneHighlight.position.y=this.gizmoYOffset+c}if(this.summaryPlaneHighlightCircular){const c=this.transverseYPosition-this.gizmoYOffset;this.summaryPlaneHighlightCircular.position.y=this.gizmoYOffset+c}this.coronalPlaneHighlight,this.coronalPlaneHighlightCircular,this.sagittalPlaneHighlight,this.sagittalPlaneHighlightCircular,this.renderer.render(this.previewSceneManager.getScene(),this.previewCameraManager.getCamera(),this.transverseCameraManager.getCamera(),this.coronalCameraManager.getCamera(),this.sagittalCameraManager.getCamera(),this.transverseClipPlanes,this.coronalClipPlanes,this.sagittalClipPlanes,this.workSceneManager.getScene(),this.workCameraManager.getCamera(),this.summarySceneManager.getScene(),this.summaryCamera,this.coronalSummarySceneManager.getScene(),this.coronalSummaryCamera,this.sagittalSummarySceneManager.getScene(),this.sagittalSummaryCamera)}}document.readyState==="loading"?document.addEventListener("DOMContentLoaded",async()=>{await new Sn().init()}):new Sn().init();
//# sourceMappingURL=index-BRpkBD8C.js.map
